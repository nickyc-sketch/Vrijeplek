<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Aanmelden — Vrijeplek</title>
  <meta name="description" content="Maak gratis een account aan op Vrijeplek. Activeer later je plan en vul je agenda zonder commissie.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css?v=ocean7">

  <style>
    :root{
      --o1:#1a66ff;
      --o2:#0056ff;

      --muted:#93a4c6;
      --line:rgba(255,255,255,.16);
      --glass:rgba(15,23,42,.84);

      --danger:#ff3b3b;
      --ok:#22c55e;

      --field-bg:rgba(15,23,42,.82);
      --field-bg-focus:rgba(15,23,42,.92);
      --field-border:rgba(148,163,184,.60);
      --field-border-focus:rgba(59,130,246,.95);
    }

    /* belangrijk voor dropdowns in dark UI */
    :root{ color-scheme: dark; }

    html,body{height:100%}
    body{
      margin:0;
      font-family:"Poppins",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:#e5e7eb;
      background:
        radial-gradient(120% 140% at 0% 0%, #003b84 0, transparent 60%),
        radial-gradient(120% 140% at 100% 0%, #00a0ff 0, transparent 55%),
        radial-gradient(160% 160% at 50% 120%, #021428 0, #020617 55%);
      background-attachment:fixed;
    }

    .site{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ---------- HEADER ---------- */
    .site-header{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:blur(22px);
      background:linear-gradient(180deg,rgba(2,6,23,.92),rgba(2,6,23,.70),rgba(2,6,23,0));
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .header-inner{
      max-width:1120px;
      margin:0 auto;
      padding:.9rem 1.2rem .8rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1rem;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:.65rem;
      text-decoration:none;
    }
    .brand-mark{
      width:34px;height:34px;
      border-radius:999px;
      background:
        radial-gradient(circle at 30% 20%, #fff 0, #b3e0ff 18%, transparent 40%),
        radial-gradient(circle at 80% 80%, #0f5bff 0, #001d5c 55%);
      box-shadow:0 0 0 1px rgba(255,255,255,.12),0 10px 30px rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
      font-weight:900;
      color:#fff;
    }
    .brand-wordmark{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .brand-wordmark span:first-child{
      font-weight:900;
      letter-spacing:.02em;
      font-size:1.05rem;
      color:#f9fafb;
      text-transform:lowercase;
    }
    .brand-wordmark span:last-child{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:rgba(226,232,240,.72);
    }

    .header-actions{
      display:flex;
      gap:.55rem;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .nav-btn{
      padding:.45rem .95rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(15,23,42,.35);
      color:rgba(226,232,240,.92);
      font-weight:700;
      font-size:.86rem;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      backdrop-filter:blur(10px);
      cursor:pointer;
      transition:.16s ease;
    }
    .nav-btn:hover{
      background:rgba(15,23,42,.6);
      border-color:rgba(191,219,254,.85);
      transform:translateY(-1px);
    }
    .btn-green{
      border:none;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#fff;
      box-shadow:0 14px 40px rgba(34,197,94,.22);
    }

    /* ---------- MAIN ---------- */
    main{
      flex:1;
      padding:1.4rem 1.2rem 2.2rem;
      display:flex;
      justify-content:center;
    }
    .wrap{
      width:100%;
      max-width:1120px;
    }

    .signup-shell{
      border-radius:1.6rem;
      background:var(--glass);
      border:1px solid rgba(148,163,184,.28);
      box-shadow:0 26px 80px rgba(0,0,0,.55);
      overflow:hidden;
      position:relative;
    }
    .signup-shell::before{
      content:"";
      position:absolute;
      inset:-20%;
      background:
        radial-gradient(circle at 0 0,rgba(59,130,246,.14),transparent 55%),
        radial-gradient(circle at 100% 0,rgba(56,189,248,.12),transparent 50%),
        radial-gradient(circle at 50% 120%,rgba(34,197,94,.10),transparent 55%);
      opacity:.8;
      pointer-events:none;
    }
    .signup-shell > *{position:relative; z-index:1;}

    .signup-grid{
      display:grid;
      grid-template-columns:1.05fr .95fr;
      gap:1.25rem;
      padding:1.35rem;
      align-items:start;
    }
    @media(max-width:980px){
      .signup-grid{ grid-template-columns:1fr; }
    }

    /* LEFT COPY */
    .signup-copy h1{
      margin:.1rem 0 .55rem;
      font-size:clamp(1.7rem,3.2vw,2.4rem);
      line-height:1.08;
      letter-spacing:-.02em;
      color:#fff;
    }
    .lead{
      margin:0 0 .8rem;
      color:rgba(226,232,240,.88);
      line-height:1.55;
      max-width:68ch;
      font-size:.98rem;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.36rem .75rem;
      border-radius:999px;
      font-size:.82rem;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(255,255,255,.92);
      margin:.25rem 0 .85rem;
      box-shadow:0 10px 25px rgba(0,0,0,.22);
    }
    .plan-pill{
      display:block;
      margin-top:.75rem;
      padding:.85rem .95rem;
      border-radius:1rem;
      background:rgba(2,6,23,.32);
      border:1px solid rgba(255,255,255,.16);
      color:rgba(226,232,240,.92);
      font-size:.9rem;
      line-height:1.45;
    }
    .plan-pill span{
      display:inline-block;
      margin-bottom:.2rem;
      font-weight:900;
      color:#fff;
      letter-spacing:.02em;
    }

    .steps-list{
      margin:.9rem 0 0;
      padding-left:1.05rem;
      color:rgba(226,232,240,.88);
      font-size:.92rem;
      line-height:1.55;
    }
    .steps-list li{ margin:.35rem 0; }
    .mini-note{
      margin-top:.9rem;
      color:rgba(191,219,254,.84);
      font-size:.86rem;
      line-height:1.5;
    }

    /* RIGHT FORM CARD */
    .signup-card{
      border-radius:1.25rem;
      padding:1.15rem 1.15rem 1.05rem;
      background:rgba(2,6,23,.38);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      backdrop-filter:blur(14px);
    }
    .signup-card h2{
      margin:0 0 .35rem;
      font-size:1.05rem;
      color:#fff;
      letter-spacing:-.01em;
    }
    .signup-card .sub{
      margin:0 0 1rem;
      font-size:.88rem;
      color:rgba(226,232,240,.82);
      line-height:1.45;
    }

    form{
      display:flex;
      flex-direction:column;
      gap:.7rem;
      font-size:.9rem;
    }
    .two{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:.7rem;
    }
    @media(max-width:560px){
      .two{ grid-template-columns:1fr; }
    }

    .addr3{
      display:grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap:.7rem;
    }
    .addr2{
      display:grid;
      grid-template-columns: 1fr 2fr;
      gap:.7rem;
    }
    @media(max-width:720px){
      .addr3, .addr2{ grid-template-columns:1fr; }
    }

    .field label{
      display:block;
      font-weight:700;
      margin-bottom:.3rem;
      color:rgba(226,232,240,.92);
      font-size:.86rem;
    }

    .field input,
    .field select{
      width:100%;
      padding:.62rem .75rem;
      border-radius:.85rem;
      border:1px solid var(--field-border);
      background:var(--field-bg);
      color:#e5e7eb;
      font-family:inherit;
      font-size:.92rem;
      outline:none;
      transition:.16s ease;
    }
    .field input::placeholder{ color:rgba(148,163,184,.85); }

    .field input:focus,
    .field select:focus{
      border-color:var(--field-border-focus);
      box-shadow:0 0 0 1px rgba(59,130,246,.55);
      background:var(--field-bg-focus);
    }

    /* dropdown: maak opties leesbaar */
    .field select{
      color:#e5e7eb !important;
    }
    .field select option{
      color:#e5e7eb !important;
      background:#0b1220 !important;
    }

    /* TERMS (checkbox proper) */
    .terms-row{ margin-top:.25rem; }
    .terms-label{
      position:relative;
      display:flex;
      align-items:flex-start;
      gap:.65rem;
      font-size:.84rem;
      color:rgba(226,232,240,.88);
      cursor:pointer;
      line-height:1.35;
      user-select:none;
    }
    .terms-label input{
      position:absolute;
      opacity:0;
      pointer-events:none;
    }
    .cb{
      width:20px;height:20px;
      border-radius:6px;
      flex:0 0 20px;
      margin-top:.08rem;
      border:1px solid rgba(148,163,184,.75);
      background:rgba(15,23,42,.55);
      box-shadow:0 0 0 1px rgba(0,0,0,.18) inset;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .cb svg{
      width:14px;height:14px;
      opacity:0;
      transform:scale(.9);
      transition:.12s ease;
    }
    .terms-label input:checked + .cb{
      border-color:rgba(59,130,246,.95);
      background:linear-gradient(135deg,var(--o1),var(--o2));
      box-shadow:0 10px 22px rgba(37,99,235,.22);
    }
    .terms-label input:checked + .cb svg{
      opacity:1;
      transform:scale(1);
    }
    .terms-label a{
      color:#93c5fd;
      text-decoration:underline;
      font-weight:700;
    }

    .btn{
      width:100%;
      margin-top:.15rem;
      padding:.75rem 1rem;
      border-radius:999px;
      border:none;
      background:linear-gradient(135deg,var(--o1),var(--o2));
      color:#fff;
      font-weight:900;
      font-size:.98rem;
      cursor:pointer;
      box-shadow:0 14px 40px rgba(37,99,235,.35);
      transition:.18s ease;
    }
    .btn:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
      box-shadow:0 18px 55px rgba(37,99,235,.45);
    }
    .btn[disabled]{
      opacity:.72;
      cursor:not-allowed;
      transform:none;
      filter:none;
      box-shadow:none;
    }

    #msg{
      min-height:18px;
      font-size:.84rem;
      margin-top:.15rem;
      text-align:center;
      color:rgba(226,232,240,.85);
      line-height:1.35;
      word-break:break-word;
    }
    .error{ color:var(--danger); font-weight:800; }
    .ok{ color:var(--ok); font-weight:800; }

    .form-footnote{
      margin-top:.55rem;
      font-size:.78rem;
      color:rgba(226,232,240,.75);
      text-align:center;
      line-height:1.45;
    }

    /* FOOTER */
    footer.site-footer{
      border-top:1px solid rgba(255,255,255,.10);
      background:radial-gradient(circle at 50% -50%,rgba(59,130,246,.30),transparent 60%),
                 rgba(2,6,23,.96);
    }
    .site-footer .footer-inner{
      max-width:1120px;
      margin:0 auto;
      padding:1rem 1.2rem 1.2rem;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
      font-size:.82rem;
      color:rgba(148,163,184,.95);
    }
    .footer-nav{
      display:flex;
      gap:.9rem;
      flex-wrap:wrap;
    }
    .footer-nav a{
      color:rgba(191,219,254,.95);
      text-decoration:none;
      font-weight:600;
    }
    .footer-nav a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="site">

    <header class="site-header">
      <div class="header-inner">
        <a class="brand" href="/" aria-label="Vrijeplek home">
          <div class="brand-mark">V</div>
          <div class="brand-wordmark">
            <span>vrijeplek</span>
            <span>last minute afspreken</span>
          </div>
        </a>

        <nav class="header-actions">
          <a class="nav-btn" href="/waarom.html">Waarom Vrijeplek?</a>
          <a class="nav-btn" href="/login.html" id="nav-login">Login</a>
          <a class="nav-btn btn-green" href="/dashboard.html" id="nav-mijn" style="display:none;">Mijn Vrijeplek</a>
        </nav>
      </div>
    </header>

    <main>
      <div class="wrap">
        <section class="signup-shell">
          <div class="signup-grid">

            <div class="signup-copy">
              <div class="pill" id="pill-title">Account aanmaken</div>
              <h1 id="hero-title">Word lid van Vrijeplek in 2 stappen.</h1>

              <p class="lead" id="hero-lead">
                Eerst maak je <strong>gratis</strong> een account. Daarna kies je in je dashboard
                of je maandelijks of jaarlijks wil activeren. Je betaalt pas als je je plan activeert.
              </p>

              <div id="plan-note" class="plan-pill">
                <span>Stap 2 — plannen</span><br>
                Maandelijks €19,95 • Jaarplan €180 (3 mnd gratis)
              </div>

              <ul class="steps-list" id="steps">
                <li><strong>Stap 1:</strong> vul hieronder je gegevens in en bevestig via e-mail.</li>
                <li><strong>Stap 2:</strong> log in, activeer je plan en zet je eerste vrije plekken online.</li>
                <li>Kosteloos opzegbaar. Geen commissie per boeking.</li>
              </ul>

              <p class="mini-note" id="mini-note">
                Tip: gebruik hetzelfde e-mailadres als voor je facturatie, dan loopt alles netjes samen.
              </p>
            </div>

            <div class="signup-card">
              <h2>Account aanmaken</h2>
              <p class="sub">Account is gratis. Abonnement kies en activeer je later in je dashboard.</p>

              <form id="signup-form" novalidate>
                <div class="two">
                  <div class="field">
                    <label for="name">Naam</label>
                    <input id="name" name="name" type="text" required placeholder="Volledige naam" autocomplete="name">
                  </div>
                  <div class="field">
                    <label for="company">Bedrijfsnaam</label>
                    <input id="company" name="company" type="text" placeholder="Naam van je zaak" autocomplete="organization">
                  </div>
                </div>

                <div class="field">
                  <label for="email">E-mail</label>
                  <input id="email" name="email" type="email" required placeholder="naam@voorbeeld.be" autocomplete="email">
                </div>

                <div class="two">
                  <div class="field">
                    <label for="password">Wachtwoord</label>
                    <input id="password" name="password" type="password" required minlength="6"
                           placeholder="Min. 6 tekens" autocomplete="new-password">
                  </div>
                  <div class="field">
                    <label for="password2">Herhaal wachtwoord</label>
                    <input id="password2" name="password2" type="password" required minlength="6"
                           placeholder="Nogmaals wachtwoord" autocomplete="new-password">
                  </div>
                </div>

                <div class="two">
                  <div class="field">
                    <label for="phone">Telefoon</label>
                    <input id="phone" name="phone" type="tel" placeholder="+32 ..." autocomplete="tel">
                  </div>
                  <div class="field">
                    <label for="btw">BTW-nummer</label>
                    <input id="btw" name="btw" type="text" placeholder="BE0123456789" required inputmode="text" autocomplete="off">
                  </div>
                </div>

                <div class="field">
                  <label for="peppol">Peppol-ID (voor facturatie)</label>
                  <input id="peppol" name="peppol" type="text" placeholder="bv. 0208:BE0123456789" autocomplete="off">
                </div>

                <div class="field">
                  <label for="cat">Categorie</label>
                  <select id="cat" name="cat" required>
                    <option value="">Kies</option>
                    <option value="horeca">Horeca</option>
                    <option value="wellness">Wellness</option>
                    <option value="zorg">Gezondheid</option>
                    <option value="events">Events</option>
                    <option value="poetsdiensten">Poetsdiensten</option>
                    <option value="ramenwasser">Ramenwasser</option>
                    <option value="dieren">Dieren</option>
                    <option value="bouw">Bouw & renovatie</option>
                  </select>
                </div>

                <!-- ADRES: alles apart -->
                <div class="addr3">
                  <div class="field">
                    <label for="street">Straat</label>
                    <input id="street" name="street" type="text" required placeholder="Bv. Breereweg" autocomplete="address-line1">
                  </div>
                  <div class="field">
                    <label for="house_number">Huisnr.</label>
                    <input id="house_number" name="house_number" type="text" required placeholder="15A" autocomplete="off">
                  </div>
                  <div class="field">
                    <label for="bus">Bus</label>
                    <input id="bus" name="bus" type="text" placeholder="(optioneel)" autocomplete="address-line2">
                  </div>
                </div>

                <div class="addr2">
                  <div class="field">
                    <label for="postcode">Postcode</label>
                    <input id="postcode" name="postcode" type="text" required placeholder="3665" inputmode="numeric" autocomplete="postal-code">
                  </div>
                  <div class="field">
                    <label for="city">Gemeente</label>
                    <input id="city" name="city" type="text" required placeholder="As" autocomplete="address-level2">
                  </div>
                </div>

                <div class="field terms-row">
                  <label class="terms-label" for="terms">
                    <input id="terms" type="checkbox" required>
                    <span class="cb" aria-hidden="true">
                      <svg viewBox="0 0 24 24" fill="none">
                        <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </span>
                    <span>
                      Ik ga akkoord met de
                      <a href="/voorwaarden.html" target="_blank" rel="noopener">algemene voorwaarden</a>.
                    </span>
                  </label>
                </div>

                <button id="submitBtn" type="submit" class="btn">Account aanmaken</button>
                <div id="msg"></div>

                <p class="form-footnote">
                  Na je registratie sturen we een bevestigingsmail. Daarna kun je inloggen en je abonnement activeren.
                </p>
              </form>
            </div>

          </div>
        </section>
      </div>
    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        <span>© <span id="year"></span> Vrijeplek.be — Last minute afspraken, netjes geregeld.</span>
        <nav class="footer-nav">
          <a href="/voorwaarden.html">Algemene voorwaarden</a>
          <a href="/waarom.html">Waarom Vrijeplek?</a>
        </nav>
      </div>
    </footer>

  </div>

  <!-- Config (zet window.VRIJEPLEK) -->
  <script src="/js/config.js"></script>

  <!-- Supabase UMD -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.min.js"></script>

  <script>
    window.addEventListener('DOMContentLoaded', async () => {
      const y = document.getElementById('year');
      if (y) y.textContent = String(new Date().getFullYear());

      const form = document.getElementById('signup-form');
      const msg  = document.getElementById('msg');
      const submitBtn = document.getElementById('submitBtn');
      const planNote = document.getElementById('plan-note');

      const btnLogin = document.getElementById('nav-login');
      const btnMijn  = document.getElementById('nav-mijn');

      let loading = false;

      function setLoading(on){
        loading = !!on;
        if (submitBtn) submitBtn.disabled = loading;
        if (loading) {
          if (msg) { msg.className = ''; msg.textContent = 'Even geduld…'; }
        }
      }

      function normalizeBEVat(btw) {
        return (btw || '').replace(/\s+/g, '').toUpperCase();
      }
      function isValidBEVat(btw) {
        btw = normalizeBEVat(btw);
        if (!btw.startsWith('BE')) return false;
        const digits = btw.slice(2);
        return /^\d{10}$/.test(digits);
      }

      const PEPPOL_SCHEME = '0208';
      function suggestPeppolIdFromVat(btw) {
        const norm = normalizeBEVat(btw);
        const digits = norm.slice(2);
        return `${PEPPOL_SCHEME}:${norm.startsWith('BE') ? ('BE' + digits) : norm}`;
      }

      function getSupabaseCreds(){
        const url =
          window.VRIJEPLEK?.SUPABASE_URL ||
          window.ENV?.SUPABASE_URL || '';
        const key =
          window.VRIJEPLEK?.SUPABASE_ANON_KEY ||
          window.ENV?.SUPABASE_ANON_KEY || '';
        if (!url || !key) return null;
        return { url, key };
      }

      async function waitForConfig(){
        if (getSupabaseCreds()) return;
        await new Promise((resolve) => {
          let done = false;
          const finish = () => {
            if (done) return;
            done = true;
            resolve();
          };
          window.addEventListener('vrijeplek-config-loaded', finish, { once: true });
          setTimeout(finish, 3500);
        });
      }

      function withTimeout(promise, ms){
        let t;
        const timeout = new Promise((_, reject) => {
          t = setTimeout(() => reject(new Error('TIMEOUT')), ms);
        });
        return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
      }

      async function initSupabase(){
        if (window.__vpSupabaseClient) return window.__vpSupabaseClient;

        await waitForConfig();

        const creds = getSupabaseCreds();
        if (!creds) return null;

        // wacht tot UMD geladen is
        const supa = window.supabase;
        if (!supa || typeof supa.createClient !== 'function') return null;

        window.__vpSupabaseClient = supa.createClient(creds.url, creds.key, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            storage: localStorage,
          },
        });

        return window.__vpSupabaseClient;
      }

      const client = await initSupabase();
      if (!client) {
        if (msg) { msg.className = 'error'; msg.textContent = 'Configuratie fout. Herlaad de pagina.'; }
        return;
      }

      async function toggleNav(){
        if (!btnLogin || !btnMijn) return;
        try {
          const { data, error } = await client.auth.getSession();
          if (error) throw error;

          const loggedIn = !!(data?.session?.user);
          btnLogin.style.display = loggedIn ? 'none' : 'inline-flex';
          btnMijn.style.display  = loggedIn ? 'inline-flex' : 'none';
        } catch (e) {
          btnLogin.style.display = 'inline-flex';
          btnMijn.style.display  = 'none';
        }
      }
      await toggleNav();
      client.auth.onAuthStateChange(() => toggleNav());

      // Promo / plan tekst
      if (planNote) {
        const params = new URLSearchParams(window.location.search);
        const promo = params.get('promo');
        const plan  = params.get('plan');

        if (promo === 'launch') {
          planNote.innerHTML =
            '<span>Pre-inschrijving</span><br>' +
            'Schrijf nu in en behoud je <strong>€19,95/maand</strong> zolang je klant blijft. ' +
            'Kosteloos opzegbaar.';
        } else if (plan === 'monthly') {
          planNote.innerHTML =
            '<span>Gekozen plan</span><br>' +
            '<strong>Maandelijks</strong> €19,95 • later altijd om te zetten naar jaarplan.';
        } else if (plan === 'yearly') {
          planNote.innerHTML =
            '<span>Gekozen plan</span><br>' +
            '<strong>Jaarplan</strong> €180 (3 mnd gratis) • voordeligste optie.';
        } else {
          planNote.innerHTML =
            '<span>Stap 2 — plannen</span><br>' +
            'Maandelijks €19,95 • Jaarplan €180 (3 mnd gratis)';
        }
      }

      if (!form || !msg) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (loading) return;

        setLoading(true);

        // Na 6s: “nog even geduld”
        const slowTimer = setTimeout(() => {
          if (loading && msg) msg.textContent = 'Nog even geduld… dit kan soms 10–20 seconden duren.';
        }, 6000);

        try{
          const name  = document.getElementById('name').value.trim();
          const email = document.getElementById('email').value.trim().toLowerCase();
          const pass  = document.getElementById('password').value.trim();
          const pass2 = document.getElementById('password2').value.trim();

          const phone = document.getElementById('phone').value.trim();
          const btwEl = document.getElementById('btw');
          const peppEl= document.getElementById('peppol');
          const cat   = document.getElementById('cat').value;

          const street = document.getElementById('street').value.trim();
          const house  = document.getElementById('house_number').value.trim();
          const bus    = document.getElementById('bus').value.trim();
          const pc     = document.getElementById('postcode').value.trim();
          const city   = document.getElementById('city').value.trim();

          const termsOk = document.getElementById('terms').checked;

          if (!name || !email || !pass || !pass2) {
            msg.className = 'error';
            msg.textContent = 'Vul alle verplichte velden in.';
            return;
          }
          if (pass !== pass2){
            msg.className = 'error';
            msg.textContent = 'Wachtwoorden komen niet overeen.';
            return;
          }
          if (!termsOk){
            msg.className = 'error';
            msg.textContent = 'Je moet akkoord gaan met de algemene voorwaarden.';
            return;
          }

          const rawBtw = (btwEl?.value || '').trim();
          if (!isValidBEVat(rawBtw)) {
            msg.className = 'error';
            msg.textContent = 'BTW-nummer lijkt niet correct. Gebruik formaat BE0XXXXXXXXX.';
            return;
          }

          if (!cat) {
            msg.className = 'error';
            msg.textContent = 'Kies een categorie.';
            return;
          }

          if (!street || !house || !pc || !city) {
            msg.className = 'error';
            msg.textContent = 'Vul je adres volledig in (straat, huisnr, postcode en gemeente).';
            return;
          }

          if (peppEl && !peppEl.value.trim()) {
            peppEl.value = suggestPeppolIdFromVat(rawBtw);
          }

          const normalizedBtw  = normalizeBEVat(rawBtw);
          const peppolIdToSave = peppEl ? peppEl.value.trim() : '';

          const straatVolledig = bus ? `${street} ${house} bus ${bus}` : `${street} ${house}`;

          // redirect na email confirm: stuur naar login (bestaat zeker)
          const redirectTo = window.location.origin + '/login.html?confirmed=1';

          const signupPromise = client.auth.signUp({
            email,
            password: pass,
            options: {
              data: {
                display_name: name,
                bedrijf: document.getElementById('company').value.trim(),
                telefoon: phone,
                btw: normalizedBtw,
                peppol_id: peppolIdToSave,
                cat,
                // backwards compat + apart velden
                straat: straatVolledig,
                straatnaam: street,
                huisnummer: house,
                bus: bus || null,
                postcode: pc,
                gemeente: city,
              },
              emailRedirectTo: redirectTo
            }
          });

          // 45s is ruim genoeg zonder “hang forever”
          const { data, error } = await withTimeout(signupPromise, 45000);

          if (error) {
            msg.className = 'error';
            msg.textContent = (String(error.message || '').toLowerCase().includes('already'))
              ? 'Er bestaat al een account met dit e-mailadres.'
              : ('Registratie mislukt: ' + (error.message || 'onbekende fout'));
            return;
          }

          // Success
          msg.className = 'ok';
          msg.textContent = 'Bevestigingsmail verstuurd. Controleer je inbox of spam. Klik op de link en log daarna in.';
          form.reset();
        } catch(err){
          console.error('Signup exception:', err);

          msg.className = 'error';
          if (err && err.message === 'TIMEOUT') {
            msg.textContent =
              'Het duurt te lang om te verbinden. Probeer opnieuw. ' +
              'Als dit blijft gebeuren: check in “Network” of de call naar Supabase niet geblokkeerd wordt.';
          } else {
            msg.textContent = 'Netwerkfout. Probeer opnieuw.';
          }
        } finally {
          clearTimeout(slowTimer);
          setLoading(false);
        }
      });
    });
  </script>
</body>
</html>
