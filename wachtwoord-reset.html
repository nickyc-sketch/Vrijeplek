<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nieuw wachtwoord — Vrijeplek</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=smurf6">
  <style>
    .site-header::after{content:"";position:absolute;inset:auto 0 0 0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.45),transparent);opacity:.6}
    .section-title{display:flex;align-items:center;gap:10px;justify-content:center;margin:8px auto 22px;color:var(--blue-900)}
    .section-title::before,.section-title::after{content:"";flex:1 1 100px;height:1px;background:linear-gradient(90deg,transparent,rgba(26,102,255,.25),transparent)}
    .form-grid{display:grid;grid-template-columns:1fr;gap:14px}
    .tiny-note{font-size:12px;color:#5b6b86}
  </style>
</head>
<body>
  <div class="site">
    <header class="site-header">
      <div class="header-inner">
        <a href="index.html" class="brand" style="text-decoration:none;display:flex;align-items:center;gap:10px;">
          <img src="img/logo.png" alt="Vrijeplek logo" style="height:40px;" onerror="this.remove()">
          <span class="brand-name">Vrijeplek</span><span class="brand-dot"></span>
        </a>
      </div>
    </header>

    <main>
      <section class="hero" style="padding:56px 0 40px;text-align:center;">
        <div class="container hero-inner">
          <h1 class="section-title">Nieuw wachtwoord instellen</h1>
          <p style="max-width:700px;margin:0 auto 26px;color:#1f2a44;">Kies een nieuw wachtwoord en bevestig.</p>

          <div class="search-wrap" style="max-width:620px; padding:18px; margin-inline:auto;">
            <div class="card-head">
              <h2>Bevestig wachtwoord</h2>
              <span class="badge"><span class="badge-dot"></span> Herstel</span>
            </div>

            <form id="reset-form" class="form-grid" novalidate>
              <div class="field">
                <label for="pw1">Nieuw wachtwoord</label>
                <input id="pw1" type="password" class="input" required autocomplete="new-password" minlength="8">
              </div>
              <div class="field">
                <label for="pw2">Herhaal wachtwoord</label>
                <input id="pw2" type="password" class="input" required autocomplete="new-password" minlength="8">
              </div>
              <div class="submit-zone" style="flex-direction:column;gap:10px;">
                <button type="submit" class="btn" style="min-width:220px;height:46px;">Opslaan</button>
                <div id="reset-msg" class="tiny-note"></div>
              </div>
            </form>

          </div>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        <p>© 2025 Vrijeplek. Alle rechten voorbehouden.</p>
      </div>
    </footer>
  </div>

  <script src="/js/config.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    function initSupabase() {
      return new Promise((resolve) => {
        if (window.VRIJEPLEK?.SUPABASE_URL && window.VRIJEPLEK?.SUPABASE_ANON_KEY) {
          resolve(createSupabaseClient());
          return;
        }

        window.addEventListener('vrijeplek-config-loaded', () => {
          resolve(createSupabaseClient());
        }, { once: true });

        setTimeout(() => resolve(createSupabaseClient()), 3000);
      });
    }

    function createSupabaseClient() {
      const SUPABASE_URL = window.VRIJEPLEK?.SUPABASE_URL || window.ENV?.SUPABASE_URL || '';
      const SUPABASE_ANON_KEY = window.VRIJEPLEK?.SUPABASE_ANON_KEY || window.ENV?.SUPABASE_ANON_KEY || '';

      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        console.error('Supabase credentials not configured.');
        return null;
      }
      return createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, storage: localStorage } });
    }

    initSupabase().then(supa => {
      if (!supa) {
        const msg = document.getElementById('reset-msg');
        if (msg) msg.textContent = 'Configuratie fout. Herlaad de pagina.';
        return;
      }

      const form = document.getElementById('reset-form');
      const pw1  = document.getElementById('pw1');
      const pw2  = document.getElementById('pw2');
      const msg  = document.getElementById('reset-msg');

      // Wacht tot Supabase de recovery sessie klaarzet
      let ready = false;
      const { data: sub } = supa.auth.onAuthStateChange(async (event, session) => {
      if (event === 'PASSWORD_RECOVERY' || event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
        ready = true;
      }
    });

      // Extra safeguard: korte timeout; daarna gaan we gewoon proberen
      setTimeout(()=>{ ready = true; }, 1200);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(!ready){ msg.textContent = 'Even geduld…'; return; }
        if(!pw1.value || pw1.value !== pw2.value){ msg.textContent = 'Wachtwoorden komen niet overeen.'; return; }
        msg.textContent = 'Opslaan…';

        const { error } = await supa.auth.updateUser({ password: pw1.value });
        if (error) { msg.textContent = error.message || 'Kon wachtwoord niet updaten.'; return; }

        msg.textContent = 'Wachtwoord ingesteld. Je wordt aangemeld…';
        // Na update is user ingelogd → naar dashboard
        setTimeout(()=>{ window.location.href = '/dashboard.html'; }, 500);
      });
    }).catch(err => {
      console.error('Supabase init error:', err);
      const msg = document.getElementById('reset-msg');
      if (msg) msg.textContent = 'Fout bij initialiseren. Herlaad de pagina.';
    });
  </script>
</body>
</html>
