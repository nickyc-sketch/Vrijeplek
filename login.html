<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Login — Vrijeplek</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=smurf6">

  <style>
    :root{
      --ink:#0a2a4a;
      --muted:#5b6b86;
      --line:rgba(26,102,255,.25);
      --accent:#1a66ff;
      --accent2:#0056ff;
      --danger:#e23b3b;
    }

    body{
      margin:0;
      font-family:'Poppins',sans-serif;
      background:linear-gradient(180deg,#e9f2ff,#f6f9ff);
      color:var(--ink);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .site-header{
      position:sticky;
      top:0;
      z-index:40;
      backdrop-filter:blur(14px);
      background:linear-gradient(180deg,rgba(248,251,255,.96),rgba(248,251,255,.86));
      border-bottom:1px solid rgba(26,102,255,.15);
    }
    .site-header::after{
      content:"";position:absolute;inset:auto 0 0 0;height:1px;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,.45),transparent);
      opacity:.6;
    }
    .header-inner{
      max-width:1100px;
      margin:0 auto;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
    }
    .brand img{height:34px;}
    .brand-name{font-weight:800;color:var(--ink);}
    .brand-dot{width:6px;height:6px;border-radius:999px;background:linear-gradient(120deg,#1a66ff,#0056ff);}
    .header-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .nav-btn{
      padding:7px 13px;
      border-radius:999px;
      border:1px solid rgba(26,102,255,.22);
      font-size:13px;
      text-decoration:none;
      color:var(--ink);
      background:rgba(255,255,255,.9);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
    }
    .nav-btn[aria-current="page"]{
      border-color:rgba(26,102,255,.6);
      box-shadow:0 0 0 1px rgba(26,102,255,.12);
    }
    .btn-green{
      border-color:rgba(16,185,129,.7);
      color:#065f46;
      background:rgba(209,250,229,.9);
    }

    main{
      flex:1;
      padding:32px 0 36px;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:0 12px;
    }

    .login-hero{
      padding:32px 0 10px;
    }
    .login-grid{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:28px;
      align-items:center;
    }
    @media(max-width:960px){
      .login-grid{
        grid-template-columns:1fr;
      }
    }

    .login-copy h1{
      margin:0 0 10px;
      font-size:clamp(24px,2.6vw,32px);
    }
    .login-copy p.lead{
      margin:0 0 14px;
      font-size:14px;
      color:var(--muted);
      max-width:460px;
    }
    .login-points{
      margin:10px 0 0;
      padding-left:16px;
      font-size:13px;
      color:#3a4b6a;
    }
    .login-points li{margin:3px 0;}
    .mini-note{
      margin-top:10px;
      font-size:12px;
      color:#6b7280;
    }

    .login-card{
      padding:18px 18px 20px;
      border-radius:18px;
      border:1px solid rgba(26,102,255,.18);
      background:linear-gradient(180deg,rgba(255,255,255,.97),rgba(255,255,255,.9));
      box-shadow:0 10px 30px rgba(15,23,42,.12);
    }
    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .card-head h2{
      margin:0;
      font-size:18px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(22,163,74,.4);
      background:rgba(220,252,231,.9);
      color:#166534;
      font-weight:600;
    }
    .badge-dot{
      width:8px;height:8px;border-radius:999px;
      background:radial-gradient(circle,#22c55e,#15803d);
      box-shadow:0 0 0 4px rgba(34,197,94,.25);
    }

    .form-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }

    .field label{
      display:block;
      font-weight:600;
      font-size:13px;
      margin-bottom:3px;
    }
    .field .input{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.9);
      font-family:inherit;
      font-size:13px;
      background:rgba(248,250,252,.95);
      color:var(--ink);
    }
    .field .input::placeholder{color:#9ca3af;}

    .remember-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#4b5563;
    }
    .remember-row input{
      accent-color:#1a66ff;
    }

    .submit-zone{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:4px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:11px 16px;
      border-radius:999px;
      border:none;
      background:linear-gradient(120deg,var(--accent),var(--accent2));
      color:#fff;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 10px 22px rgba(37,99,235,.35);
      transition:.2s;
      width:100%;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(37,99,235,.45);
    }

    #login-msg{
      min-height:18px;
      font-size:12px;
      color:#6b7280;
      text-align:center;
    }
    #login-msg.error{color:var(--danger);font-weight:600;}

    .under-links{
      display:flex;
      gap:10px;
      justify-content:center;
      font-size:13px;
      color:#6b7280;
      flex-wrap:wrap;
    }
    .under-links a{
      color:#1a66ff;
      text-decoration:none;
    }
    .under-links a:hover{text-decoration:underline;}

    footer.site-footer{
      border-top:1px solid rgba(148,163,184,.5);
      margin-top:auto;
    }
    .site-footer .footer-inner{
      max-width:1100px;
      margin:0 auto;
      padding:14px 12px 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      color:#6b7280;
    }
    .footer-nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer-nav a{
      color:#6b7280;
      text-decoration:none;
      font-size:12px;
    }
    .footer-nav a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div class="site">
    <header class="site-header">
      <div class="header-inner">
        <a href="index.html" class="brand">
          <img src="img/logo.png" alt="Vrijeplek logo" onerror="this.remove()">
          <span class="brand-name">Vrijeplek</span><span class="brand-dot"></span>
        </a>
        <nav class="header-actions">
          <a class="nav-btn" href="waarom.html">Waarom Vrijeplek?</a>
          <a class="nav-btn" href="aanmelden.html">Word lid</a>
          <a id="nav-login" class="nav-btn" href="login.html" aria-current="page">Login</a>
          <a id="nav-mijn" class="nav-btn btn-green" href="dashboard.html" style="display:none;">Mijn Vrijeplek</a>
        </nav>
      </div>
    </header>

    <main>
      <section class="login-hero">
        <div class="container login-grid">
          <div class="login-copy">
            <h1>Welkom bij Vrijeplek.</h1>
            <p class="lead">
              Log in met je e-mailadres en wachtwoord om je vrije momenten te beheren,
              aanvragen te bevestigen en je planning strak te houden.
            </p>
            <ul class="login-points">
              <li>Bekijk en beheer je geplaatste vrije momenten.</li>
              <li>Bevestig of weiger aanvragen met één klik.</li>
              <li>Pas je plan of facturatiegegevens aan in je dashboard.</li>
            </ul>
            <p class="mini-note">
              Nog geen account? <a href="aanmelden.html">Maak je account gratis aan</a> en activeer later je abonnementsplan.
            </p>
          </div>

          <div class="login-card">
            <div class="card-head">
              <h2>Beveiligde login</h2>
              <span class="badge"><span class="badge-dot"></span> SSL actief</span>
            </div>

            <form id="login-form" class="form-grid" novalidate>
              <div class="field">
                <label for="login-email">E-mailadres</label>
                <input id="login-email" type="email" class="input" required autocomplete="email" placeholder="naam@voorbeeld.be">
              </div>
              <div class="field">
                <label for="login-password">Wachtwoord</label>
                <input id="login-password" type="password" class="input" required autocomplete="current-password" placeholder="Je wachtwoord">
              </div>
              <div class="field">
                <div class="remember-row">
                  <input id="remember" type="checkbox" checked>
                  <label for="remember">Ingelogd blijven op dit toestel</label>
                </div>
              </div>

              <div class="submit-zone">
                <button type="submit" class="btn">Inloggen</button>
                <div id="login-msg"></div>
                <div class="under-links">
                  <a href="wachtwoord-vergeten.html" class="text-link">Wachtwoord vergeten?</a>
                  <span>•</span>
                  <a href="aanmelden.html" class="text-link">Nog geen account? Aanmelden</a>
                </div>
              </div>
            </form>
          </div>

        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="footer-inner">
        <p>© 2025 Vrijeplek. Alle rechten voorbehouden.</p>
        <nav class="footer-nav">
          <a href="voorwaarden.html">Algemene voorwaarden</a>
          <a href="#privacy">Privacy</a>
          <a href="#contact">Contact</a>
        </nav>
      </div>
    </footer>
  </div>

  <script src="/js/config.js"></script>
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // Wait for config to load
    function initSupabase() {
      return new Promise((resolve) => {
        // If config is already loaded, proceed immediately
        if (window.VRIJEPLEK?.SUPABASE_URL && window.VRIJEPLEK?.SUPABASE_ANON_KEY) {
          resolve(createSupabaseClient());
          return;
        }

        // Otherwise wait for config-loaded event
        window.addEventListener('vrijeplek-config-loaded', () => {
          resolve(createSupabaseClient());
        }, { once: true });

        // Timeout after 3 seconds
        setTimeout(() => {
          resolve(createSupabaseClient());
        }, 3000);
      });
    }

    function createSupabaseClient() {
      const SUPABASE_URL = window.VRIJEPLEK?.SUPABASE_URL || window.ENV?.SUPABASE_URL || '';
      const SUPABASE_ANON_KEY = window.VRIJEPLEK?.SUPABASE_ANON_KEY || window.ENV?.SUPABASE_ANON_KEY || '';

      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
        console.error('Supabase credentials not configured. Check Netlify environment variables.');
        const msg = document.getElementById('login-msg');
        if (msg) {
          msg.className = 'error';
          msg.textContent = 'Configuratie fout: Supabase credentials ontbreken. Neem contact op met de beheerder.';
        }
        return null;
      }

      return createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        auth: { persistSession: true, autoRefreshToken: true, storage: localStorage }
      });
    }

    const supaPromise = initSupabase();

    supaPromise.then(async (supa) => {
      if (!supa) return; // Config failed

      const btnLogin = document.getElementById('nav-login');
      const btnMijn  = document.getElementById('nav-mijn');

      async function toggleNav(){
        if (!btnLogin || !btnMijn) {
          console.warn('Nav buttons not found');
          return;
        }
        
        try {
          // Force fresh session check
          const { data, error } = await supa.auth.getSession();
          
          if (error) {
            console.error('Session check error:', error);
            // On error, show login button
            btnLogin.style.display = 'inline-flex';
            btnMijn.style.display = 'none';
            return;
          }
          
          const loggedIn = !!(data?.session?.user);
          console.log('Session check - logged in:', loggedIn);
          
          if (loggedIn){
            btnLogin.style.display = 'none';
            btnMijn.style.display  = 'inline-flex';
          } else {
            btnLogin.style.display = 'inline-flex';
            btnMijn.style.display  = 'none';
          }
        } catch (err) {
          console.error('Toggle nav error:', err);
          // On error, default to showing login button
          btnLogin.style.display = 'inline-flex';
          btnMijn.style.display = 'none';
        }
      }
      
      // Initial check
      await toggleNav();
      
      // Listen for auth state changes
      supa.auth.onAuthStateChange((event, session) => {
        console.log('Auth state changed:', event, session?.user?.email);
        toggleNav();
      });

      // REMOVED: Auto-redirect when already logged in
      // Users can now stay on login page even if already logged in
      // They can manually navigate to dashboard if needed

      const form   = document.getElementById('login-form');
      const email  = document.getElementById('login-email');
      const pass   = document.getElementById('login-password');
      const msg    = document.getElementById('login-msg');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const cleanEmail = email.value.trim().toLowerCase();

        if (!cleanEmail || !pass.value) {
          msg.className = 'error';
          msg.textContent = 'Vul e-mailadres en wachtwoord in.';
          return;
        }
        msg.className = '';
        msg.textContent = 'Aan het inloggen…';

        const { error } = await supa.auth.signInWithPassword({
          email: cleanEmail,
          password: pass.value
        });

        if (error) {
          msg.className = 'error';
          msg.textContent = error.message || 'Login mislukt.';
          return;
        }

        // Succes → dashboard met email in de URL
        const target = '/dashboard.html?email=' + encodeURIComponent(cleanEmail);
        window.location.href = target;
      });
    }).catch(err => {
      console.error('Failed to initialize Supabase:', err);
      const msg = document.getElementById('login-msg');
      if (msg) {
        msg.className = 'error';
        msg.textContent = 'Fout bij initialiseren. Herlaad de pagina.';
      }
    });
  </script>
</body>
</html>
