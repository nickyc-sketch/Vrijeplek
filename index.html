<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vrijeplek — Last minute? Zoek een afspraak!</title>

  <!-- Google fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!--
    Deze homepage is gebaseerd op de originele Vrijeplek zoekpagina maar lichter
    qua achtergrond en afgestemd op de look‑and‑feel van het dashboard. De
    achtergrond gebruikt een zachte blauwe gradiënt en de result cards staan
    op een doorschijnend vlak. De ronde categorieknoppen zijn behouden en er
    is een extra knop voor "Bouw & renovatie" toegevoegd. Bij het zoeken
    worden de resultaten per categorie gegroepeerd weergegeven onder de
    zoekbalk.
  -->
  <style>
    :root{
      /* Primaire kleuren komen overeen met het dashboard */
      --o1:#1a66ff;
      --o2:#0056ff;
      --ink:#0a2a4a;
      --line:rgba(26,102,255,.22);
      /* Semi transparant wit voor "glas" kaarten */
      --glass:rgba(255,255,255,.88);
      --glass-b:rgba(26,102,255,.18);
    }
    html, body{height:100%}
    body{
      margin:0;
      font-family:'Poppins',system-ui,-apple-system,'Segoe UI',sans-serif;
      color:var(--ink);
      /* Donkerblauwe achtergrond zoals het dashboard. De centre in het midden wordt lichter gemaakt via de search‑wrap en kaarten. */
      background:
        radial-gradient(120% 140% at 0% 0%, #003b84 0, transparent 60%),
        radial-gradient(120% 140% at 100% 0%, #00a0ff 0, transparent 55%),
        radial-gradient(160% 160% at 50% 120%, #021428 0, #020617 55%);
      background-attachment:fixed;
    }
    .site{
      min-height:100svh;
      display:flex;
      flex-direction:column;
    }
    /**
     * Site header
     *
     * Het dashboard gebruikt een half transparant "glas" effect voor de bovenbalk. Om dezelfde
     * uitstraling te creëren op de homepage is de hoofdbalk nu semi‑transparant met een
     * lichte blur, waardoor de achtergrond erdoorheen schijnt. De primaire kleuren
     * (var(--o1)/var(--o2)) blijven aanwezig voor herkenbaarheid, maar met een lagere
     * opacity zodat de header minder massief oogt. De linkerkant toont het logo zoals in
     * het dashboard: een ronde mark met een V en een woordmerk met twee regels (merknaam
     * en tagline). Deze vervangen het oude afbeelding‑logo.
     */
    header.site-header{
      position:sticky;
      top:0;
      z-index:50;
      /* Half transparante kleuren gebaseerd op de primaire kleuren */
      background:linear-gradient(135deg, rgba(26,102,255,.5), rgba(0,86,255,.5));
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
      border-bottom:1px solid rgba(255,255,255,.22);
      color:#f9fafb;
      box-shadow:0 4px 20px rgba(0,0,0,.2);
    }
    .header-inner{
      max-width:1200px;
      margin:0 auto;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    /* Logo zoals in het dashboard */
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:#f9fafb;
    }
    .brand-mark{
      width:32px;
      height:32px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 20%, #fff 0, #b3e0ff 18%, transparent 40%),
                 radial-gradient(circle at 80% 80%, #0f5bff 0, #001d5c 55%);
      box-shadow:0 0 0 1px rgba(255,255,255,.1),0 10px 30px rgba(0,0,0,.4);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1.1rem;
      font-weight:700;
      color:#fff;
    }
    .brand-wordmark{
      display:flex;
      flex-direction:column;
      line-height:1.05;
    }
    .brand-wordmark span:first-child{
      font-weight:700;
      letter-spacing:.02em;
      font-size:1.05rem;
      color:#f9fafb;
      text-transform:none;
    }
    .brand-wordmark span:last-child{
      font-size:.7rem;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:rgba(226,232,240,.8);
    }
    .header-actions{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .nav-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius:999px;
      text-decoration:none;
      font-weight:600;
      border:1px solid rgba(255,255,255,.35);
      color:#f9fafb;
      background:rgba(255,255,255,.12);
      font-size:13px;
      transition:background .15s ease;
    }
    .nav-btn:hover{
      background:rgba(255,255,255,.22);
    }
    .btn-green{
      background:linear-gradient(135deg,#16a34a,#0e9f6e);
      border:1px solid rgba(16,185,129,.25);
      color:#fff!important;
      box-shadow:0 6px 18px rgba(16,185,129,.2);
    }
    main{flex:1;}
    /* Zoekenform */
    .search-wrap{
      width:100%;
      max-width:960px;
      margin:20px auto;
      padding:20px;
      border-radius:16px;
      /* Maak de zoekcontainer lichter en minder contrastrijk zodat hij uit het donkere dashboard springt. */
      background:rgba(255,255,255,.9);
      border:1px solid rgba(255,255,255,.2);
      box-shadow:0 8px 30px rgba(0,0,0,.2);
    }
    form.search{
      display:grid;
      grid-template-columns:1.2fr 1fr .8fr .8fr 1fr auto;
      gap:12px;
    }
    @media(max-width:1024px){form.search{grid-template-columns:1fr 1fr 1fr;}}
    @media(max-width:720px){form.search{grid-template-columns:1fr;}}
    .search .field{display:flex;flex-direction:column;gap:6px;text-align:left;}
    .search label{
      font-size:12px;
      font-weight:700;
      color:#2a4163;
    }
    .search input,
    .search select{
      padding:10px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      font-size:13px;
    }
    .btn-primary{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 18px;
      border-radius:999px;
      border:0;
      background:linear-gradient(120deg,var(--o1),var(--o2));
      color:#fff;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 8px 22px rgba(37,99,235,.3);
    }
    /* Categorieknoppen */
    .cat-dots{padding:20px 0;}
    .cat-dots-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      list-style:none;
      padding:0;
      margin:0;
      justify-content:center;
    }
    .catdot{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      text-decoration:none;
      color:var(--ink);
    }
    .catdot img{
      width:86px;
      height:86px;
      object-fit:cover;
      border-radius:999px;
      border:1px solid var(--line);
      box-shadow:0 8px 24px rgba(10,27,90,.06);
      background:#fff;
    }
    /* Maak de ondertitel van de categorieknoppen zichtbaar op de donkere achtergrond */
    .catdot span{
      font-weight:700;
      font-size:13px;
      color:#fff;
      text-shadow:0 1px 2px rgba(0,0,0,.5);
    }

    /* Zorg dat de heldentitel goed leesbaar is op de donkere achtergrond */
    .hero h1{
      color:#fff;
      text-shadow:0 2px 4px rgba(0,0,0,.5);
    }
    /* Resultaten */
    .results{padding:0 0 60px;}
    .results-inner{
      max-width:1200px;
      margin:0 auto;
      padding:0 12px;
    }
    .results-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }
    .results-head h2{margin:0;font-size:22px;font-weight:700;color:var(--ink);}
    .results-meta{font-size:13px;color:#576a8e;}
    .results-list{
      display:flex;
      flex-direction:column;
      gap:20px;
    }
    /* Result grouping by category */
    .category-group{margin-top:20px;}
    .category-group h3{
      margin:0 0 8px;
      font-size:18px;
      font-weight:700;
      color:var(--ink);
    }
    .category-group .cards{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .result-card{
      /* Result kaarten krijgen een lichte achtergrond zodat ze contrasteren met de donkere achtergrond */
      background:rgba(255,255,255,.9);
      border:1px solid rgba(255,255,255,.2);
      border-radius:14px;
      box-shadow:0 6px 22px rgba(0,0,0,.2);
      padding:16px 18px 14px;
      text-align:left;
    }
    .result-head {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:6px;
    }
    .result-title {
      font-size:16px;
      font-weight:700;
      margin:0;
      color:var(--ink);
    }
    .result-cat{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(26,102,255,.25);
      background:#fff;
      text-transform:capitalize;
      color:var(--ink);
    }
    .result-body{
      font-size:13px;
      color:#374151;
      margin-bottom:8px;
    }
    .result-body .line{margin:2px 0;}
    .slots-list{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
      padding:0;
      list-style:none;
      font-size:12px;
    }
    .slot-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(26,102,255,.18);
      box-shadow:0 2px 6px rgba(15,23,42,.08);
      white-space:nowrap;
    }
    .slot-pill.volzet{opacity:.6;}
    .slot-pill .date{font-weight:600;}
    .slot-pill .time{font-size:11px;color:#4b5563;}
    .slot-book-btn{
      border:0;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      font-weight:600;
      background:linear-gradient(120deg,var(--o1),var(--o2));
      color:#fff;
      cursor:pointer;
      box-shadow:0 2px 6px rgba(37,99,235,.35);
    }
    /* Footer */
    .site-footer{
      border-top:1px solid var(--line);
      background:rgba(255,255,255,.85);
    }
    .footer-inner{
      max-width:1200px;
      margin:0 auto;
      padding:16px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
      font-size:12px;
      color:#4b5563;
    }
    .footer-nav{display:flex;gap:12px;}
    .footer-nav a{text-decoration:none;color:#244;font-weight:600;}
  </style>
</head>

<body>
  <div class="site">
    <header class="site-header">
      <div class="header-inner">
        <a class="brand" href="/" aria-label="Vrijeplek home">
          <div class="brand-mark">V</div>
          <div class="brand-wordmark">
            <span>vrijeplek</span>
            <span>last minute afspreken</span>
          </div>
        </a>
        <nav class="header-actions">
          <a class="nav-btn" href="/waarom">Waarom Vrijeplek?</a>
          <a class="nav-btn" href="/aanmelden">Word lid</a>
          <a class="nav-btn" href="/login" id="nav-login">Login</a>
          <a class="nav-btn btn-green" href="/dashboard" id="nav-mijn" style="display:none;">Mijn Vrijeplek</a>
        </nav>
      </div>
    </header>
    <main>
      <!-- Categorie knoppen -->
      <section class="cat-dots">
        <div class="container">
          <ul class="cat-dots-row">
            <li><a class="catdot" data-cat="horeca" href="#zoeken" title="Horeca"><img src="img/cat-horeca.jpg" alt="Horeca"><span>Horeca</span></a></li>
            <li><a class="catdot" data-cat="wellness" href="#zoeken" title="Wellness"><img src="img/cat-wellness.jpg" alt="Wellness"><span>Wellness</span></a></li>
            <li><a class="catdot" data-cat="zorg" href="#zoeken" title="Gezondheid"><img src="img/cat-gezondheid.jpg" alt="Gezondheid"><span>Gezondheid</span></a></li>
            <li><a class="catdot" data-cat="events" href="#zoeken" title="Events"><img src="img/cat-events.jpg" alt="Events"><span>Events</span></a></li>
            <li><a class="catdot" data-cat="huishoudhulp" href="#zoeken" title="Huishoudhulp"><img src="img/cat-huishoudhulp.jpg" alt="Huishoudhulp"><span>Huishoudhulp</span></a></li>
            <!-- Extra categorieën zoals in de huidige index -->
            <li><a class="catdot" data-cat="ramenwasser" href="#zoeken" title="Ramenwasser"><img src="img/cat-ramenwasser.jpg" alt="Ramenwasser"><span>Ramenwasser</span></a></li>
            <li><a class="catdot" data-cat="dieren" href="#zoeken" title="Dieren"><img src="img/cat-dieren.jpg" alt="Dieren"><span>Dieren</span></a></li>
            <!-- Nieuw: Bouw & renovatie categorie -->
            <li><a class="catdot" data-cat="bouw" href="#zoeken" title="Bouw & renovatie"><img src="img/cat-bouw.jpg" alt="Bouw & renovatie"><span>Bouw &amp; renovatie</span></a></li>
          </ul>
        </div>
      </section>
      <!-- Zoekformulier -->
      <section class="search-wrap" id="zoeken">
        <form class="search" id="form">
          <div class="field">
            <label for="q">Wat zoek je?</label>
            <input id="q" name="q" type="text" placeholder="Bedrijf, trefwoord…">
          </div>
          <div class="field">
            <label for="loc">Waar?</label>
            <input id="loc" name="loc" type="text" placeholder="Stad, regio…">
          </div>
          <div class="field">
            <label for="from">Vanaf</label>
            <input id="from" name="from" type="date">
          </div>
          <div class="field">
            <label for="to">Tot</label>
            <input id="to" name="to" type="date">
          </div>
          <div class="field">
            <label for="cat">Categorie</label>
            <select id="cat" name="cat">
              <option value="">Alle</option>
              <option value="horeca">Horeca</option>
              <option value="wellness">Wellness</option>
              <option value="zorg">Gezondheid</option>
              <option value="events">Events</option>
              <option value="huishoudhulp">Huishoudhulp</option>
              <option value="ramenwasser">Ramenwasser</option>
              <option value="dieren">Dieren</option>
              <option value="bouw">Bouw &amp; renovatie</option>
            </select>
          </div>
          <div class="field" style="align-self:end;">
            <button type="submit" class="btn-primary">Zoek</button>
          </div>
        </form>
      </section>
      <!-- Resultaten -->
      <section class="results" id="results" hidden>
        <div class="results-inner">
          <div class="results-head">
            <h2 id="results-title">Vrije plekken</h2>
            <div class="results-meta" id="results-meta">&nbsp;</div>
          </div>
          <div id="booking-msg" style="margin-bottom:10px;font-size:13px;color:#14532d;font-weight:600;"></div>
          <div id="results-list" class="results-list"></div>
        </div>
      </section>
    </main>
    <footer class="site-footer">
      <div class="footer-inner">
        <span>© <span id="year"></span> Vrijeplek.be — Last minute afspraken, netjes geregeld.</span>
        <span class="footer-nav">
          <a href="/voorwaarden.html">Algemene voorwaarden</a>
        </span>
      </div>
    </footer>
  </div>

  <script>
    // Vul automatisch het huidige jaar in de footer
    document.getElementById('year').textContent = new Date().getFullYear();

    const form    = document.getElementById('form');
    const qEl     = document.getElementById('q');
    const locEl   = document.getElementById('loc');
    const fromEl  = document.getElementById('from');
    const toEl    = document.getElementById('to');
    const catEl   = document.getElementById('cat');

    const resultsSection = document.getElementById('results');
    const resultsList    = document.getElementById('results-list');
    const resultsTitle   = document.getElementById('results-title');
    const resultsMeta    = document.getElementById('results-meta');
    const bookingMsg     = document.getElementById('booking-msg');

    // Escape HTML to prevent injection
    function escapeHtml(str){
      return (str || '').replace(/[&<>"']/g, m => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
      }[m]));
    }

    // Format ISO date as NL (e.g. "ma 03 jan")
    function formatDateNL(iso){
      try{
        return new Date(iso+'T00:00:00').toLocaleDateString('nl-BE', {
          weekday:'short', day:'2-digit', month:'short'
        });
      }catch{
        return iso;
      }
    }

    // Handle form submission and fetch results
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const q    = qEl.value.trim();
      const loc  = locEl.value.trim();
      const from = fromEl.value || '';
      const to   = toEl.value || '';
      const cat  = catEl.value || '';

      resultsSection.hidden = false;
      resultsTitle.textContent = 'Vrije plekken';
      resultsMeta.textContent  = 'Zoeken…';
      bookingMsg.textContent   = '';
      resultsList.innerHTML    = '';

      try{
        const r = await fetch('/.netlify/functions/search', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ q, loc, from, to, cat })
        });
        const data = await r.json().catch(()=>[]);
        if(!Array.isArray(data) || !data.length){
          resultsMeta.textContent = 'Geen vrije plekken gevonden met deze filters.';
          resultsList.innerHTML = '';
          return;
        }
        // Groepeer resultaten op categorie, zodat elke categorie apart wordt getoond
        const groups = {};
        data.forEach(item => {
          const catKey = item.cat || 'Onbekend';
          if(!groups[catKey]) groups[catKey] = [];
          groups[catKey].push(item);
        });
        // Toon het aantal gevonden zaken
        resultsMeta.textContent = `${data.length} zaak/zaak(-en) met vrije momenten gevonden`;
        resultsList.innerHTML = '';
        Object.keys(groups).sort().forEach(catName => {
          const section = document.createElement('div');
          section.className = 'category-group';
          section.innerHTML = `<h3>${escapeHtml(catName)}</h3>`;
          const cardsContainer = document.createElement('div');
          cardsContainer.className = 'cards';
          groups[catName].forEach(item => {
            const card = document.createElement('article');
            card.className = 'result-card';
            const title     = escapeHtml(item.zaak || item.email || 'Onbekend');
            const catLabel  = item.cat ? escapeHtml(item.cat) : 'Onbekend';
            const addrParts = [];
            if(item.straat) addrParts.push(escapeHtml(item.straat));
            if(item.postcode) addrParts.push(escapeHtml(item.postcode));
            const addr = addrParts.join(' • ');
            const bio  = item.bio ? escapeHtml(item.bio) : '';
            const depositEnabled = !!item.deposit_enabled && Number(item.deposit_amount) > 0;
            const depositAmount  = depositEnabled ? Number(item.deposit_amount) : 0;
            const depositLabel   = depositEnabled ? `Voorschot €${depositAmount.toFixed(0)}` : 'Geen voorschot';
            // Card head
            const head = document.createElement('div');
            head.className = 'result-head';
            head.innerHTML = `<h3 class="result-title">${title}</h3><span class="result-cat">${catLabel}</span>`;
            // Card body
            const body = document.createElement('div');
            body.className = 'result-body';
            body.innerHTML = `
              ${addr ? `<div class="line">${addr}</div>` : ``}
              ${bio ? `<div class="line">${bio}</div>` : ``}
              <div class="line" style="font-size:11px;color:#6b7280;">${depositLabel}</div>
            `;
            // Slots list
            const ul = document.createElement('ul');
            ul.className = 'slots-list';
            const slots = (item.slots || []).slice(0,12);
            if(!slots.length){
              ul.innerHTML = `<li class="slot-pill"><span class="time">Geen vrije momenten in deze periode.</span></li>`;
            }else{
              slots.forEach(s => {
                const li = document.createElement('li');
                li.className = 'slot-pill';
                li.dataset.slotId = s.id;
                li.dataset.depositEnabled = depositEnabled ? '1' : '0';
                li.dataset.depositAmount  = depositAmount ? String(depositAmount) : '0';
                const dateSpan = document.createElement('span');
                dateSpan.className = 'date';
                dateSpan.textContent = formatDateNL(s.date);
                const timeSpan = document.createElement('span');
                timeSpan.className = 'time';
                timeSpan.textContent = `${s.from || ''} – ${s.to || ''}`;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'slot-book-btn';
                btn.textContent = 'Boek nu';
                btn.dataset.slotId = s.id;
                // Bewaar deposit info op de button
                btn.dataset.depositEnabled = depositEnabled ? '1' : '0';
                btn.dataset.depositAmount  = depositAmount ? String(depositAmount) : '0';
                li.appendChild(dateSpan);
                li.appendChild(timeSpan);
                li.appendChild(btn);
                ul.appendChild(li);
              });
            }
            card.appendChild(head);
            card.appendChild(body);
            card.appendChild(ul);
            cardsContainer.appendChild(card);
          });
          section.appendChild(cardsContainer);
          resultsList.appendChild(section);
        });
      }catch(err){
        resultsMeta.textContent = 'Zoeken mislukt (server).';
        resultsList.innerHTML = '';
        console.error(err);
      }
    });

    // Handelt het boeken van een tijdslot af, inclusief voorschotbetaling
    async function handleBook(btn){
      const pill = btn.closest('.slot-pill');
      if(!pill || pill.classList.contains('volzet')) return;
      const slotId = btn.dataset.slotId;
      if(!slotId) return;
      const depositEnabled = btn.dataset.depositEnabled === '1';
      const depositAmount  = Number(btn.dataset.depositAmount || '0');
      bookingMsg.textContent = depositEnabled
        ? `We bereiden je voorschotbetaling van €${depositAmount.toFixed(0)} voor…`
        : 'Je boeking wordt aangemaakt…';
      btn.disabled = true;
      try{
        // Vraag e-mailadres op via Supabase sessie of prompt
        let customerEmail = '';
        let customerName  = '';
        try{
          const { data: { session } } = await supabase.auth.getSession();
          if(session?.user){
            customerEmail = session.user.email || '';
            customerName  = session.user.user_metadata?.full_name || session.user.user_metadata?.name || '';
          }
        }catch{}
        if(!customerEmail){
          customerEmail = prompt('Voer je e-mailadres in voor de boeking:');
          if(!customerEmail || !customerEmail.trim()){
            bookingMsg.textContent = 'E-mailadres is verplicht voor boeking.';
            btn.disabled = false;
            return;
          }
        }
        // Stuur een request naar de server om een deposit/booking te maken
        const res = await fetch('/.netlify/functions/create-deposit', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({
            slotId: slotId,
            customer_email: customerEmail.trim().toLowerCase(),
            customer_name: customerName.trim()
          })
        });
        const data = await res.json().catch(()=>null);
        if(!res.ok || !data){
          bookingMsg.textContent = 'Boeking mislukt (server).';
          btn.disabled = false;
          return;
        }
        if(data.error){
          bookingMsg.textContent = data.error;
          btn.disabled = false;
          return;
        }
        if(data.url){
          bookingMsg.textContent = 'Je wordt doorgestuurd naar de betaalpagina…';
          window.location.href = data.url;
          return;
        }
        if(data.ok){
          bookingMsg.textContent = 'Tijdslot geboekt. Je ontvangt een bevestiging.';
          pill.classList.add('volzet');
          btn.textContent = 'Volzet';
          return;
        }
      }catch(err){
        bookingMsg.textContent = 'Boeking mislukt (client).';
        console.error(err);
      }finally{
        btn.disabled = false;
      }
    }
    // Eventdelegatie voor alle boekknoppen
    resultsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('.slot-book-btn');
      if(btn) handleBook(btn);
    });
  </script>
</body>
</html>
