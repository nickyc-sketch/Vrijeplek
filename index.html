const Stripe = require('stripe');
const { createClient } = require('@supabase/supabase-js');

const stripe = Stripe(process.env.STRIPE_SECRET_KEY);
const supa = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

exports.handler = async (event) => {
  if (event.httpMethod !== 'POST') {
    return { statusCode:405, body:'Method not allowed' };
  }

  let payload;
  try{
    payload = JSON.parse(event.body || '{}');
  }catch{
    return { statusCode:400, body:JSON.stringify({ error:'invalid_body' }) };
  }

  const slotId = payload.slot_id;
  if (!slotId) {
    return { statusCode:400, body:JSON.stringify({ error:'missing_slot_id' }) };
  }

  // 1. Haal slot + profiel op
  const { data: rows, error } = await supa
    .from('slots')
    .select(`
      id, date, from, to, status, email,
      profiles:profiles!inner (
        email,
        zaak,
        deposit_enabled,
        deposit_amount
      )
    `)
    .eq('id', slotId)
    .limit(1);

  if (error || !rows || !rows.length) {
    console.error(error);
    return { statusCode:404, body:JSON.stringify({ error:'slot_not_found' }) };
  }

  const slot = rows[0];
  const profile = slot.profiles;

  if (slot.status !== 'open') {
    return { statusCode:409, body:JSON.stringify({ error:'slot_not_open' }) };
  }

  const depositEnabled = !!profile.deposit_enabled && Number(profile.deposit_amount) > 0;
  const depositAmount  = depositEnabled ? Number(profile.deposit_amount) : 0;

  // 2. Als geen voorschot: gewoon slot op "booked" zetten
  if (!depositEnabled) {
    const { error: updateErr } = await supa
      .from('slots')
      .update({ status:'booked', booked_at:new Date().toISOString() })
      .eq('id', slot.id);

    if (updateErr) {
      console.error(updateErr);
      return { statusCode:500, body:JSON.stringify({ error:'book_update_failed' }) };
    }

    return { statusCode:200, body:JSON.stringify({ ok:true }) };
  }

  // 3. Met voorschot: Stripe Checkout aanmaken
  try{
    const session = await stripe.checkout.sessions.create({
      mode: 'payment',
      payment_method_types: ['card'],
      line_items: [{
        quantity: 1,
        price_data: {
          currency: 'eur',
          unit_amount: Math.round(depositAmount * 100),
          product_data: {
            name: `Voorschot ${profile.zaak} (${slot.date} ${slot.from}-${slot.to})`
          }
        }
      }],
      success_url: `${process.env.FRONTEND_BASE_URL}/success.html?slot=${slot.id}`,
      cancel_url: `${process.env.FRONTEND_BASE_URL}/cancel.html`,
      metadata: {
        slot_id: slot.id,
        zaak: profile.zaak || '',
        email: profile.email || ''
      }
    });

    return {
      statusCode:200,
      body:JSON.stringify({ checkout_url: session.url })
    };
  }catch(err){
    console.error(err);
    return { statusCode:500, body:JSON.stringify({ error:'stripe_failed' }) };
  }
};
