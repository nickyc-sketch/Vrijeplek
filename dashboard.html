  <script src="/js/config.js?v=2"></script>
  <script>
    console.log('Dashboard script loading...');
    const urlParams = new URLSearchParams(window.location.search);
    let dashboardEmail = urlParams.get('email')
      ? decodeURIComponent(urlParams.get('email'))
      : null;

    if (!dashboardEmail) {
      const stored = localStorage.getItem('vp_email');
      if (stored) dashboardEmail = stored;
    }
    if (dashboardEmail) {
      localStorage.setItem('vp_email', dashboardEmail);
    }

    const API_SLOTS   = '/.netlify/functions/slots';
    const API_PROFILE = '/.netlify/functions/profile';
    const API_FLEXJOBS = '/.netlify/functions/flexijobs';

    window.vpProfileReady = window.vpProfileReady || false;

    function formatDateKey(date){
      const d = new Date(date.getTime());
      d.setHours(0,0,0,0);
      return d.toISOString().slice(0,10);
    }

    function showToast(message, type = 'success'){
      const toast = document.getElementById('vp-toast');
      if(!toast) return;
      const icon = toast.querySelector('.toast-icon');
      const text = toast.querySelector('.toast-text');

      text.textContent = message;
      toast.classList.remove('toast-success','toast-error','is-visible');
      toast.style.display = 'flex';

      if(type === 'error'){
        toast.classList.add('toast-error');
        if(icon) icon.textContent = '!';
      }else{
        toast.classList.add('toast-success');
        if(icon) icon.textContent = '✓';
      }

      requestAnimationFrame(() => {
        toast.classList.add('is-visible');
      });

      setTimeout(() => {
        toast.classList.remove('is-visible');
      }, 3200);
    }

    async function fetchSlotsForDate(dateKey){
      const url = new URL(API_SLOTS, window.location.origin);
      url.searchParams.set('date', dateKey);
      if (dashboardEmail) {
        url.searchParams.set('email', dashboardEmail);
      }

      const res = await fetch(url.toString(), {
        method: 'GET',
        credentials: 'include'
      });

      if (!res.ok) {
        const text = await res.text().catch(() => 'Kon de tijdstippen niet laden.');
        throw new Error(text);
      }

      return res.json();
    }

    async function createSlot(payload){
      const res = await fetch(API_SLOTS, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        let errorData;
        try {
          errorData = await res.json();
        } catch {
          const text = await res.text();
          errorData = { error: text };
        }
        throw new Error(
          errorData.error || errorData.details || 'Tijdslot kon niet worden opgeslagen'
        );
      }

      return res.json();
    }

    async function updateSlot(payload){
      const res = await fetch(API_SLOTS, {
        method:'PUT',
        headers:{ 'Content-Type':'application/json' },
        credentials:'include',
        body:JSON.stringify(payload)
      });
      if(!res.ok){
        throw new Error(await res.text());
      }
      return res.json();
    }

    async function deleteSlot(id){
      const url = new URL(API_SLOTS, window.location.origin);
      url.searchParams.set('id', id);
      const res = await fetch(url.toString(), {
        method:'DELETE',
        credentials:'include'
      });
      if(!res.ok){
        throw new Error(await res.text());
      }
      try{
        return await res.json();
      }catch{
        return null;
      }
    }

    function renderSlotList(slotArray, slotListEl, slotEmptyEl){
      if(!slotListEl || !slotEmptyEl) return;
      if(!slotArray || !slotArray.length){
        slotListEl.innerHTML = '';
        slotListEl.style.display = 'none';
        slotEmptyEl.style.display = 'block';
        return;
      }

      slotEmptyEl.style.display = 'none';
      slotListEl.style.display = 'block';

      const uniqueSlots = [];
      const seenKeys = new Set();
      if (Array.isArray(slotArray)) {
        slotArray.forEach(item => {
          const startKey = item.start_time || item.start || '';
          const endKey   = item.end_time || item.end || '';
          const descKey  = item.description || item.desc || '';
          const key = `${startKey}|${endKey}|${descKey}`;
          if (!seenKeys.has(key)) {
            seenKeys.add(key);
            uniqueSlots.push(item);
          }
        });
      }

      const rows = uniqueSlots.map(item => {
        const start = item.start_time || item.start || '';
        const end = item.end_time || item.end || '';
        const desc = item.description || item.desc || 'Geen omschrijving';
        const places = item.places || item.places_count || 1;
        const visible = typeof item.visible === 'boolean' ? item.visible : true;
        const depositRequired = !!(item.deposit_required || item.with_deposit);
        const visibleText = visible ? 'Zichtbaar op Vrijeplek' : 'Verborgen';
        const depositAmount = item.deposit_amount || item.depositAmount || null;
        const depositText = depositRequired ? (depositAmount ? `Voorschot: €${depositAmount}` : 'Voorschot actief') : 'Geen voorschot';
        const booked = !!(item.is_booked || item.booked || item.status === 'Geboekt' || item.status === 'Bezet');
        const bookedLabel = booked ? 'Geboekt • niet meer wijzigbaar (server beslist)' : `${places} plaats(en) • ${visibleText} • ${depositText}`;
        const editDisabled = booked ? 'disabled aria-disabled="true"' : '';
        const idAttr = item.id || item.slot_id || '';

        return `
          <div class="slot-item ${booked ? 'is-booked' : ''}" data-slot-id="${idAttr}">
            <div class="slot-item-header">
              <div>
                <div class="slot-item-title">${start} – ${end}</div>
                <div class="slot-item-desc">${desc}</div>
                <div class="slot-meta">${bookedLabel}</div>
              </div>
            </div>
            <div class="slot-actions">
              <button type="button" class="btn-ghost btn-small" data-slot-edit="${idAttr}" ${editDisabled}>
                Aanpassen
              </button>
              <button type="button" class="btn-ghost btn-small btn-danger" data-slot-delete="${idAttr}" ${editDisabled}>
                Verwijderen
              </button>
            </div>
          </div>
        `;
      });

      slotListEl.innerHTML = rows.join('');
    }

    async function fetchProfile(){
      if (!dashboardEmail) {
        return null;
      }

      const url = new URL(API_PROFILE, window.location.origin);
      url.searchParams.set('email', dashboardEmail);

      const res = await fetch(url.toString(), {
        method: 'GET',
        credentials: 'include'
      });

      if (res.status === 404) {
        return null;
      }
      if (!res.ok) {
        throw new Error(await res.text());
      }
      return res.json();
    }

    async function saveProfile(payload){
      if (!dashboardEmail) {
        throw new Error('Geen e-mailadres gevonden');
      }

      const profilePayload = {
        email: dashboardEmail,
        ...payload
      };

      const res = await fetch(API_PROFILE, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(profilePayload)
      });

      if (!res.ok) {
        let errorData;

        try {
          errorData = await res.json();
        } catch {
          const text = await res.text();
          errorData = { error: text };
        }

        throw new Error(
          errorData.error ||
          errorData.details ||
          'Failed to save profile'
        );
      }

      return res.json();
    }

    function computeProfileReadyFromDom(){
      const requiredIds = [
        'company-name',
        'contact-name',
        'billing-email',
        'phone',
        'vat-number',
        'business-street',
        'business-postcode',
        'business-city'
      ];
      for(const id of requiredIds){
        const el = document.getElementById(id);
        if(!el || !el.value || !el.value.trim()){
          return false;
        }
      }
      const depositToggle = document.getElementById('deposit-enabled');
      if (depositToggle && depositToggle.checked) {
        const iban = document.getElementById('iban');
        const depAmount = document.getElementById('deposit-amount');
        if (!iban || !iban.value.trim()) return false;
        if (!depAmount || !depAmount.value.trim() || Number(depAmount.value) <= 0) return false;
      }
      return true;
    }

    function updateFeatureLockUI(){
      window.vpProfileReady = !!computeProfileReadyFromDom();
      // Alleen FLEXIJOBS nog locken, kalender (tijden) is altijd toegankelijk
      const needsProfileTabs = document.querySelectorAll('.dash-tab[data-panel="flexijobs"]');
      needsProfileTabs.forEach(tab=>{
        if(window.vpProfileReady){
          tab.classList.remove('is-locked');
          tab.removeAttribute('title');
        }else{
          tab.classList.add('is-locked');
          tab.setAttribute('title','Vul eerst je bedrijfs- en locatiegegevens in bij Instellingen.');
        }
      });
    }

    function applyProfileToForm(profile){
      if(!profile) {
        updateFeatureLockUI();
        return;
      }
      const byId = (id) => document.getElementById(id);

      if(byId('company-name'))  byId('company-name').value  = profile.company_name || profile.zaak || '';
      if(byId('contact-name'))  byId('contact-name').value  = profile.contact_name || '';
      if(byId('billing-email')) byId('billing-email').value = profile.billing_email || '';
      if(byId('phone'))         byId('phone').value         = profile.phone || profile.telefoon || '';
      if(byId('vat-number'))    byId('vat-number').value    = profile.vat_number || profile.btw || '';
      if(byId('invoice-note'))  byId('invoice-note').value  = profile.invoice_note || profile.deposit_note || '';
      if(byId('iban'))          byId('iban').value          = profile.iban || profile.bank_iban || '';
      if(byId('bic'))           byId('bic').value           = profile.bic || '';
      if(byId('deposit-amount'))byId('deposit-amount').value= profile.deposit_amount ?? '';
      if(byId('extra-footer'))  byId('extra-footer').value  = profile.extra_footer || '';

      if(byId('business-street'))   byId('business-street').value   = profile.business_street || profile.straat || '';
      if(byId('business-postcode')) byId('business-postcode').value = profile.business_postcode || profile.postcode || '';
      if(byId('business-city'))     byId('business-city').value     = profile.business_city || profile.plaats || profile.gemeente || '';

      const depositEnabledInput = document.getElementById('deposit-enabled');
      if(depositEnabledInput){
        depositEnabledInput.checked = !!profile.deposit_enabled;
        const event = new Event('change');
        depositEnabledInput.dispatchEvent(event);
      }

      const googleReviewEnabledInput = document.getElementById('google-review-enabled');
      if(googleReviewEnabledInput) {
        googleReviewEnabledInput.checked = !!profile.google_review_enabled;
        const event = new Event('change');
        googleReviewEnabledInput.dispatchEvent(event);
      }
      if(byId('google-review-url')) {
        byId('google-review-url').value = profile.google_review_url || '';
      }

      const shareLocationEnabledInput = document.getElementById('share-location-enabled');
      if(shareLocationEnabledInput) {
        shareLocationEnabledInput.checked = !!profile.share_location_enabled;
      }

      const status = document.getElementById('settings-status');
      if(status){
        status.textContent = 'Instellingen opgeslagen';
        status.style.background = 'rgba(22,163,74,.18)';
        status.style.borderColor = 'rgba(34,197,94,.7)';
        status.style.color = '#bbf7d0';
      }

      const flexContactName = document.getElementById('flex-contact-name');
      if (flexContactName && !flexContactName.value) {
        flexContactName.value = profile.contact_name || '';
      }
      const flexContactEmail = document.getElementById('flex-contact-email');
      if (flexContactEmail && !flexContactEmail.value) {
        flexContactEmail.value = profile.billing_email || dashboardEmail || '';
      }
      const flexContactPhone = document.getElementById('flex-contact-phone');
      if (flexContactPhone && !flexContactPhone.value) {
        flexContactPhone.value = profile.phone || '';
      }

      updateFeatureLockUI();
    }

    function collectSettingsPayload(){
      const getVal = (id) => {
        const el = document.getElementById(id);
        return el ? el.value.trim() : '';
      };
      const getNumber = (id) => {
        const el = document.getElementById(id);
        if(!el) return null;
        const v = el.value.trim();
        if(!v) return null;
        const n = Number(v);
        return Number.isNaN(n) ? null : n;
      };
      const getChecked = (id) => {
        const el = document.getElementById(id);
        return el ? !!el.checked : false;
      };

      return {
        company_name:   getVal('company-name'),
        contact_name:   getVal('contact-name'),
        billing_email:  getVal('billing-email'),
        phone:          getVal('phone'),
        vat_number:     getVal('vat-number'),
        invoice_note:   getVal('invoice-note'),
        deposit_enabled:getChecked('deposit-enabled'),
        iban:           getVal('iban'),
        bic:            getVal('bic'),
        deposit_amount: getNumber('deposit-amount'),
        extra_footer:   getVal('extra-footer'),
        google_review_enabled: getChecked('google-review-enabled'),
        google_review_url: getVal('google-review-url'),
        share_location_enabled: getChecked('share-location-enabled'),
        business_street:   getVal('business-street'),
        business_postcode: getVal('business-postcode'),
        business_city:     getVal('business-city')
      };
    }

    function handleTabClick(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
      }
      
      const tab = e ? e.currentTarget : this;
      const target = tab.getAttribute('data-panel');
      
      if (!target) {
        console.error('Tab has no data-panel attribute');
        return;
      }
      
      console.log('=== TAB CLICKED ===', target);

      // Kalender (tijden) is altijd vrij. Alleen Flexijobs blijft gelockt.
      if (target === 'flexijobs' && !window.vpProfileReady) {
        showToast('Vul eerst je bedrijfs- en locatiegegevens in bij Instellingen.','error');
        const settingsTab = document.querySelector('.dash-tab[data-panel="instellingen"]');
        if (settingsTab) {
          document.querySelectorAll('.dash-tab').forEach(t => t.classList.remove('is-active'));
          settingsTab.classList.add('is-active');
          document.querySelectorAll('.dash-panel').forEach(panel => {
            panel.classList.remove('is-visible');
          });
          const settingsPanel = document.getElementById('panel-instellingen');
          if (settingsPanel) settingsPanel.classList.add('is-visible');
        }
        return false;
      }
      
      document.querySelectorAll('.dash-tab').forEach(t => {
        t.classList.remove('is-active');
      });
      tab.classList.add('is-active');
      
      document.querySelectorAll('.dash-panel').forEach(panel => {
        if (panel.id === `panel-${target}`) {
          panel.classList.add('is-visible');
          console.log('Showing panel:', panel.id);
        } else {
          panel.classList.remove('is-visible');
        }
      });
      
      return false;
    }
    
    document.addEventListener('click', function(e) {
      const tab = e.target.closest('.dash-tab');
      if (tab && !tab.hasAttribute('data-handled')) {
        tab.setAttribute('data-handled', 'true');
        console.log('Event delegation caught tab click:', tab.getAttribute('data-panel'));
        handleTabClick.call(tab, e);
        setTimeout(() => tab.removeAttribute('data-handled'), 100);
      }
    }, false);

    function initDashboard() {
      console.log('=== DASHBOARD INIT START ===');
      
      if (!document.body) {
        console.error('Document body not ready');
        setTimeout(initDashboard, 100);
        return;
      }

      const yearSpan = document.getElementById('year-span');
      if(yearSpan){
        yearSpan.textContent = new Date().getFullYear();
      }

      const tabs = document.querySelectorAll('.dash-tab');
      console.log('Found tabs:', tabs.length);
      
      if (tabs.length === 0) {
        console.error('NO TABS FOUND! Retrying in 200ms...');
        setTimeout(initDashboard, 200);
        return;
      }
      
      tabs.forEach(tab => {
        tab.addEventListener('click', handleTabClick);
      });

      document.querySelectorAll('[data-panel-jump="tijden"]').forEach(btn => {
        btn.style.cssText = 'cursor: pointer !important; pointer-events: auto !important;';
        btn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          const targetTab = document.querySelector('.dash-tab[data-panel="tijden"]');
          if (targetTab) {
            targetTab.click();
          }
        };
        btn.addEventListener('click', btn.onclick, false);
      });

      const depositToggle = document.getElementById('deposit-enabled');
      const depositBlock = document.querySelector('[data-deposit-block]');
      if (depositToggle && depositBlock) {
        const updateDepositState = () => {
          if (depositToggle.checked) {
            depositBlock.classList.remove('is-disabled');
          } else {
            depositBlock.classList.add('is-disabled');
          }
          updateFeatureLockUI();
        };
        depositToggle.addEventListener('change', updateDepositState);
        updateDepositState();
      }

      const slotForm   = document.getElementById('slot-form');
      const slotList   = document.getElementById('slot-list');
      const slotEmpty  = document.getElementById('slot-empty');
      const slotStart  = document.getElementById('slot-start');
      const slotEnd    = document.getElementById('slot-end');
      const slotPlaces = document.getElementById('slot-places');
      const slotDesc   = document.getElementById('slot-desc');
      const slotVisible= document.getElementById('slot-visible');
      const slotDeposit= document.getElementById('slot-deposit');
      const slotSubmitBtn = document.getElementById('slot-submit-btn');

      const googleReviewToggle = document.getElementById('google-review-enabled');
      const googleReviewField = document.getElementById('google-review-field');

      const slotDepositAmount = document.getElementById('slot-deposit-amount');
      const slotDepositCustom = document.getElementById('slot-deposit-custom');
      const slotDepositGroup = document.querySelector('.slot-deposit-amount');

      if (slotDeposit && slotDepositGroup) {
        slotDeposit.addEventListener('change', () => {
          if (slotDeposit.checked) {
            slotDepositGroup.style.display = 'block';
          } else {
            slotDepositGroup.style.display = 'none';
            if (slotDepositAmount) slotDepositAmount.value = '';
            if (slotDepositCustom) {
              slotDepositCustom.value = '';
              slotDepositCustom.style.display = 'none';
            }
          }
        });
      }
      if (slotDepositAmount && slotDepositCustom) {
        slotDepositAmount.addEventListener('change', () => {
          if (slotDepositAmount.value === 'custom') {
            slotDepositCustom.style.display = 'block';
          } else {
            slotDepositCustom.style.display = 'none';
          }
        });
      }

      if (googleReviewToggle && googleReviewField) {
        const updateGoogleReviewVisibility = () => {
          googleReviewField.style.display = googleReviewToggle.checked ? 'block' : 'none';
        };
        googleReviewToggle.addEventListener('change', updateGoogleReviewVisibility);
        updateGoogleReviewVisibility();
      }

      const grid = document.querySelector('[data-cal-grid]');
      const monthLabel = document.querySelector('[data-cal-month]');
      const yearLabel = document.querySelector('[data-cal-year]');
      const selectedLabel = document.querySelector('[data-selected-date]');
      const selectedShort = document.querySelector('[data-selected-date-short]');

      let current = new Date();
      current.setDate(1);
      let selected = new Date();
      selected.setHours(0,0,0,0);

      const slotsCache = {};
      let editingSlotId = null;

      const monthNames = [
        'januari','februari','maart','april','mei','juni',
        'juli','augustus','september','oktober','november','december'
      ];
      const weekdayNames = [
        'maandag','dinsdag','woensdag','donderdag','vrijdag','zaterdag','zondag'
      ];

      function updateSelectedLabels(){
        if (!selected) {
          if(selectedLabel) selectedLabel.textContent = 'geen datum geselecteerd';
          if(selectedShort) selectedShort.textContent = '–';
          return;
        }
        const d = selected.getDate();
        const m = selected.getMonth();
        const weekdayIndex = (selected.getDay() + 6) % 7;
        let long = `${weekdayNames[weekdayIndex]} ${d} ${monthNames[m]}`;
        long = long.charAt(0).toUpperCase() + long.slice(1);

        if(selectedLabel){
          selectedLabel.textContent = long;
        }
        if(selectedShort){
          selectedShort.textContent = selected.toLocaleDateString('nl-BE', {
            day:'2-digit', month:'2-digit', year:'numeric'
          });
        }
      }

      function wireSlotButtonsForDate(dateKey){
        if(!slotList) return;
        const slotArray = slotsCache[dateKey] || [];

        slotList.querySelectorAll('[data-slot-edit]').forEach(btn => {
          const id = btn.getAttribute('data-slot-edit');
          const slot = slotArray.find(s => (s.id || s.slot_id) === id);
          if(!slot) return;

          btn.addEventListener('click', () => {
            editingSlotId = id;
            slotStart.value  = slot.start_time || slot.start || '';
            slotEnd.value    = slot.end_time || slot.end || '';
            slotPlaces.value = slot.places || slot.places_count || 1;
            slotDesc.value   = slot.description || slot.desc || '';
            slotVisible.checked = typeof slot.visible === 'boolean' ? slot.visible : true;
            if(slotDeposit){
              const hasDeposit = !!(slot.deposit_required || slot.with_deposit);
              slotDeposit.checked = hasDeposit;
              if (slotDepositGroup) {
                slotDepositGroup.style.display = hasDeposit ? 'block' : 'none';
              }
              if (slotDepositAmount) {
                const depAmount = slot.deposit_amount || slot.depositAmount || null;
                if (depAmount) {
                  slotDepositAmount.value = String(depAmount);
                } else {
                  slotDepositAmount.value = '';
                }
              }
              if (slotDepositCustom) {
                slotDepositCustom.value = '';
                slotDepositCustom.style.display = 'none';
              }
            }
            if(slotSubmitBtn){
              slotSubmitBtn.textContent = 'Tijdslot bijwerken';
            }
            showToast('Tijdslot geladen om aan te passen','success');
            slotForm.scrollIntoView({behavior:'smooth', block:'start'});
          });
        });

        slotList.querySelectorAll('[data-slot-delete]').forEach(btn => {
          const id = btn.getAttribute('data-slot-delete');
          const slot = slotArray.find(s => (s.id || s.slot_id) === id);
          if(!slot) return;

          btn.addEventListener('click', async () => {
            if(btn.disabled) return;
            const ok = confirm('Weet je zeker dat je dit tijdslot wil verwijderen? Als het al geboekt is, kan de server dit weigeren.');
            if(!ok) return;
            try{
              await deleteSlot(id);
              showToast('Tijdslot verwijderd','success');
              await loadSlotsForSelectedDate();
              await loadAppointments();
            }catch(err){
              console.error(err);
              showToast('Verwijderen mislukt: ' + (err.message || err),'error');
            }
          });
        });
      }

      async function loadSlotsForSelectedDate(){
        if(!grid || !selected) return;
        const key = formatDateKey(selected);
        try{
          const data = await fetchSlotsForDate(key);
          slotsCache[key] = data || [];
          renderSlotList(slotsCache[key], slotList, slotEmpty);
          wireSlotButtonsForDate(key);
        }catch(err){
          console.error(err);
          showToast('Kon de tijdstippen niet laden: ' + (err.message || err),'error');
        }
      }

      // NIEUW: afspraken-tab vullen met open/geboekte slots voor komende dagen
      async function loadAppointments(){
        const appointmentsList = document.getElementById('appointments-list');
        const appointmentsEmpty = document.getElementById('appointments-empty');
        if (!appointmentsList || !appointmentsEmpty) return;

        const today = new Date();
        today.setHours(0,0,0,0);
        const daysAhead = 14; // vandaag + 13 dagen

        const groups = [];

        for (let i = 0; i < daysAhead; i++) {
          const d = new Date(today.getTime());
          d.setDate(today.getDate() + i);
          const dateKey = formatDateKey(d);
          try {
            const data = await fetchSlotsForDate(dateKey);
            if (Array.isArray(data) && data.length) {
              slotsCache[dateKey] = data;
              groups.push({ date: d, dateKey, slots: data });
            }
          } catch (err) {
            console.error('Kon slots voor afspraken niet laden:', dateKey, err);
          }
        }

        if (!groups.length) {
          appointmentsList.style.display = 'none';
          appointmentsEmpty.style.display = 'block';
          appointmentsList.innerHTML = '';
          return;
        }

        appointmentsEmpty.style.display = 'none';
        appointmentsList.style.display = 'block';

        const htmlParts = groups.map(group => {
          const d = group.date;
          let dateLabel = d.toLocaleDateString('nl-BE', {
            weekday: 'long',
            day: '2-digit',
            month: 'long'
          });
          dateLabel = dateLabel.charAt(0).toUpperCase() + dateLabel.slice(1);

          const slotsHtml = group.slots.map(item => {
            const start = item.start_time || item.start || '';
            const end = item.end_time || item.end || '';
            const desc = item.description || item.desc || 'Geen omschrijving';
            const booked = !!(item.is_booked || item.booked || item.status === 'Geboekt' || item.status === 'Bezet');
            const statusLabel = booked ? 'Geboekt' : 'Open';

            return `
              <div class="slot-item ${booked ? 'is-booked' : ''}">
                <div class="slot-item-header">
                  <div>
                    <div class="slot-item-title">${start} – ${end}</div>
                    <div class="slot-item-desc">${desc}</div>
                    <div class="slot-meta">Status: <strong>${statusLabel}</strong></div>
                  </div>
                </div>
              </div>
            `;
          }).join('');

          return `
            <section class="slot-list-day">
              <h3>${dateLabel}</h3>
              ${slotsHtml}
            </section>
          `;
        });

        appointmentsList.innerHTML = htmlParts.join('');
      }

      function renderCalendar(){
        if(!grid) return;
        const year = current.getFullYear();
        const month = current.getMonth();
        if(monthLabel){
          monthLabel.textContent = monthNames[month][0].toUpperCase() + monthNames[month].slice(1);
        }
        if(yearLabel){
          yearLabel.textContent = year;
        }

        grid.innerHTML = '';
        const firstDay = new Date(year, month, 1);
        const startWeekday = (firstDay.getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        today.setHours(0,0,0,0);

        for (let i = 0; i < startWeekday; i++) {
          const pad = document.createElement('div');
          grid.appendChild(pad);
        }

        for (let d = 1; d <= daysInMonth; d++) {
          const date = new Date(year, month, d);
          date.setHours(0,0,0,0);
          const cell = document.createElement('button');
          cell.type = 'button';
          cell.className = 'calendar-day';
          cell.textContent = d;

          if (date.getTime() === today.getTime()) {
            cell.classList.add('is-today');
          }
          if (selected && date.getTime() === selected.getTime()) {
            cell.classList.add('is-selected');
          }

          cell.addEventListener('click', async () => {
            selected = date;
            updateSelectedLabels();
            renderCalendar();
            await loadSlotsForSelectedDate();
            await loadAppointments();
          });

          grid.appendChild(cell);
        }
      }

      document.querySelector('[data-cal-prev]')?.addEventListener('click', () => {
        current.setMonth(current.getMonth() - 1);
        renderCalendar();
      });
      document.querySelector('[data-cal-next]')?.addEventListener('click', () => {
        current.setMonth(current.getMonth() + 1);
        renderCalendar();
      });
      document.querySelector('[data-cal-today]')?.addEventListener('click', async () => {
        current = new Date();
        current.setDate(1);
        selected = new Date();
        selected.setHours(0,0,0,0);
        updateSelectedLabels();
        renderCalendar();
        await loadSlotsForSelectedDate();
        await loadAppointments();
      });

      if(slotForm){
        slotForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          // PROFIEL NIET MEER NODIG OM TIJDSLOT AAN TE MAKEN
          if(!selected){
            showToast('Kies eerst een datum in de kalender.','error');
            return;
          }

          const startVal  = slotStart.value;
          const endVal    = slotEnd.value;
          const descVal   = slotDesc.value.trim();
          const placesVal = slotPlaces.value ? parseInt(slotPlaces.value, 10) : 1;
          const visibleVal= !!slotVisible.checked;
          const depositPerSlot = slotDeposit ? !!slotDeposit.checked : false;

          let depositAmountVal = null;
          if (depositPerSlot) {
            if (slotDepositAmount && slotDepositAmount.value && slotDepositAmount.value !== 'custom') {
              const n = parseInt(slotDepositAmount.value, 10);
              if (!Number.isNaN(n)) depositAmountVal = n;
            } else if (slotDepositCustom && slotDepositCustom.value) {
              const n = parseInt(slotDepositCustom.value, 10);
              if (!Number.isNaN(n)) depositAmountVal = n;
            }
          }

          if(!startVal || !endVal){
            showToast('Vul minstens een start- en einduur in.','error');
            return;
          }

          const dateKey = formatDateKey(selected);

          const payloadBase = {
            date: dateKey,
            start: startVal,
            end: endVal,
            places: placesVal,
            description: descVal,
            visible: visibleVal,
            deposit_required: depositPerSlot,
            deposit_amount: depositAmountVal
          };

          if(dashboardEmail){
            payloadBase.email = dashboardEmail;
          }

          try{
            if(editingSlotId){
              await updateSlot({ ...payloadBase, id: editingSlotId });
            }else{
              await createSlot(payloadBase);
            }

            slotForm.reset();
            slotVisible.checked = true;
            if(slotDeposit){ 
              slotDeposit.checked = false;
              if (slotDepositGroup) slotDepositGroup.style.display = 'none';
              if (slotDepositAmount) slotDepositAmount.value = '';
              if (slotDepositCustom){
                slotDepositCustom.value = '';
                slotDepositCustom.style.display = 'none';
              }
            }
            const msg = editingSlotId ? 'Tijdslot bijgewerkt' : 'Tijdslot opgeslagen';
            editingSlotId = null;
            if(slotSubmitBtn){
              slotSubmitBtn.textContent = '＋ Tijdslot opslaan';
            }

            showToast(msg,'success');
            await loadSlotsForSelectedDate();
            await loadAppointments();
          }catch(err){
            console.error(err);
            showToast('Tijdslot kon niet worden opgeslagen: ' + (err.message || err),'error');
          }
        });
      }

      const settingsForm = document.getElementById('settings-form');
      if (settingsForm) {
        settingsForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!dashboardEmail) {
            showToast(
              'Geen e-mailadres gevonden voor dit account. Log opnieuw in via je Vrijeplek-link.',
              'error'
            );
            return;
          }

          const payload = {
            email: dashboardEmail,
            ...collectSettingsPayload()
          };

          try {
            await saveProfile(payload);
            const status = document.getElementById('settings-status');
            if (status) {
              status.textContent = 'Instellingen opgeslagen';
              status.style.background = 'rgba(22,163,74,.18)';
              status.style.borderColor = 'rgba(34,197,94,.7)';
              status.style.color = '#bbf7d0';
            }
            updateFeatureLockUI();
            showToast('Instellingen opgeslagen.','success');
          } catch (err) {
            console.error(err);
            showToast('Instellingen opslaan mislukt: ' + (err.message || err),'error');
          }
        });

        (async () => {
          try {
            const profile = await fetchProfile();
            applyProfileToForm(profile);
          } catch (err) {
            console.error(err);
          }
        })();
      }

      const flexForm = document.getElementById('flexjob-form');
      const flexStatus = document.getElementById('flexjob-status');

      if (flexForm) {
        const flexTitleEl = document.getElementById('flex-title');
        const flexSectorEl = document.getElementById('flex-sector');
        const flexLocEl = document.getElementById('flex-location');
        const flexHoursEl = document.getElementById('flex-hours');
        const flexPayEl = document.getElementById('flex-pay');
        const flexContactNameEl = document.getElementById('flex-contact-name');
        const flexContactEmailEl = document.getElementById('flex-contact-email');
        const flexContactPhoneEl = document.getElementById('flex-contact-phone');
        const flexDescEl = document.getElementById('flex-description');

        flexForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!window.vpProfileReady) {
            showToast('Vul eerst je bedrijfs- en locatiegegevens in bij Instellingen.','error');
            const settingsTab = document.querySelector('.dash-tab[data-panel="instellingen"]');
            if (settingsTab) settingsTab.click();
            return;
          }

          const title = flexTitleEl.value.trim();
          const description = flexDescEl.value.trim();

          if (!title || !description) {
            showToast('Vul minstens een titel en omschrijving in voor je vacature.','error');
            return;
          }

          const payload = {
            title,
            sector: flexSectorEl.value.trim() || '',
            location: flexLocEl.value.trim() || '',
            hours: flexHoursEl.value.trim() || '',
            pay: flexPayEl.value.trim() || '',
            contact_name: flexContactNameEl.value.trim() || '',
            contact_email: flexContactEmailEl.value.trim() || '',
            contact_phone: flexContactPhoneEl.value.trim() || '',
            description,
            owner_email: dashboardEmail || ''
          };

          try {
            if (flexStatus) flexStatus.textContent = 'Bezig met opslaan…';
            const res = await fetch(API_FLEXJOBS, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            const data = await res.json().catch(() => null);
            if (!res.ok || (data && data.error)) {
              const msg = data && data.error ? data.error : 'Vacature kon niet worden opgeslagen.';
              showToast(msg,'error');
              if (flexStatus) flexStatus.textContent = msg;
              return;
            }
            showToast('Vacature opgeslagen en doorgestuurd naar de homepage.','success');
            if (flexStatus) flexStatus.textContent = 'Vacature gepubliceerd. Je kunt later opnieuw een job aanmaken of aanpassen.';
            flexForm.reset();
            const profile = {};
            applyProfileToForm(profile);
          } catch (err) {
            console.error(err);
            const msg = 'Opslaan van vacature mislukt.';
            showToast(msg,'error');
            if (flexStatus) flexStatus.textContent = msg;
          }
        });
      }

      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn){
        logoutBtn.style.cssText = 'cursor: pointer !important; pointer-events: auto !important; position: relative; z-index: 10;';
        logoutBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Logout clicked');
          window.location.href = '/logout.html';
        };
        logoutBtn.addEventListener('click', logoutBtn.onclick, false);
        console.log('Logout button handler attached');
      } else {
        console.error('Logout button not found!');
      }
      
      renderCalendar();
      updateSelectedLabels();
      loadSlotsForSelectedDate();
      loadAppointments();
      updateFeatureLockUI();
      
      console.log('Dashboard initialized successfully');
      console.log('=== DASHBOARD INIT COMPLETE ===');
      console.log('Tabs:', document.querySelectorAll('.dash-tab').length);
      console.log('Panels:', document.querySelectorAll('.dash-panel').length);
    }

    document.addEventListener('DOMContentLoaded', function() {
      try {
        initDashboard();
      } catch (err) {
        console.error('Init error:', err);
      }
    });
    
    window.handleTabClick = handleTabClick;
    
    window.switchTab = function(panelName) {
      console.log('Emergency switchTab called for:', panelName);
      const tab = document.querySelector(`.dash-tab[data-panel="${panelName}"]`);
      if (tab) {
        handleTabClick.call(tab, null);
      }
    };
    
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === '1') {
          e.preventDefault();
          window.switchTab('afspraken');
        } else if (e.key === '2') {
          e.preventDefault();
          window.switchTab('tijden');
        } else if (e.key === '3') {
          e.preventDefault();
          window.switchTab('website');
        } else if (e.key === '4') {
          e.preventDefault();
          window.switchTab('flexijobs');
        } else if (e.key === '5') {
          e.preventDefault();
          window.switchTab('instellingen');
        }
      }
    });
  </script>
