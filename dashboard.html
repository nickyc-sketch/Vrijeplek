<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard â€” Vrijeplek</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --o1:#1a66ff;
      --o2:#0056ff;
      --ink:#0a2a4a;
      --muted:#3a4b6a;
      --glass-b: rgba(26,102,255,.18);
      --glass: rgba(255,255,255,.75);
      --line: rgba(26,102,255,.25);
      --danger:#e23b3b;
      --ok:#0fa958;
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      font-family:'Poppins',sans-serif;
      background:linear-gradient(180deg,#e9f2ff,#f6f9ff);
      color:var(--ink);
    }

    .site{min-height:100vh;display:flex;flex-direction:column}
    main{flex:1}
    footer{
      text-align:center;
      padding:14px 0 18px;
      font-size:12px;
      color:#6b7280;
    }

    /* HEADER */
    .site-header{
      background:linear-gradient(120deg,var(--o1),var(--o2));
      color:#fff;
      padding:14px 18px;
      position:sticky;
      top:0;
      z-index:50;
      box-shadow:0 4px 16px rgba(0,0,0,.18);
    }
    .header-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      color:#fff;
      font-size:22px;
      font-weight:700;
      text-decoration:none;
    }
    .brand img{height:40px}

    .user-menu{position:relative}
    .user-trigger{
      background:rgba(255,255,255,.15);
      border:none;
      padding:8px 16px;
      border-radius:999px;
      color:#fff;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      font-size:14px;
    }
    .user-trigger span.caret{font-size:11px;opacity:.9}

    .user-dropdown{
      position:absolute;
      right:0;
      top:calc(100% + 6px);
      display:none;
      background:#fff;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(10,27,90,.18);
      min-width:160px;
      padding:6px 0;
      z-index:60;
    }
    .user-dropdown.open{display:block}
    .user-dropdown button{
      width:100%;
      background:none;
      border:none;
      padding:9px 14px;
      text-align:left;
      cursor:pointer;
      font-size:14px;
      color:var(--ink);
    }
    .user-dropdown button:hover{
      background:#f2f5ff;
    }

    /* TABS */
    .tabs-bar{
      background:rgba(255,255,255,.85);
      backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);
    }
    .tabs-inner{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:18px;
      padding:10px 14px;
    }
    .tab-btn{
      background:none;
      border:none;
      padding:10px 18px;
      font-size:15px;
      font-weight:600;
      border-radius:999px;
      cursor:pointer;
      color:var(--ink);
    }
    .tab-btn.active{
      background:linear-gradient(120deg,var(--o1),var(--o2));
      color:#fff;
      box-shadow:0 4px 12px rgba(10,27,90,.15);
    }
    #settings-dot{
      display:none;
      width:8px;
      height:8px;
      border-radius:999px;
      background:#e23b3b;
      margin-left:6px;
      box-shadow:0 0 0 4px rgba(226,59,59,.18);
    }

    /* MAIN WRAPPER */
    .content-wrap{
      max-width:1200px;
      margin:28px auto;
      padding:0 14px;
    }
    h1.section-title{
      margin:0 0 14px;
      font-size:26px;
    }

    /* PAY BANNER */
    #pay-banner{
      display:none;
      background:#fff4f4;
      border:1px solid #ffd1d1;
      color:#8b1f1f;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:18px;
      font-weight:600;
      font-size:14px;
    }

    /* CARDS */
    .card{
      background:var(--glass);
      border:1px solid var(--glass-b);
      border-radius:16px;
      padding:20px;
      margin-bottom:22px;
      box-shadow:0 4px 24px rgba(10,27,90,.06);
      backdrop-filter:blur(8px);
    }

    /* BUTTONS */
    .btn{
      border:none;
      padding:10px 18px;
      border-radius:999px;
      background:linear-gradient(120deg,var(--o1),var(--o2));
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(15,23,42,.18);
    }
    .btn-light{
      padding:9px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }
    .btn-danger{
      padding:9px 14px;
      border-radius:999px;
      background:var(--danger);
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:600;
      font-size:13px;
    }

    .tiny{font-size:12px;color:#5b6b86}

    /* INPUTS */
    .field{display:flex;flex-direction:column;margin-bottom:12px}
    .field label{font-weight:600;margin-bottom:4px;font-size:13px}
    .input{
      padding:10px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      font-size:14px;
    }

    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:14px;
    }
    @media(max-width:700px){
      .form-row{grid-template-columns:1fr}
    }

    /* LOCKED */
    .locked{
      position:relative;
      opacity:.55;
      pointer-events:none;
    }
    .locked::after{
      content:"ðŸ”’ Activeer je abonnement om dit te gebruiken";
      position:absolute;
      inset:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      background:rgba(255,255,255,.82);
      border-radius:14px;
      border:1px dashed var(--line);
      padding:18px;
      font-weight:600;
      font-size:14px;
      color:#0f172a;
    }

    /* AFSPRAKEN */
    .day-group{margin:0 0 22px}
    .day-head{
      font-weight:700;
      font-size:17px;
      margin-bottom:8px;
      text-transform:capitalize;
    }
    .appt{
      display:grid;
      grid-template-columns:110px 1fr auto;
      gap:12px;
      align-items:center;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      margin-bottom:10px;
      box-shadow:0 3px 8px rgba(10,27,90,.06);
      transition:.18s;
    }
    .appt:hover{
      transform:translateY(-2px);
      border-color:var(--o1);
      box-shadow:0 6px 18px rgba(10,27,90,.12);
    }
    .appt-time{
      font-weight:700;
      font-size:15px;
    }
    .appt-meta{display:flex;flex-direction:column;gap:3px}
    .appt-actions{display:flex;gap:8px}
    .edit-row{
      display:grid;
      grid-template-columns:110px 1fr 1fr auto;
      gap:10px;
      padding:12px 14px;
      border-radius:14px;
      border:1px dashed var(--o1);
      background:#f9fbff;
      margin-bottom:10px;
    }
    .edit-row input{
      padding:9px 10px;
      border-radius:8px;
      border:1px solid var(--line);
      font-size:14px;
    }
    @media(max-width:720px){
      .appt,.edit-row{
        grid-template-columns:1fr;
        text-align:left;
      }
      .appt-actions{justify-content:flex-start}
    }

    /* OPEN TIJDSTIPPEN */
    .open-layout{
      display:grid;
      grid-template-columns:1fr 1.3fr;
      gap:20px;
    }
    @media(max-width:900px){
      .open-layout{grid-template-columns:1fr}
    }

    .calendar-card{position:relative;overflow:hidden}
    .calendar-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top,var(--o1),transparent 60%);
      opacity:.08;
      pointer-events:none;
    }

    .calendar-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .calendar-month{
      font-weight:700;
      font-size:18px;
    }
    .calendar-nav{display:flex;gap:6px}
    .calendar-nav button{
      border:none;
      padding:6px 11px;
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      font-size:11px;
      font-weight:600;
      box-shadow:0 2px 8px rgba(15,23,42,.12);
    }

    .calendar-grid{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
      margin-bottom:8px;
    }
    .weekday{
      text-align:center;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      color:#7b8aaa;
      padding:3px 0 5px;
    }
    .calendar-day{
      background:#fff;
      border-radius:12px;
      padding:8px 0 12px;
      text-align:center;
      cursor:pointer;
      border:1px solid transparent;
      transition:.15s;
      font-size:14px;
      font-weight:600;
      min-height:36px;
      box-shadow:0 2px 6px rgba(15,23,42,.06);
      position:relative;
    }
    .calendar-day:hover{
      border-color:var(--o1);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(15,23,42,.15);
    }
    .calendar-day.selected{
      background:linear-gradient(120deg,var(--o1),var(--o2));
      color:#fff;
      box-shadow:0 4px 14px rgba(37,99,235,.4);
    }
    .calendar-day.empty{
      background:transparent;
      box-shadow:none;
      cursor:default;
      border:none;
    }
    .calendar-day.has-slots::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:5px;
      transform:translateX(-50%);
      width:6px;
      height:6px;
      border-radius:999px;
      background:var(--o1);
      box-shadow:0 0 0 4px rgba(26,102,255,.18);
    }

    .slots-list-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      margin-top:8px;
      margin-bottom:4px;
    }
    #slots-list-title{
      margin:0;
      font-size:17px;
      font-weight:700;
    }
    #slots-list-sub{
      font-size:12px;
      color:#6b7280;
    }
    .slot-item{
      display:grid;
      grid-template-columns:90px 1fr auto;
      gap:12px;
      align-items:center;
      padding:11px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:0 3px 8px rgba(15,23,42,.06);
      margin-bottom:8px;
      font-size:14px;
    }
    .slot-time{font-weight:700}
    .slot-actions{display:flex;gap:8px}
    .slot-status-pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
    }
    .slot-status-pill.active{
      background:rgba(15,169,88,.08);
      border:1px solid rgba(15,169,88,.45);
      color:#065f46;
    }
    .slot-status-pill.inactive{
      background:rgba(148,163,184,.12);
      border:1px solid rgba(148,163,184,.7);
      color:#374151;
    }
    .slot-edit-row{
      display:grid;
      grid-template-columns:90px 90px 1fr auto;
      gap:10px;
      padding:11px 14px;
      border-radius:14px;
      border:1px dashed var(--o1);
      background:#f9fbff;
      margin-bottom:8px;
    }
    .slot-edit-row input{
      padding:9px 10px;
      border-radius:8px;
      border:1px solid var(--line);
      font-size:14px;
    }
    @media(max-width:720px){
      .slot-item,.slot-edit-row{
        grid-template-columns:1fr;
      }
    }

    /* INSTELLINGEN */
    .settings{
      display:grid;
      grid-template-columns:260px 1fr;
      gap:18px;
      align-items:flex-start;
    }
    @media(max-width:900px){
      .settings{grid-template-columns:1fr}
    }
    .sidenav{
      background:var(--glass);
      border:1px solid var(--glass-b);
      border-radius:14px;
      padding:8px;
    }
    .side-item{
      width:100%;
      background:none;
      border:1px solid transparent;
      border-radius:12px;
      padding:10px 12px;
      text-align:left;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      font-weight:600;
      margin-bottom:4px;
      font-size:14px;
    }
    .side-item.active{
      background:linear-gradient(180deg,#fff,#f3f7ff);
      border-color:var(--glass-b);
      box-shadow:0 4px 16px rgba(15,23,42,.12);
    }
    .panel-wrap{min-height:480px}
    .panel{
      background:var(--glass);
      border:1px solid var(--glass-b);
      border-radius:14px;
      padding:18px 18px 20px;
      margin-bottom:10px;
    }
    .panel.hide{display:none}
    .two{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media(max-width:720px){
      .two{grid-template-columns:1fr}
    }
    .pill{
      display:inline-block;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .pill.active{
      border-color:var(--o1);
      box-shadow:0 0 0 3px rgba(26,102,255,.15);
    }
    .banner-note{
      font-size:11px;
      color:#6b7280;
      margin-top:6px;
    }

    /* WEBSITE BUILDER */
    .builder-grid{
      display:grid;
      grid-template-columns:320px 1fr;
      gap:20px;
    }
    @media(max-width:960px){
      .builder-grid{grid-template-columns:1fr}
    }
    .builder-controls{
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      padding:16px 16px 18px;
      box-shadow:0 3px 10px rgba(15,23,42,.08);
    }
    .builder-preview{
      background:#fff;
      border-radius:16px;
      border:1px solid var(--line);
      box-shadow:0 3px 10px rgba(15,23,42,.08);
      overflow:hidden;
    }
    iframe#wb-frame{
      width:100%;
      height:520px;
      border:0;
      border-radius:16px;
      background:#fff;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:translateY(0)}
    }
    .tab-content{animation:fadeIn .25s ease}
  </style>
</head>

<body>
<div class="site">

  <header class="site-header">
    <div class="header-inner">
      <a href="index.html" class="brand">
        <img src="img/logo.png" alt="Vrijeplek">
        Vrijeplek
      </a>

      <div class="user-menu">
        <button id="user-trigger" class="user-trigger">
          <span id="user-name">Mijn Vrijeplek</span>
          <span class="caret">â–¾</span>
        </button>
        <div id="user-dropdown" class="user-dropdown">
          <button id="menu-dashboard">Dashboard</button>
          <button id="menu-logout">Uitloggen</button>
        </div>
      </div>
    </div>
  </header>

  <div class="tabs-bar">
    <div class="tabs-inner">
      <button class="tab-btn active" data-tab="afspraken">Afspraken</button>
      <button class="tab-btn" data-tab="open">Open tijdstippen</button>
      <button class="tab-btn" data-tab="website">Website</button>
      <button class="tab-btn" data-tab="instellingen">
        Instellingen
        <span id="settings-dot"></span>
      </button>
    </div>
  </div>

  <main class="content-wrap">
    <div id="pay-banner"></div>
    <h1 id="welcome-title" class="section-title">Welkom, â€” ðŸ‘‹</h1>

    <!-- ========== AFSPRAKEN ========== -->
    <section id="tab-afspraken" class="tab-content">
      <div class="card">
        <h2>Jouw afspraken</h2>
        <div id="appointments-list" style="margin-top:14px;"></div>
        <div class="tiny" style="margin-top:10px;">
          Klik op <strong>Bewerken</strong> om een afspraak aan te passen
          of <strong>Verwijderen</strong> om te annuleren.
        </div>
      </div>
    </section>

    <!-- ========== OPEN TIJDSTIPPEN ========== -->
    <section id="tab-open" class="tab-content" hidden>
      <div class="open-layout">

        <!-- LINKS: nieuw slot -->
        <div class="card">
          <h2>Nieuw tijdslot publiceren</h2>

          <form id="slot-form" style="margin-top:14px;">
            <div class="form-row">
              <div class="field">
                <label>Datum</label>
                <input type="date" id="slot-date" class="input">
              </div>
              <div class="field">
                <label>Van</label>
                <input type="time" id="slot-from" class="input">
              </div>
              <div class="field">
                <label>Tot</label>
                <input type="time" id="slot-to" class="input">
              </div>
            </div>

            <div class="field">
              <label>Omschrijving</label>
              <input type="text" id="slot-desc" class="input" placeholder="vb. Intake, snelle beurt, onderhoudâ€¦">
            </div>

            <button type="submit" class="btn">Publiceren</button>
            <div id="slot-feedback" class="tiny" style="margin-top:8px;"></div>
          </form>
        </div>

        <!-- RECHTS: kalender + lijst -->
        <div class="card calendar-card">
          <div class="calendar-head">
            <div id="slots-month-label" class="calendar-month">â€”</div>
            <div class="calendar-nav">
              <button id="slots-prev">â—€</button>
              <button id="slots-today">Vandaag</button>
              <button id="slots-next">â–¶</button>
            </div>
          </div>

          <div class="calendar-grid" id="slots-weekdays">
            <div class="weekday">Ma</div>
            <div class="weekday">Di</div>
            <div class="weekday">Wo</div>
            <div class="weekday">Do</div>
            <div class="weekday">Vr</div>
            <div class="weekday">Za</div>
            <div class="weekday">Zo</div>
          </div>
          <div class="calendar-grid" id="slots-calendar"></div>

          <div class="slots-list-head">
            <div>
              <h3 id="slots-list-title">Tijdslots</h3>
              <div id="slots-list-sub"></div>
            </div>
          </div>
          <div id="slots-list" style="margin-top:6px;"></div>
        </div>

      </div>
    </section>

    <!-- ========== WEBSITE ========== -->
    <section id="tab-website" class="tab-content" hidden>
      <div class="card">
        <h2>Mini-website builder</h2>
        <p class="tiny" style="margin-top:-4px;">
          Bouw je eigen Vrijeplek-pagina met jouw logo, kleuren en tekst.
        </p>

        <div class="builder-grid" style="margin-top:18px;">
          <div class="builder-controls">
            <div class="field">
              <label>Logo uploaden</label>
              <input type="file" id="wb-logo" accept="image/*" class="input" style="padding:6px;">
            </div>
            <div class="field">
              <label>Titel / naam</label>
              <input type="text" id="wb-title" class="input" placeholder="Naam van je zaak">
            </div>
            <div class="field">
              <label>Hoofdkleur</label>
              <input type="color" id="wb-color" class="input" style="height:44px;padding:2px;">
            </div>
            <div class="field">
              <label>Korte beschrijving</label>
              <textarea id="wb-desc" class="input" style="height:90px;resize:none;" placeholder="Beschrijf kort je diensten."></textarea>
            </div>
            <div class="field">
              <label>Template</label>
              <select id="wb-template" class="input">
                <option value="clean">Clean</option>
                <option value="soft">Soft gradient</option>
                <option value="dark">Dark modern</option>
              </select>
            </div>

            <button id="wb-save" class="btn" style="margin-top:10px;width:100%;">Opslaan</button>
            <div id="wb-status" class="tiny" style="margin-top:6px;"></div>
          </div>

          <div class="builder-preview">
            <iframe id="wb-frame"></iframe>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== INSTELLINGEN ========== -->
    <section id="tab-instellingen" class="tab-content" hidden>
      <div class="settings">
        <!-- SIDE NAV -->
        <div class="sidenav">
          <button class="side-item active" data-side="persoonlijk">Persoonlijk</button>
          <button class="side-item" data-side="privacy">Privacy & betalingen</button>
          <button class="side-item" data-side="zichtbaarheid">Zichtbaarheid</button>
          <button class="side-item" data-side="account">Account</button>
          <button class="side-item" data-side="notificaties">Notificaties</button>
        </div>

        <!-- PANELS -->
        <div class="panel-wrap">
          <!-- Persoonlijk -->
          <div id="panel-persoonlijk" class="panel">
            <h3>Persoonlijke gegevens</h3>
            <div class="two">
              <div class="field">
                <label>Naam (dashboard)</label>
                <input id="st-name" class="input" type="text" placeholder="Voornaam">
              </div>
              <div class="field">
                <label>Bedrijfsnaam</label>
                <input id="st-company" class="input" type="text" placeholder="Naam van je zaak">
              </div>
            </div>
            <div class="two">
              <div class="field">
                <label>Telefoon</label>
                <input id="st-phone" class="input" type="tel" placeholder="+32 ...">
              </div>
              <div class="field">
                <label>E-mail (login)</label>
                <input id="st-email" class="input" type="email" disabled>
                <div class="tiny">Je login wordt beheerd via Supabase.</div>
              </div>
            </div>
            <div class="two">
              <div class="field">
                <label>BTW-nummer</label>
                <input id="st-btw" class="input" type="text" placeholder="BE0123456789">
              </div>
              <div class="field">
                <label>Categorie</label>
                <select id="st-cat" class="input">
                  <option value="">Kies</option>
                  <option value="horeca">Horeca</option>
                  <option value="wellness">Wellness</option>
                  <option value="zorg">Gezondheid</option>
                  <option value="events">Events</option>
                  <option value="poetsdiensten">Poetsdiensten</option>
                  <option value="ramenwasser">Ramenwasser</option>
                  <option value="dieren">Dieren</option>
                </select>
              </div>
            </div>
            <div class="two">
              <div class="field">
                <label>Straat + nr.</label>
                <input id="st-straat" class="input" type="text">
              </div>
              <div class="field">
                <label>Postcode & gemeente</label>
                <input id="st-postcode" class="input" type="text" placeholder="3500 Hasselt">
              </div>
            </div>
            <div class="field">
              <label>Website</label>
              <input id="st-website" class="input" type="url" placeholder="https://voorbeeld.be">
            </div>
            <div class="field">
              <label>Korte omschrijving</label>
              <input id="st-bio" class="input" type="text" placeholder="Beschrijf kort je diensten">
            </div>
            <button id="st-save-person" class="btn">Opslaan</button>
            <span id="st-msg" class="tiny" style="margin-left:8px;"></span>
          </div>

          <!-- Privacy -->
          <div id="panel-privacy" class="panel hide">
            <h3>Privacy & betalingen</h3>
            <div class="field">
              <label>Locatie tonen in zoekresultaten</label>
              <input id="st-show-location" type="checkbox" style="transform:scale(1.1);margin-right:6px;">
              <span class="tiny">Toont postcode + gemeente op je publieke pagina.</span>
            </div>
            <div class="field">
              <label>Kalender publiek zichtbaar</label>
              <input id="st-public-calendar" type="checkbox" style="transform:scale(1.1);margin-right:6px;">
              <span class="tiny">Bezoekers zien je vrije momenten zonder eerst te boeken.</span>
            </div>

            <div class="field" style="margin-top:10px;">
              <label>Rekeningnummer voor voorschotbetalingen</label>
              <div id="st-iban-current" class="tiny">Nog geen rekeningnummer ingesteld.</div>
              <input id="st-iban-new" class="input" type="text" placeholder="BE00 0000 0000 0000">
            </div>

            <div class="field">
              <label>Voorschot vragen bij boeking</label>
              <input id="st-deposit-enabled" type="checkbox" style="transform:scale(1.1);margin-right:6px;">
            </div>

            <div class="two">
              <div class="field">
                <label>Voorschotbedrag (â‚¬)</label>
                <input id="st-deposit-amount" class="input" type="number" min="0">
              </div>
              <div class="field">
                <label>Opmerking (zichtbaar voor klant)</label>
                <input id="st-deposit-note" class="input" type="text" placeholder="Bijvoorbeeld: niet terugbetaald bij no-show.">
              </div>
            </div>

            <button id="st-save-privacy" class="btn">Opslaan</button>
            <span id="st-privacy-msg" class="tiny" style="margin-left:8px;"></span>
          </div>

          <!-- Zichtbaarheid -->
          <div id="panel-zichtbaarheid" class="panel hide">
            <h3>Zichtbaarheid</h3>
            <div class="field">
              <label>Google reviews tonen</label>
              <input id="st-reviews" type="checkbox" style="transform:scale(1.1);margin-right:6px;">
            </div>
            <div class="field">
              <label>Google Place ID / review-link</label>
              <input id="st-place" class="input" type="text" placeholder="ChIJN1t... of review-URL">
            </div>
            <button id="st-save-vis" class="btn">Opslaan</button>
          </div>

          <!-- Account -->
          <div id="panel-account" class="panel hide">
            <h3>Accountstatus & betaling</h3>
            <div id="acc-status" class="tiny" style="margin-bottom:8px;">
              Status: <strong>â€”</strong>
            </div>
            <div class="field">
              <label>Abonnement</label>
              <div id="plan-wrap" style="display:flex;gap:10px;flex-wrap:wrap;">
                <button class="pill" data-plan="monthly">â‚¬19,95 / maand</button>
                <button class="pill" data-plan="yearly">â‚¬199 / jaar</button>
              </div>
            </div>
            <button id="btn-activate" class="btn">Activeer abonnement</button>
            <a id="last-checkout-url" href="#" target="_blank" class="tiny" style="margin-left:10px;display:none;">
              Laatste betaallink
            </a>
            <div class="banner-note">
              Gegevens worden pas publiek zodra jouw abonnement actief is.
            </div>
          </div>

          <!-- Notificaties -->
          <div id="panel-notificaties" class="panel hide">
            <h3>Notificaties</h3>
            <div class="two">
              <div class="field">
                <label>Nieuwe reservatie per e-mail</label>
                <input id="st-notify-mail" type="checkbox" style="transform:scale(1.1);margin-right:6px;">
              </div>
              <div class="field">
                <label>Dagelijkse agenda per e-mail</label>
                <input id="st-daily-mail" type="checkbox" style="transform:scale(1.1);margin-right:6px;">
              </div>
            </div>
            <button id="st-save-notify" class="btn">Opslaan</button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer>Â© 2025 Vrijeplek. Alle rechten voorbehouden.</footer>
</div>

<!-- Supabase config (URL + ANON KEY) -->
<script src="/js/config.js"></script>

<script type="module">
  /* =============== HELPERS =============== */
  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  function firstNameFrom(user){
    try{
      const meta = user?.user_metadata?.display_name
        || user?.user_metadata?.name
        || user?.user_metadata?.full_name
        || '';
      const metaFirst = (meta||'').split(/[.\s_-]/)[0]?.trim();
      const mailFirst = (user?.email||'').split('@')[0]?.trim();
      const blacklist = ['info','contact','admin','sales','support','hallo','hello'];
      const c = metaFirst && metaFirst.length>1 ? metaFirst : mailFirst;
      if(!c) return '';
      const lower = c.toLowerCase();
      if(blacklist.includes(lower)) return '';
      return c.charAt(0).toUpperCase()+c.slice(1);
    }catch{return '';}
  }

  function esc(s){
    return (s||"").toString().replace(/[&<>"]/g,m=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"
    }[m]));
  }

  function formatDateLabel(iso){
    try{
      return new Date(iso+"T00:00:00").toLocaleDateString("nl-BE",{
        weekday:"long", day:"2-digit", month:"long"
      });
    }catch{return iso;}
  }

  function isValidBelgianIban(raw){
    const clean = (raw||'').replace(/\s+/g,'').toUpperCase();
    if(!/^BE[0-9]{14}$/.test(clean)) return false;
    const moved = clean.slice(4)+clean.slice(0,4);
    const replaced = moved.replace(/[A-Z]/g,c=>(c.charCodeAt(0)-55));
    let remainder = 0;
    for(let i=0;i<replaced.length;i++){
      remainder = (remainder*10 + Number(replaced[i]))%97;
    }
    return remainder === 1;
  }

  /* =============== BASIC UI HOOKS =============== */
  const tabButtons = $$('.tab-btn');
  const tabContents = $$('.tab-content');
  const payBanner = $('#pay-banner');
  const settingsDot = $('#settings-dot');
  const welcomeTitle = $('#welcome-title');
  const userNameEl = $('#user-name');

  tabButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      tabButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      tabContents.forEach(sec=>sec.hidden = (sec.id !== 'tab-'+tab));
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  const userTrigger = $('#user-trigger');
  const userDropdown = $('#user-dropdown');
  userTrigger?.addEventListener('click',(e)=>{
    e.stopPropagation();
    userDropdown.classList.toggle('open');
  });
  document.addEventListener('click',()=>userDropdown?.classList.remove('open'));

  $('#menu-dashboard')?.addEventListener('click',()=>userDropdown?.classList.remove('open'));

  /* =============== SUPABASE INIT =============== */
  async function initSupabase(){
    try{
      const url = window.VRIJEPLEK?.SUPABASE_URL;
      const key = window.VRIJEPLEK?.SUPABASE_ANON_KEY;
      if(!url || !key) return null;
      const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
      return createClient(url,key,{
        auth:{ persistSession:true, autoRefreshToken:true, storage:localStorage }
      });
    }catch(e){
      console.error("Supabase init error:",e);
      return null;
    }
  }
  const supabase = await initSupabase();

  async function ensureSession(){
    // eventuele oude ?email= rommel verwijderen
    const url = new URL(location.href);
    if(url.searchParams.has('email')){
      url.searchParams.delete('email');
      history.replaceState(null,'',url.toString());
    }

    if(!supabase){
      location.href = "login.html";
      return;
    }
    try{
      const { data:{ session } } = await supabase.auth.getSession();
      if(session?.user){
        await applyUser(session.user);
        return;
      }
    }catch(e){
      console.warn("getSession error",e);
    }
    location.href = "login.html";
  }

  async function logout(){
    try{ await supabase?.auth?.signOut(); }catch{}
    try{
      localStorage.clear();
      sessionStorage.clear();
    }catch{}
    location.href = "login.html";
  }
  $('#menu-logout')?.addEventListener('click',()=>{
    userDropdown?.classList.remove('open');
    logout();
  });

  /* =============== PROFIEL & ACCOUNT =============== */
  const els = {
    apptList: $('#appointments-list'),
    sections:{
      open: $('#tab-open'),
      website: $('#tab-website')
    },
    st:{
      name: $('#st-name'),
      company: $('#st-company'),
      phone: $('#st-phone'),
      email: $('#st-email'),
      btw: $('#st-btw'),
      cat: $('#st-cat'),
      straat: $('#st-straat'),
      postcode: $('#st-postcode'),
      website: $('#st-website'),
      bio: $('#st-bio'),
      msg: $('#st-msg'),
      showLocation: $('#st-show-location'),
      publicCalendar: $('#st-public-calendar'),
      ibanCurrent: $('#st-iban-current'),
      ibanNew: $('#st-iban-new'),
      depositEnabled: $('#st-deposit-enabled'),
      depositAmount: $('#st-deposit-amount'),
      depositNote: $('#st-deposit-note'),
      privacyMsg: $('#st-privacy-msg'),
      reviews: $('#st-reviews'),
      place: $('#st-place'),
      notifyMail: $('#st-notify-mail'),
      dailyMail: $('#st-daily-mail')
    },
    planPills: $$('#plan-wrap .pill'),
    accStatus: $('#acc-status'),
    btnActivate: $('#btn-activate'),
    lastCheckout: $('#last-checkout-url')
  };

  let CURRENT_EMAIL = '';
  let CURRENT_PLAN = 'monthly';
  let CURRENT_STATUS = 'pending';

  async function applyUser(user){
    CURRENT_EMAIL = (user?.email || '').toLowerCase();
    const fn = firstNameFrom(user) || 'â€”';
    userNameEl.textContent = fn;
    welcomeTitle.textContent = `Welkom, ${fn} ðŸ‘‹`;
    els.st.email.value = user.email || '';
    await loadProfile();
    await loadAppointments();
    initSlots();   // kalender
    initWebsiteBuilder();
  }

  async function loadProfile(){
    if(!CURRENT_EMAIL) return;
    try{
      const r = await fetch(`/.netlify/functions/profile?email=${encodeURIComponent(CURRENT_EMAIL)}`);
      const d = await r.json();
      const p = d || {};
      window.__profile = p;

      els.st.name.value      = p.zaakhouder || els.st.name.value;
      els.st.company.value   = p.zaak || '';
      els.st.phone.value     = p.telefoon || '';
      els.st.btw.value       = p.btw || '';
      els.st.cat.value       = p.cat || '';
      els.st.straat.value    = p.straat || '';
      els.st.postcode.value  = p.postcode || '';
      els.st.website.value   = p.website || '';
      els.st.bio.value       = p.bio || '';

      els.st.showLocation.checked   = !!p.show_location;
      els.st.publicCalendar.checked = !!p.public_calendar;
      els.st.depositEnabled.checked = !!p.deposit_enabled;
      els.st.depositAmount.value    = p.deposit_amount ?? '';
      els.st.depositNote.value      = p.deposit_note || '';

      els.st.reviews.checked        = !!p.reviews;
      els.st.place.value            = p.place || '';
      els.st.notifyMail.checked     = !!p.notify_mail;
      els.st.dailyMail.checked      = !!p.daily_mail;

      if(p.bank_iban){
        els.st.ibanCurrent.textContent = 'IBAN eindigend op '+ p.bank_iban.slice(-4);
      }else{
        els.st.ibanCurrent.textContent = 'Nog geen rekeningnummer ingesteld.';
      }

      CURRENT_PLAN   = p.plan || 'monthly';
      CURRENT_STATUS = (p.account_status || p.status || 'pending').toString().toLowerCase();
      applyPlanUI();
    }catch(e){
      console.warn("profile load error",e);
    }
  }

  function applyPlanUI(){
    const active = (CURRENT_STATUS === 'active');
    els.accStatus.innerHTML =
      `Status: <strong style="color:${active?'#0fa958':'#e23b3b'}">`+
      (active?'Actief':'Niet actief')+
      `</strong> â€” plan: <strong>${CURRENT_PLAN}</strong>`;

    els.planPills.forEach(p=>{
      const isCurrent = p.dataset.plan === CURRENT_PLAN;
      p.classList.toggle('active',isCurrent);
    });

    if(!active){
      settingsDot.style.display = 'inline-block';
      payBanner.style.display = 'block';
      payBanner.innerHTML = 'Je account is <strong>niet actief</strong>. Rond je betaling af om alle functies te gebruiken.';

      els.sections.open.classList.add('locked');
      els.sections.website.classList.add('locked');

      els.btnActivate.disabled = false;
      els.btnActivate.textContent = 'Activeer abonnement';
      els.lastCheckout.style.display = 'inline';
    }else{
      settingsDot.style.display = 'none';
      payBanner.style.display = 'none';

      els.sections.open.classList.remove('locked');
      els.sections.website.classList.remove('locked');

      els.btnActivate.disabled = true;
      els.btnActivate.textContent = 'Geabonneerd âœ”';
      els.lastCheckout.style.display = 'none';
    }
  }

  $('#st-save-person')?.addEventListener('click',async()=>{
    if(!CURRENT_EMAIL) return;
    els.st.msg.textContent = 'Opslaan...';
    els.st.msg.style.color = 'var(--ink)';
    const body = {
      email: CURRENT_EMAIL,
      zaak: els.st.company.value.trim(),
      telefoon: els.st.phone.value.trim(),
      btw: els.st.btw.value.trim(),
      cat: els.st.cat.value.trim(),
      straat: els.st.straat.value.trim(),
      postcode: els.st.postcode.value.trim(),
      website: els.st.website.value.trim(),
      bio: els.st.bio.value.trim()
    };
    try{
      const r = await fetch('/.netlify/functions/profile',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw 0;
      els.st.msg.textContent = 'Opgeslagen âœ”';
      els.st.msg.style.color = '#0fa958';
    }catch{
      els.st.msg.textContent = 'Opslaan mislukt';
      els.st.msg.style.color = 'var(--danger)';
    }
  });

  $('#st-save-privacy')?.addEventListener('click',async()=>{
    if(!CURRENT_EMAIL) return;
    els.st.privacyMsg.textContent = 'Opslaan...';
    els.st.privacyMsg.style.color = 'var(--ink)';

    let iban = els.st.ibanNew.value.trim();
    if(iban && !isValidBelgianIban(iban)){
      els.st.privacyMsg.textContent = 'IBAN lijkt ongeldig.';
      els.st.privacyMsg.style.color = 'var(--danger)';
      return;
    }

    const body = {
      email: CURRENT_EMAIL,
      show_location: els.st.showLocation.checked,
      public_calendar: els.st.publicCalendar.checked,
      deposit_enabled: els.st.depositEnabled.checked,
      deposit_amount: els.st.depositAmount.value ? Number(els.st.depositAmount.value) : null,
      deposit_note: els.st.depositNote.value.trim()
    };
    if(iban) body.bank_iban = iban.replace(/\s+/g,'');

    try{
      const r = await fetch('/.netlify/functions/profile',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw 0;

      els.st.privacyMsg.textContent = 'Opgeslagen âœ”';
      els.st.privacyMsg.style.color = '#0fa958';

      if(iban){
        els.st.ibanNew.value = '';
        els.st.ibanCurrent.textContent = 'IBAN eindigend op '+ iban.slice(-4);
      }
    }catch{
      els.st.privacyMsg.textContent = 'Opslaan mislukt';
      els.st.privacyMsg.style.color = 'var(--danger)';
    }
  });

  $('#st-save-vis')?.addEventListener('click',async()=>{
    if(!CURRENT_EMAIL) return;
    const body = {
      email: CURRENT_EMAIL,
      reviews: els.st.reviews.checked,
      place: els.st.place.value.trim()
    };
    try{
      const r = await fetch('/.netlify/functions/profile',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw 0;
      alert('Opgeslagen âœ”');
    }catch{
      alert('Opslaan mislukt');
    }
  });

  $('#st-save-notify')?.addEventListener('click',async()=>{
    if(!CURRENT_EMAIL) return;
    const body = {
      email: CURRENT_EMAIL,
      notify_mail: els.st.notifyMail.checked,
      daily_mail: els.st.dailyMail.checked
    };
    try{
      const r = await fetch('/.netlify/functions/profile',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw 0;
      alert('Opgeslagen âœ”');
    }catch{
      alert('Opslaan mislukt');
    }
  });

  els.planPills.forEach(p=>{
    p.addEventListener('click',()=>{
      CURRENT_PLAN = p.dataset.plan;
      els.planPills.forEach(x=>x.classList.toggle('active',x===p));
    });
  });

  els.btnActivate.addEventListener('click',async()=>{
    if(!CURRENT_EMAIL) return;
    els.btnActivate.disabled = true;
    els.btnActivate.textContent = 'Link maken...';
    try{
      const r = await fetch('/.netlify/functions/create-checkout',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email:CURRENT_EMAIL, plan:CURRENT_PLAN })
      });
      const d = await r.json().catch(()=>null);
      const url = d?.url;
      if(url){
        els.lastCheckout.href = url;
        els.lastCheckout.style.display = 'inline';
        location.href = url;
      }else{
        alert('Betaallink niet beschikbaar.');
      }
    }catch{
      alert('Kon betaallink niet ophalen.');
    }finally{
      els.btnActivate.disabled = false;
      els.btnActivate.textContent = 'Activeer abonnement';
    }
  });

  /* =============== INSTELLINGEN SIDE NAV =============== */
  const sideItems = $$('.side-item');
  const panels = {
    persoonlijk: $('#panel-persoonlijk'),
    privacy: $('#panel-privacy'),
    zichtbaarheid: $('#panel-zichtbaarheid'),
    account: $('#panel-account'),
    notificaties: $('#panel-notificaties')
  };
  sideItems.forEach(btn=>{
    btn.addEventListener('click',()=>{
      sideItems.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const key = btn.dataset.side;
      Object.entries(panels).forEach(([k,p])=>{
        p.classList.toggle('hide',k!==key);
      });
    });
  });

  /* =============== AFSPRAKEN =============== */
  let appts = [];
  function groupByDate(items){
    const map = {};
    items.forEach(i=>{ (map[i.date] ||= []).push(i); });
    Object.values(map).forEach(list=>list.sort((a,b)=>a.time.localeCompare(b.time)));
    return Object.keys(map).sort().map(d=>({date:d, items:map[d]}));
  }

  let editingApptId = null;

  function renderAppointments(list){
    const wrap = els.apptList;
    wrap.innerHTML = '';
    if(!list.length){
      wrap.innerHTML = '<div class="tiny">Nog geen afspraken.</div>';
      return;
    }
    const groups = groupByDate(list);
    groups.forEach(g=>{
      const dayWrap = document.createElement('div');
      dayWrap.className = 'day-group';
      const head = document.createElement('div');
      head.className = 'day-head';
      head.textContent = formatDateLabel(g.date);
      dayWrap.appendChild(head);
      g.items.forEach(item=>{
        if(item.id === editingApptId){
          dayWrap.appendChild(makeApptEditRow(item));
        }else{
          dayWrap.appendChild(makeApptRow(item));
        }
      });
      wrap.appendChild(dayWrap);
    });
  }

  function makeApptRow(item){
    const div = document.createElement('div');
    div.className = 'appt';
    div.dataset.id = item.id;
    div.innerHTML = `
      <div class="appt-time">${esc(item.time)}</div>
      <div class="appt-meta">
        <div><strong>${esc(item.client||'â€”')}</strong> â€” ${esc(item.purpose||'')}</div>
        <div class="tiny">${esc(item.note||'')}</div>
      </div>
      <div class="appt-actions">
        <button class="btn-light">Bewerken</button>
        <button class="btn-danger">Verwijderen</button>
      </div>
    `;
    const [btnEdit, btnDel] = div.querySelectorAll('button');
    btnEdit.addEventListener('click',()=>{ editingApptId = item.id; renderAppointments(appts); });
    btnDel.addEventListener('click',()=>deleteAppt(item.id));
    return div;
  }

  function makeApptEditRow(item){
    const div = document.createElement('div');
    div.className = 'edit-row';
    div.dataset.id = item.id;
    div.innerHTML = `
      <input type="time" value="${esc(item.time)}">
      <input type="text" value="${esc(item.client||'')}">
      <input type="text" value="${esc(item.purpose||'')}" placeholder="Omschrijving">
      <div style="display:flex;gap:8px;">
        <button class="btn">Opslaan</button>
        <button class="btn-light">Annuleren</button>
      </div>
    `;
    const [t,client,purpose] = div.querySelectorAll('input');
    const [btnSave,btnCancel] = div.querySelectorAll('button');
    btnSave.addEventListener('click',()=>saveAppt({
      id:item.id,
      date:item.date,
      time:t.value,
      client:client.value.trim(),
      purpose:purpose.value.trim(),
      note:item.note||''
    }));
    btnCancel.addEventListener('click',()=>{ editingApptId = null; renderAppointments(appts); });
    return div;
  }

  async function loadAppointments(){
    try{
      const r = await fetch('/.netlify/functions/appointments?action=list');
      const d = await r.json().catch(()=>[]);
      appts = Array.isArray(d)?d:[];
    }catch{
      appts = [];
    }
    renderAppointments(appts);
  }

  async function saveAppt(payload){
    try{
      await fetch('/.netlify/functions/appointments',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'update', ...payload })
      });
      editingApptId = null;
      await loadAppointments();
    }catch{}
  }

  async function deleteAppt(id){
    if(!confirm('Afspraak verwijderen?')) return;
    try{
      await fetch('/.netlify/functions/appointments',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'delete', id })
      });
      await loadAppointments();
    }catch{}
  }

  /* =============== OPEN TIJDSTIPPEN =============== */
  const slotEls = {
    form: $('#slot-form'),
    date: $('#slot-date'),
    from: $('#slot-from'),
    to:   $('#slot-to'),
    desc: $('#slot-desc'),
    feedback: $('#slot-feedback'),
    monthLabel: $('#slots-month-label'),
    calGrid: $('#slots-calendar'),
    listTitle: $('#slots-list-title'),
    listSub: $('#slots-list-sub'),
    list: $('#slots-list'),
    btnPrev: $('#slots-prev'),
    btnNext: $('#slots-next'),
    btnToday: $('#slots-today')
  };

  let calYear, calMonth; // 0-based
  let selectedDateISO = '';
  let slots = [];
  let editingSlotId = null;

  function toISO(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }

  function buildCalendar(){
    slotEls.calGrid.innerHTML = '';
    const first = new Date(calYear,calMonth,1);
    const daysInMonth = new Date(calYear,calMonth+1,0).getDate();
    const weekday = (first.getDay()+6)%7; // maandag=0

    const monthLabel = first.toLocaleDateString("nl-BE",{month:'long',year:'numeric'});
    slotEls.monthLabel.textContent = monthLabel.charAt(0).toUpperCase()+monthLabel.slice(1);

    for(let i=0;i<weekday;i++){
      const div = document.createElement('div');
      div.className = 'calendar-day empty';
      slotEls.calGrid.appendChild(div);
    }

    for(let d=1;d<=daysInMonth;d++){
      const dateObj = new Date(calYear,calMonth,d);
      const iso = toISO(dateObj);
      const div = document.createElement('div');
      div.className = 'calendar-day';
      div.textContent = d;
      if(iso === selectedDateISO) div.classList.add('selected');
      div.addEventListener('click',()=>{
        selectedDateISO = iso;
        slotEls.date.value = iso;
        updateCalendarSelection();
        loadSlotsForSelected();
      });
      slotEls.calGrid.appendChild(div);
    }
    markDaysWithSlots();
  }

  function updateCalendarSelection(){
    $$('#slots-calendar .calendar-day').forEach(day=>{
      if(day.classList.contains('empty')) return;
      const d = day.textContent.padStart(2,'0');
      const isSelected = (selectedDateISO && selectedDateISO.slice(8)===d);
      day.classList.toggle('selected',isSelected);
    });
  }

  function markDaysWithSlots(){
    const datesWithSlots = new Set(slots.map(s=>s.date));
    $$('#slots-calendar .calendar-day').forEach(day=>{
      if(day.classList.contains('empty')) return;
      const d = day.textContent.padStart(2,'0');
      const monthStr = String(calMonth+1).padStart(2,'0');
      const dateStr = `${calYear}-${monthStr}-${d}`;
      day.classList.toggle('has-slots', datesWithSlots.has(dateStr));
    });
  }

  async function loadSlotsForMonth(){
    // Als je backend nog geen month-endpoint heeft:
    // fallback: alleen huidige dag; voor nu doen we per dag call als gebruiker klikt
    slots = [];
    markDaysWithSlots();
  }

  async function loadSlotsForSelected(){
    if(!selectedDateISO) return;
    slotEls.listTitle.textContent = `Tijdslots op ${formatDateLabel(selectedDateISO)}`;
    slotEls.listSub.textContent = selectedDateISO;

    try{
      const r = await fetch('/.netlify/functions/appointments?action=listSlots&date='+encodeURIComponent(selectedDateISO));
      const d = await r.json().catch(()=>[]);
      slots = Array.isArray(d)?d:[];

      // zorg dat de huidige dag "has-slots" krijgt
      markDaysWithSlots();
      renderSlotsList();
    }catch{
      slots = [];
      renderSlotsList();
    }
  }

  function renderSlotsList(){
    slotEls.list.innerHTML = '';
    if(!selectedDateISO){
      slotEls.list.innerHTML = '<div class="tiny">Kies een datum in de kalender.</div>';
      return;
    }
    if(!slots.length){
      slotEls.list.innerHTML = '<div class="tiny">Nog geen tijdslots voor deze dag.</div>';
      return;
    }
    slots.sort((a,b)=> (a.from||'').localeCompare(b.from||''));
    slots.forEach(s=>{
      if(s.id === editingSlotId){
        slotEls.list.appendChild(makeSlotEditRow(s));
      }else{
        slotEls.list.appendChild(makeSlotRow(s));
      }
    });
  }

  function makeSlotRow(s){
    const div = document.createElement('div');
    div.className = 'slot-item';
    const active = s.active !== false; // default true
    div.innerHTML = `
      <div class="slot-time">${esc(s.from||'')}â€“${esc(s.to||'')}</div>
      <div>
        <div>${esc(s.desc||'')}</div>
        <div>
          <span class="slot-status-pill ${active?'active':'inactive'}">
            ${active?'Actief':'Uitgeschakeld'}
          </span>
        </div>
      </div>
      <div class="slot-actions">
        <button class="btn-light">Bewerken</button>
        <button class="btn-danger">Verwijderen</button>
      </div>
    `;
    const [btnEdit,btnDel] = div.querySelectorAll('button');
    btnEdit.addEventListener('click',()=>{ editingSlotId = s.id; renderSlotsList(); });
    btnDel.addEventListener('click',()=>deleteSlot(s.id));
    return div;
  }

  function makeSlotEditRow(s){
    const div = document.createElement('div');
    div.className = 'slot-edit-row';
    div.innerHTML = `
      <input type="time" value="${esc(s.from||'')}">
      <input type="time" value="${esc(s.to||'')}">
      <input type="text" value="${esc(s.desc||'')}" placeholder="Omschrijving">
      <div style="display:flex;flex-direction:column;gap:6px;">
        <label class="tiny">
          <input type="checkbox" ${s.active!==false?'checked':''} style="transform:scale(1.1);margin-right:4px;">
          Actief tonen in zoekresultaten
        </label>
        <div style="display:flex;gap:6px;margin-top:4px;">
          <button class="btn">Opslaan</button>
          <button class="btn-light">Annuleren</button>
        </div>
      </div>
    `;
    const [fromEl,toEl,descEl] = div.querySelectorAll('input[type="time"],input[type="text"]');
    const activeEl = div.querySelector('input[type="checkbox"]');
    const [btnSave,btnCancel] = div.querySelectorAll('button');
    btnSave.addEventListener('click',()=>saveSlot({
      id:s.id,
      date:selectedDateISO,
      from:fromEl.value,
      to:toEl.value,
      desc:descEl.value.trim(),
      active: !!activeEl.checked
    }));
    btnCancel.addEventListener('click',()=>{ editingSlotId = null; renderSlotsList(); });
    return div;
  }

  slotEls.form?.addEventListener('submit',async(e)=>{
    e.preventDefault();
    if(!CURRENT_EMAIL) return;
    slotEls.feedback.textContent = '';
    const date = slotEls.date.value || selectedDateISO;
    const from = slotEls.from.value;
    const to   = slotEls.to.value;
    const desc = slotEls.desc.value.trim();

    if(!date || !from || !to){
      slotEls.feedback.textContent = 'Datum, begin- en einduur zijn verplicht.';
      slotEls.feedback.style.color = 'var(--danger)';
      return;
    }
    try{
      const body = { action:'addSlot', date, from, to, desc };
      const r = await fetch('/.netlify/functions/appointments',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if(!r.ok) throw 0;
      slotEls.feedback.textContent = 'Tijdslot toegevoegd âœ”';
      slotEls.feedback.style.color = '#0fa958';
      slotEls.from.value='';
      slotEls.to.value='';
      slotEls.desc.value='';
      selectedDateISO = date;
      updateCalendarSelection();
      await loadSlotsForSelected();
    }catch{
      slotEls.feedback.textContent = 'Kon tijdslot niet opslaan.';
      slotEls.feedback.style.color = 'var(--danger)';
    }
  });

  async function deleteSlot(id){
    if(!confirm('Tijdslot verwijderen?')) return;
    try{
      await fetch('/.netlify/functions/appointments',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'deleteSlot', id })
      });
      await loadSlotsForSelected();
    }catch{}
  }

  async function saveSlot(payload){
    try{
      await fetch('/.netlify/functions/appointments',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'updateSlot', ...payload })
      });
      editingSlotId = null;
      await loadSlotsForSelected();
    }catch{}
  }

  function initSlots(){
    const now = new Date();
    calYear = now.getFullYear();
    calMonth = now.getMonth();
    selectedDateISO = toISO(now);
    slotEls.date.value = selectedDateISO;

    slotEls.btnPrev.addEventListener('click',()=>{
      calMonth--;
      if(calMonth<0){calMonth=11;calYear--;}
      buildCalendar();
      loadSlotsForMonth();
    });
    slotEls.btnNext.addEventListener('click',()=>{
      calMonth++;
      if(calMonth>11){calMonth=0;calYear++;}
      buildCalendar();
      loadSlotsForMonth();
    });
    slotEls.btnToday.addEventListener('click',()=>{
      const n = new Date();
      calYear = n.getFullYear();
      calMonth = n.getMonth();
      selectedDateISO = toISO(n);
      slotEls.date.value = selectedDateISO;
      buildCalendar();
      loadSlotsForSelected();
    });

    buildCalendar();
    loadSlotsForSelected();
  }

  /* =============== WEBSITE BUILDER =============== */
  const wb = {
    frame: $('#wb-frame'),
    logo: $('#wb-logo'),
    title: $('#wb-title'),
    color: $('#wb-color'),
    desc: $('#wb-desc'),
    template: $('#wb-template'),
    saveBtn: $('#wb-save'),
    status: $('#wb-status')
  };
  let wbLogoData = '';

  function updateBuilderPreview(){
    const title = wb.title.value || 'Jouw bedrijfsnaam';
    const desc  = wb.desc.value || '';
    const color = wb.color.value || '#1a66ff';
    const tpl   = wb.template.value;
    let bg = '#ffffff';
    let text = '#0a2a4a';
    if(tpl === 'soft') bg = `linear-gradient(180deg,${color}22,#ffffff)`;
    if(tpl === 'dark'){ bg = '#020617'; text = '#e5e7eb'; }

    wb.frame.srcdoc = `
      <html>
      <head>
        <meta charset="utf-8">
        <style>
          body{
            margin:0;
            font-family:'Poppins',sans-serif;
            background:${bg};
            color:${text};
            min-height:100vh;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:32px 16px;
            text-align:center;
          }
          .logo{
            max-width:140px;
            border-radius:18px;
            margin-bottom:18px;
          }
          h1{
            margin:0;
            font-size:28px;
          }
          p{
            margin-top:10px;
            font-size:15px;
            max-width:460px;
          }
        </style>
      </head>
      <body>
        ${wbLogoData?`<img src="${wbLogoData}" class="logo">`:''}
        <h1>${esc(title)}</h1>
        <p>${esc(desc)}</p>
      </body>
      </html>
    `;
  }

  function initWebsiteBuilder(){
    wb.color.value = '#1a66ff';
    wb.template.value = 'clean';
    updateBuilderPreview();

    wb.logo.addEventListener('change',()=>{
      const file = wb.logo.files?.[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        wbLogoData = e.target.result;
        updateBuilderPreview();
      };
      reader.readAsDataURL(file);
    });
    [wb.title, wb.color, wb.desc, wb.template].forEach(el=>{
      el.addEventListener('input',updateBuilderPreview);
    });

    wb.saveBtn.addEventListener('click',async()=>{
      if(!CURRENT_EMAIL) return;
      wb.status.textContent = 'Opslaan...';
      wb.status.style.color = 'var(--ink)';
      const payload = {
        email: CURRENT_EMAIL,
        website_builder:{
          title: wb.title.value,
          desc: wb.desc.value,
          color: wb.color.value,
          template: wb.template.value,
          logo: wbLogoData
        }
      };
      try{
        const r = await fetch('/.netlify/functions/profile',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw 0;
        wb.status.textContent = 'Opgeslagen âœ”';
        wb.status.style.color = '#0fa958';
      }catch{
        wb.status.textContent = 'Opslaan mislukt';
        wb.status.style.color = 'var(--danger)';
      }
    });
  }

  /* =============== START =============== */
  await ensureSession();
</script>

</body>
</html>
