<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard â€” Vrijeplek</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css?v=ocean3">

  <style>
    :root{
      --o1:#1a66ff; --o2:#0056ff; --ink:#0a2a4a; --muted:#3a4b6a;
      --glass-b: rgba(26,102,255,.18); --glass: rgba(255,255,255,.7);
      --line: rgba(26,102,255,.25); --danger:#e23b3b; --ok:#0fa958;
    }
    html,body{height:100%}
    body{font-family:'Poppins',sans-serif;margin:0;min-height:100svh;display:flex;flex-direction:column;background:linear-gradient(180deg,#e9f2ff,#f6f9ff);color:var(--ink)}
    .site{display:flex;flex-direction:column;min-height:100svh}
    main{flex:1}

    .site-header{background:linear-gradient(120deg,var(--o1),var(--o2));color:#fff;padding:14px 20px;position:sticky;top:0;z-index:50}
    .site-header .inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
    .site-header a.brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff;font-weight:700;font-size:20px}
    .site-header img{height:38px}
    .btn-ghost{background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.6);color:#fff;border-radius:999px;padding:8px 16px;font-weight:600;cursor:pointer}

    .tabs-bar{background:rgba(255,255,255,.82);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
    .tabs-inner{max-width:1200px;margin:0 auto;display:flex;gap:16px;align-items:center;justify-content:flex-start;padding:10px 12px}
    .tab-btn{border:none;background:none;padding:10px 18px;border-radius:999px;font-weight:600;font-size:15px;color:var(--ink);cursor:pointer;transition:.25s}
    .tab-btn.active{background:linear-gradient(120deg,var(--o1),var(--o2));color:#fff;box-shadow:0 4px 14px rgba(10,27,90,.15)}

    .content-wrap{max-width:1200px;margin:32px auto;padding:0 12px}
    h1.section-title{font-size:26px;margin:0 0 18px}

    .card{background:var(--glass);border:1px solid var(--glass-b);border-radius:14px;box-shadow:0 4px 24px rgba(10,27,90,.06);padding:20px;margin-bottom:18px}
    .btn{padding:10px 18px;border:none;border-radius:999px;background:linear-gradient(120deg,var(--o1),var(--o2));color:#fff;font-weight:700;cursor:pointer}
    .btn-light{padding:10px 14px;border-radius:999px;background:#fff;border:1px solid var(--line);color:var(--ink);font-weight:600;cursor:pointer}
    .btn-danger{background:var(--danger);border:none;color:#fff}
    .tiny{font-size:12px;color:#5b6b86}

    .field{display:flex;flex-direction:column;margin-bottom:10px}
    .field label{font-weight:600;margin-bottom:4px}
    .input{padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .form-row{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    @media(max-width:720px){.form-row{grid-template-columns:1fr}}

    /* Afspraken */
    .day-group{margin:8px 0 14px}
    .day-head{display:flex;align-items:center;gap:10px;margin:0 0 8px;font-weight:700;color:var(--ink)}
    .appt{display:grid;grid-template-columns:110px 1fr auto;gap:12px;align-items:center;padding:10px;border:1px solid var(--line);border-radius:12px;background:#fff;margin-bottom:8px}
    .appt-time{font-weight:700}
    .appt-meta{display:flex;flex-direction:column;gap:3px}
    .appt-actions{display:flex;gap:8px}
    .edit-row{display:grid;grid-template-columns:110px 1fr 1fr auto;gap:8px;align-items:center;padding:10px;border:1px dashed var(--line);border-radius:12px;background:#fcfdff;margin-bottom:8px}

    /* Instellingen */
    .settings{display:grid;grid-template-columns:260px 1fr;gap:14px;align-items:stretch}
    @media(max-width:900px){.settings{grid-template-columns:1fr}}
    .sidenav{background:var(--glass);border:1px solid var(--glass-b);border-radius:14px;padding:8px;min-height:560px}
    .side-item{display:flex;align-items:center;gap:10px;width:100%;border:1px solid transparent;background:transparent;color:var(--ink);font-weight:600;border-radius:12px;padding:12px;cursor:pointer;justify-content:space-between}
    .side-item .label{display:flex;align-items:center;gap:10px}
    .side-item.active{background:linear-gradient(180deg,#fff,#f3f7ff);border-color:var(--glass-b);box-shadow:0 6px 18px rgba(10,27,90,.06)}
    .panel-wrap{min-height:560px}
    .panel{background:var(--glass);border:1px solid var(--glass-b);border-radius:14px;padding:18px}
    .panel h3{margin:0 0 10px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.two{grid-template-columns:1fr}}

    /* Indicatoren / gating */
    .dot{display:none;width:10px;height:10px;border-radius:50%;background:#e23b3b;box-shadow:0 0 0 4px rgba(226,59,59,.15)}
    .dot-green{display:inline-block;width:10px;height:10px;border-radius:50%;background:#0fa958;box-shadow:0 0 0 4px rgba(15,169,88,.15)}
    .banner{display:none;background:#fff4f4;border:1px solid #ffd1d1;color:#8b1f1f;border-radius:12px;padding:12px 14px;margin:0 0 14px;font-weight:600}
    .locked{opacity:.55;pointer-events:none;position:relative}
    .locked:after{content:"ðŸ”’ Betaal je abonnement om dit te gebruiken";position:absolute;inset:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.75);border:1px dashed #e1e7ff;border-radius:12px;font-weight:700}

    .site-footer{margin-top:auto;text-align:center;padding:20px 0;color:#5b6b86;font-size:13px}
    .hide{display:none!important}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .plan{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-block;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-weight:600;cursor:pointer}
    .pill.active{border-color:var(--o1);box-shadow:0 0 0 3px rgba(26,102,255,.12)}
    .save-state{font-size:12px;color:#5b6b86;margin-left:8px}
  </style>
</head>

<body>
<div class="site">
  <header class="site-header">
    <div class="inner">
      <a href="index.html" class="brand"><img src="img/logo.png" alt="">Vrijeplek</a>
      <div>
        <span id="save-state" class="save-state"></span>
        <a href="logout.html" id="btn-logout" class="btn-ghost">Uitloggen</a>

      </div>
    </div>
  </header>

  <div class="tabs-bar">
    <div class="tabs-inner">
      <button class="tab-btn active" data-tab="afspraken">Afspraken</button>
      <button class="tab-btn" data-tab="open">Open tijdsstippen</button>
      <button class="tab-btn" data-tab="website">Website</button>
      <button class="tab-btn" data-tab="instellingen">Instellingen <i id="settings-dot" class="dot"></i></button>
    </div>
  </div>

  <main class="content-wrap">
    <div id="pay-banner" class="banner"></div>

    <h1 id="welcome-wrap" class="section-title">Welkom, <span id="user-firstname">â€”</span> ðŸ‘‹</h1>

    <!-- Afspraken -->
    <section id="tab-afspraken" class="tab-content">
      <div class="card">
        <h2>Jouw afspraken</h2>
        <div id="appointments-list"></div>
        <div class="tiny">Klik op <strong>Bewerken</strong> om een afspraak aan te passen of <strong>Verwijderen</strong> om te annuleren.</div>
      </div>
    </section>

    <!-- Open tijdstippen -->
    <section id="tab-open" class="tab-content" hidden>
      <div class="card">
        <h2>Nieuw tijdstip publiceren</h2>
        <form id="slot-form">
          <div class="form-row">
            <div class="field"><label>Datum</label><input type="date" class="input" id="slot-date"></div>
            <div class="field"><label>Van</label><input type="time" class="input" id="slot-from"></div>
            <div class="field"><label>Tot</label><input type="time" class="input" id="slot-to"></div>
          </div>
          <div class="field"><label>Omschrijving</label><input type="text" class="input" id="slot-desc" placeholder="vb. Snelle beurt of intake"></div>
          <button class="btn" type="submit">Publiceren</button>
        </form>
      </div>
    </section>

    <!-- Website -->
    <section id="tab-website" class="tab-content" hidden>
      <div class="card">
        <h2>Mijn mini-website</h2>
        <p>Hier bouw je binnenkort je eigen pagina op Vrijeplek.</p>
      </div>
    </section>

    <!-- Instellingen -->
    <section id="tab-instellingen" class="tab-content" hidden>
      <div class="settings">
        <div class="sidenav">
          <button class="side-item active" data-side="persoonlijk">
            <span class="label"><i class="dot-green"></i><span>Persoonlijk</span></span>
          </button>
          <button class="side-item" data-side="privacy">
            <span class="label"><i class="dot-green"></i><span>Privacy & locatie</span></span>
          </button>
          <button class="side-item" data-side="zichtbaarheid">
            <span class="label"><i class="dot-green"></i><span>Zichtbaarheid</span></span>
          </button>
          <button class="side-item" data-side="account" id="nav-account">
            <span class="label"><span>Account</span></span>
            <i id="account-dot" class="dot"></i>
          </button>
          <button class="side-item" data-side="notificaties">
            <span class="label"><i class="dot-green"></i><span>Notificaties</span></span>
          </button>
        </div>

        <div class="panel-wrap">
          <div class="panel" id="panel-persoonlijk">
            <h3>Persoonlijk</h3>
            <div class="two">
              <div class="field"><label>Naam (toon op dashboard)</label><input id="st-name" class="input" type="text" placeholder="Voornaam"></div>
              <div class="field"><label>Bedrijfsnaam</label><input id="st-company" class="input" type="text" placeholder="Naam van je zaak"></div>
            </div>
            <div class="two">
              <div class="field"><label>Telefoon</label><input id="st-phone" class="input" type="tel" placeholder="+32 ..."></div>
              <div class="field">
                <label>E-mail (wijziging vereist bevestiging)</label>
                <input id="st-email" class="input" type="email" placeholder="naam@voorbeeld.be">
                <div class="tiny">Als je dit wijzigt, sturen we een bevestigingsmail via Supabase.</div>
              </div>
            </div>
            <div class="two">
              <div class="field"><label>BTW-nummer</label><input id="st-btw" class="input" type="text" placeholder="BE0123456789"></div>
              <div class="field"><label>Categorie</label>
                <select id="st-cat" class="input">
                  <option value="">Kies</option>
                  <option value="horeca">Horeca</option>
                  <option value="wellness">Wellness</option>
                  <option value="zorg">Gezondheid</option>
                  <option value="events">Events</option>
                  <option value="poetsdiensten">Poetsdiensten</option>
                  <option value="ramenwasser">Ramenwasser</option>
                  <option value="dieren">Dieren</option>
                </select>
              </div>
            </div>
            <div class="two">
              <div class="field"><label>Straat + nr.</label><input id="st-straat" class="input" type="text"></div>
              <div class="field"><label>Postcode & gemeente</label><input id="st-postcode" class="input" type="text" placeholder="3500 Hasselt"></div>
            </div>
            <div class="field"><label>Website</label><input id="st-website" class="input" type="url" placeholder="https://voorbeeld.be"></div>
            <div class="field"><label>Korte omschrijving</label><input id="st-bio" class="input" type="text" placeholder="Beschrijf kort je diensten"></div>
            <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
              <button id="st-save-person" class="btn">Opslaan</button>
              <span id="st-msg" class="tiny"></span>
            </div>
          </div>

          <div class="panel hide" id="panel-privacy">
            <h3>Privacy & locatie</h3>
            <div class="two">
              <div class="field">
                <label>Locatie tonen op publieke pagina</label>
                <input id="st-show-location" class="toggle" type="checkbox">
              </div>
              <div class="field">
                <label>Kalender publiek zichtbaar</label>
                <input id="st-public-calendar" class="toggle" type="checkbox">
              </div>
            </div>
            <button id="st-save-privacy" class="btn">Opslaan</button>
          </div>

          <div class="panel hide" id="panel-zichtbaarheid">
            <h3>Zichtbaarheid</h3>
            <div class="two">
              <div class="field"><label>Google reviews tonen</label><input id="st-reviews" class="toggle" type="checkbox"></div>
              <div class="field"><label>Google Place ID / Review-link</label><input id="st-place" class="input" type="text" placeholder="ChIJN1t..."></div>
            </div>
            <button id="st-save-vis" class="btn">Opslaan</button>
          </div>

          <div class="panel hide" id="panel-account">
            <h3>Accountstatus & Betaling</h3>
            <div id="acc-status" class="tiny" style="margin-bottom:10px">Status: <strong>â€”</strong></div>
            <div class="sep"></div>
            <div class="field">
              <label>Plan</label>
              <div id="plan-wrap" class="plan">
                <button type="button" class="pill" data-plan="monthly">â‚¬19,25 / maand</button>
                <button type="button" class="pill" data-plan="yearly">â‚¬180 / jaar</button>
              </div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
              <button id="btn-activate" class="btn">Activeer abonnement</button>
              <a id="last-checkout-url" class="tiny" href="#" target="_blank" style="display:none">Laatste betaallink openen</a>
            </div>
            <div class="tiny" style="margin-top:8px">Je gegevens worden pas publiek na activatie.</div>
          </div>

          <div class="panel hide" id="panel-notificaties">
            <h3>Notificaties</h3>
            <div class="two">
              <div class="field"><label>Nieuwe reservatie per e-mail</label><input id="st-notify-mail" class="toggle" type="checkbox"></div>
              <div class="field"><label>Dagelijkse agenda per e-mail</label><input id="st-daily-mail" class="toggle" type="checkbox"></div>
            </div>
            <button id="st-save-notify" class="btn">Opslaan</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">Â© 2025 Vrijeplek. Alle rechten voorbehouden.</footer>
</div>

<script type="module">
  // ---------- Supabase defensief ----------
  async function initSupabase(){
    try{
      const ok = !!(window.env?.SUPABASE_URL && window.env?.SUPABASE_ANON_KEY);
      if(!ok) return null;
      const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
      return createClient(window.env.SUPABASE_URL, window.env.SUPABASE_ANON_KEY, { auth:{ persistSession:true, autoRefreshToken:true } });
    }catch{ return null; }
  }
  window.__supabase = await initSupabase();

  // ---------- UI refs ----------
  const $ = (s)=>document.querySelector(s);
  const els = {
    welcomeWrap: $('#welcome-wrap'),
    userFirst: $('#user-firstname'),
    payBanner: $('#pay-banner'),
    settingsDot: $('#settings-dot'),
    accountDot: $('#account-dot'),
    sections: { open: $('#tab-open'), website: $('#tab-website') },
    apptList: $('#appointments-list'),
    planPills: document.querySelectorAll('#plan-wrap .pill'),
    accStatus: $('#acc-status'),
    btnActivate: $('#btn-activate'),
    lastCheckout: $('#last-checkout-url'),
    saveState: $('#save-state'),
    st: {
      name: $('#st-name'), company: $('#st-company'), phone: $('#st-phone'),
      email: $('#st-email'), btw: $('#st-btw'), cat: $('#st-cat'),
      straat: $('#st-straat'), postcode: $('#st-postcode'),
      website: $('#st-website'), bio: $('#st-bio'), msg: $('#st-msg')
    }
  };

  // ---------- Tabs ----------
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(sec=> sec.hidden = (sec.id !== 'tab-'+id));
    });
  });

  // ---------- Sidenav ----------
  const sideBtns = document.querySelectorAll('.side-item');
  const sidePanels = { persoonlijk: $('#panel-persoonlijk'), privacy: $('#panel-privacy'), zichtbaarheid: $('#panel-zichtbaarheid'), account: $('#panel-account'), notificaties: $('#panel-notificaties') };
  sideBtns.forEach(b=>{
    b.addEventListener('click', ()=>{
      sideBtns.forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const key = b.dataset.side;
      Object.entries(sidePanels).forEach(([k,p])=> p.classList.toggle('hide', k!==key));
    });
  });

  // ---------- Logout die ALTIJD werkt ----------
  const hardGo = (url)=>{ try{ location.replace(url) }catch{ location.href=url } };
  async function logoutAlways(){
    try{ await window.__supabase?.auth?.signOut(); }catch{}
    try{ sessionStorage.clear(); localStorage.removeItem('vp.profile.draft'); }catch{}
    hardGo('login.html');
  }
  document.getElementById('btn-logout')?.addEventListener('click', logoutAlways);

  // ---------- Session + user ----------
  function firstNameFrom(user){
    try{
      const meta = user?.user_metadata?.display_name || user?.user_metadata?.name || user?.user_metadata?.full_name || '';
      const metaFirst = (meta||'').split(/[.\s_-]/)[0]?.trim();
      const mailFirst = (user?.email||'').split('@')[0]?.trim();
      const blacklist = ['info','contact','admin','hello','hallo','sales','support'];
      const c = (metaFirst && metaFirst.length>1 ? metaFirst : mailFirst) || '';
      const lower = c.toLowerCase();
      if(!c || blacklist.includes(lower) || lower.length<2) return '';
      return c.charAt(0).toUpperCase()+c.slice(1);
    }catch{ return ''; }
  }

  let __origEmail = '';
  async function ensureSession(){
    if(!window.__supabase){
      els.welcomeWrap.classList.add('hide');
      window.__email = '';
      await afterProfileLoaded(); // gate pending
      return;
    }
    try{
      const { data:{ session } } = await window.__supabase.auth.getSession();
      if(session?.user){ applyUser(session.user); return; }
      // wacht max 1.2s op state change, anders naar login
      const to = setTimeout(()=>hardGo('login.html'), 1200);
      window.__supabase.auth.onAuthStateChange((_e, s)=>{ if(s?.user){ clearTimeout(to); applyUser(s.user); }});
    }catch{ await afterProfileLoaded(); }
  }

  function applyUser(user){
    const f = firstNameFrom(user);
    if(f){ els.userFirst.textContent = f; els.welcomeWrap.classList.remove('hide'); }
    else { els.welcomeWrap.classList.add('hide'); }
    els.st.email.value = user?.email || '';
    __origEmail = user?.email || '';
    if(!els.st.name.value) els.st.name.value = f || '';
    window.__email = user?.email || '';

    restoreDraft();          // 1) zet lokale backup terug (voelt direct snappy)
    loadProfile(window.__email).then(()=> { fillDraftGaps(); afterProfileLoaded(); }); // 2) vul aan met serverdata
    loadAppointments();
  }

  // ---------- Profile persistence (LIVE + backup) ----------
  const DRAFT_KEY = 'vp.profile.draft';

  function getPayload(){
    return {
      email: (els.st.email.value||'').trim(),
      zaak: els.st.company.value.trim(),
      telefoon: els.st.phone.value.trim(),
      btw: els.st.btw.value.trim(),
      cat: els.st.cat.value.trim(),
      straat: els.st.straat.value.trim(),
      postcode: els.st.postcode.value.trim(),
      website: els.st.website.value.trim(),
      bio: els.st.bio.value.trim()
    };
  }

  function setSaveState(txt){ els.saveState.textContent = txt || ''; }

  function saveDraft(){
    try{ localStorage.setItem(DRAFT_KEY, JSON.stringify(getPayload())); }catch{}
    setSaveState('Bewaard (lokaal)â€¦');
  }

  function restoreDraft(){
    try{
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      const d = JSON.parse(raw);
      if(d?.email) els.st.email.value = d.email;
      if(d?.zaak) els.st.company.value = d.zaak;
      if(d?.telefoon) els.st.phone.value = d.telefoon;
      if(d?.btw) els.st.btw.value = d.btw;
      if(d?.cat) els.st.cat.value = d.cat;
      if(d?.straat) els.st.straat.value = d.straat;
      if(d?.postcode) els.st.postcode.value = d.postcode;
      if(d?.website) els.st.website.value = d.website;
      if(d?.bio) els.st.bio.value = d.bio;
      setSaveState('Teruggezet (lokaal)â€¦');
    }catch{}
  }

  function fillDraftGaps(){
    // Serverdata overschrijft enkel lege velden (zodat wat je net typte niet verdwijnt)
    const fields = [
      ['company','zaak'], ['phone','telefoon'], ['btw','btw'], ['cat','cat'],
      ['straat','straat'], ['postcode','postcode'], ['website','website'], ['bio','bio']
    ];
    fields.forEach(([elKey, srvKey])=>{
      if(!els.st[elKey].value && window.__profile?.[srvKey]){
        els.st[elKey].value = window.__profile[srvKey] || '';
      }
    });
    if(!els.st.email.value && window.__profile?.email) els.st.email.value = window.__profile.email;
  }

  function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

  async function saveEmailIfChanged(){
    const newEmail = (els.st.email.value || '').trim();
    if(!newEmail || newEmail === __origEmail) return { changed:false, ok:true };
    if(!window.__supabase) return { changed:true, ok:false, msg:'Geen Supabase; e-mail niet aangepast in auth.' };
    try{
      const { error } = await window.__supabase.auth.updateUser({ email: newEmail });
      if(error) return { changed:true, ok:false, msg:error.message||'Kon e-mail niet wijzigen' };
      __origEmail = newEmail;
      return { changed:true, ok:true };
    }catch(e){ return { changed:true, ok:false, msg:String(e?.message||e) }; }
  }

  async function saveProfileLive(){
    setSaveState('Opslaanâ€¦');
    const emailRes = await saveEmailIfChanged(); // triggert bevestigingsmail indien gewijzigd
    const payload = getPayload();

    try{
      const r = await fetch('/.netlify/functions/profile', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const ok = r.ok;
      if(ok){
        // server heeft het: lokale draft mag weg
        try{ localStorage.removeItem(DRAFT_KEY); }catch{}
        setSaveState('Opgeslagen âœ”');
      }else{
        // server niet ok: laat lokale backup staan
        const t = await r.text().catch(()=>r.status);
        setSaveState('Niet opgeslagen (server) â€” lokaal bewaard');
        console.warn('Profile save failed:', t);
      }
    }catch(e){
      setSaveState('Offline â€” lokaal bewaard');
    }
  }

  const autoSave = debounce(()=>{ saveDraft(); saveProfileLive(); }, 900);

  // Hook op alle inputvelden (live autosave)
  [
    els.st.name, els.st.company, els.st.phone, els.st.email, els.st.btw, els.st.cat,
    els.st.straat, els.st.postcode, els.st.website, els.st.bio
  ].forEach(inp=>{
    inp?.addEventListener('input', autoSave);
    inp?.addEventListener('change', autoSave);
  });

  // Handmatige â€œOpslaanâ€ knop blijft bestaan
  document.getElementById('st-save-person')?.addEventListener('click', ()=>{ saveDraft(); saveProfileLive(); });

  // Waarschuw bij navigeren als er een draft is die nog niet server-bevestigd is
  window.addEventListener('beforeunload', (e)=>{
    const raw = localStorage.getItem(DRAFT_KEY);
    if(raw){ e.preventDefault(); e.returnValue = ''; }
  });

  // ---------- Profile GET ----------
  async function loadProfile(email){
    try{
      const r = await fetch('/.netlify/functions/profile' + (email ? ('?email=' + encodeURIComponent(email)) : ''));
      if(!r.ok) throw new Error('profile not ok');
      const d = await r.json();
      window.__profile = d || {};
      els.st.company.value ||= d?.zaak || '';
      els.st.phone.value   ||= d?.telefoon || '';
      els.st.btw.value     ||= d?.btw || '';
      els.st.cat.value     ||= d?.cat || '';
      els.st.straat.value  ||= d?.straat || '';
      els.st.postcode.value||= d?.postcode || '';
      els.st.website.value ||= d?.website || '';
      els.st.bio.value     ||= d?.bio || '';

      window.__plan   = d?.plan || 'monthly';
      window.__status = d?.account_status || 'pending';
    }catch{
      window.__plan = 'monthly';
      window.__status = 'pending';
    }
  }

  // ---------- Betalen ----------
  function selectPlan(plan){
    window.__plan = plan;
    els.planPills.forEach(p=> p.classList.toggle('active', p.dataset.plan===plan));
  }
  els.planPills.forEach(p=> p.addEventListener('click', ()=> selectPlan(p.dataset.plan)));
  async function payNow(){
    try{
      els.btnActivate.disabled = true;
      els.btnActivate.textContent = 'Link maken...';
      const body = { email: (els.st.email.value||'').trim(), plan: window.__plan || 'monthly' };
      const r = await fetch('/.netlify/functions/create-checkout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
      const d = await r.json().catch(()=>null);
      const url = d?.url;
      if(url){
        els.lastCheckout.href = url;
        els.lastCheckout.style.display = 'inline';
        location.href = url;
      }else{
        alert('Betaallink niet beschikbaar.');
      }
    }catch{ alert('Kon betaallink niet ophalen.'); }
    finally{ els.btnActivate.disabled = false; els.btnActivate.textContent = 'Activeer abonnement'; }
  }
  els.btnActivate.addEventListener('click', payNow);

    // ---------- Gating ----------
function gateUI(status, plan){
  const active = (status === 'active');

  // NIET-actief â†’ onmiddellijk naar abonnement-pagina sturen
  if (!active) {
    try {
      window.location.href = 'abonnement.html';
    } catch (e) {
      location.href = 'abonnement.html';
    }
    return;
  }

  // === ACCOUNT IS ACTIEF ===

  // Status: mooi groen "Actief"
  els.accStatus.innerHTML = `Status: <strong style="color:#0fa958;">Actief</strong> â€” plan: <strong>${plan || 'â€”'}</strong>`;

  // Verberg waarschuwingen
  els.settingsDot.style.display = 'none';
  els.payBanner.style.display = 'none';
  if (els.accountDot?.style) els.accountDot.style.display = 'none';

  // Tabs vrijgeven
  els.sections.open?.classList.remove('locked');
  els.sections.website?.classList.remove('locked');

  // --- KNOP OMWISSEN NAAR "GEABONNEERD" ---
  els.btnActivate.disabled = true;
  els.btnActivate.style.opacity = "0.6";
  els.btnActivate.style.cursor = "default";
  els.btnActivate.style.background = "#0fa958";  // groen
  els.btnActivate.textContent = "Geabonneerd âœ”";

  // Laatste checkout link verbergen
  els.lastCheckout.style.display = 'none';

  // Plan highlighten
  selectPlan(plan || 'monthly');
}



  // ---------- Agenda dummy ----------
  function groupByDate(items){ const map={}; items.forEach(x=>{ (map[x.date] ||= []).push(x); }); Object.values(map).forEach(arr=> arr.sort((a,b)=> a.time.localeCompare(b.time))); return Object.keys(map).sort().map(d=>({ date:d, items: map[d] })); }
  function formatDateLabel(iso){ try{ return new Date(iso+'T00:00:00').toLocaleDateString('nl-BE',{weekday:'long',day:'2-digit',month:'long'}) }catch{ return iso } }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  let appts = [];
  function viewRow(item){
    const row=document.createElement('div'); row.className='appt'; row.dataset.id=item.id;
    const t=document.createElement('div'); t.className='appt-time'; t.textContent=item.time;
    const meta=document.createElement('div'); meta.className='appt-meta';
    const p1=document.createElement('div'); p1.innerHTML=`<strong>${escapeHtml(item.client||'â€”')}</strong> â€” ${escapeHtml(item.purpose||'')}`;
    const p2=document.createElement('div'); p2.className='tiny'; p2.textContent=item.note||'';
    meta.appendChild(p1); meta.appendChild(p2);
    const actions=document.createElement('div'); actions.className='appt-actions';
    const bEdit=document.createElement('button'); bEdit.className='btn-light'; bEdit.textContent='Bewerken';
    const bDel=document.createElement('button'); bDel.className='btn-danger'; bDel.textContent='Verwijderen';
    bEdit.addEventListener('click',()=> startEdit(item.id));
    bDel.addEventListener('click',()=> deleteAppt(item.id));
    actions.appendChild(bEdit); actions.appendChild(bDel);
    row.appendChild(t); row.appendChild(meta); row.appendChild(actions);
    return row;
  }
  function editRow(item){
    const row=document.createElement('div'); row.className='edit-row'; row.dataset.id=item.id;
    const t=document.createElement('input'); t.className='input'; t.type='time'; t.value=item.time;
    const client=document.createElement('input'); client.className='input'; client.type='text'; client.value=item.client||'';
    const purpose=document.createElement('input'); purpose.className='input'; purpose.type='text'; purpose.placeholder='Omschrijving'; purpose.value=item.purpose||'';
    const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
    const bSave=document.createElement('button'); bSave.className='btn'; bSave.textContent='Opslaan';
    const bCancel=document.createElement('button'); bCancel.className='btn-light'; bCancel.textContent='Annuleren';
    bSave.addEventListener('click',()=> saveAppt({ id:item.id, date:item.date, time:t.value, client:client.value.trim(), purpose:purpose.value.trim(), note:item.note||'' }));
    bCancel.addEventListener('click',()=> cancelEdit(item.id));
    row.appendChild(t); row.appendChild(client); row.appendChild(purpose); row.appendChild(actions);
    actions.appendChild(bSave); actions.appendChild(bCancel);
    return row;
  }
  function renderAppointments(list){
    const wrap=els.apptList; wrap.innerHTML='';
    const groups=groupByDate(list);
    if(!groups.length){ const e=document.createElement('div'); e.className='tiny'; e.textContent='Nog geen afspraken.'; wrap.appendChild(e); return; }
    groups.forEach(g=>{
      const w=document.createElement('div'); w.className='day-group';
      const h=document.createElement('div'); h.className='day-head'; h.textContent=formatDateLabel(g.date);
      w.appendChild(h);
      g.items.forEach(item=> w.appendChild(item.__editing ? editRow(item) : viewRow(item)));
      wrap.appendChild(w);
    });
  }
  function startEdit(id){ const x=appts.find(a=>a.id===id); if(x){ x.__editing=true; renderAppointments(appts); } }
  function cancelEdit(id){ const x=appts.find(a=>a.id===id); if(x){ delete x.__editing; renderAppointments(appts); } }
  async function saveAppt(payload){
    try{
      await fetch('/.netlify/functions/appointments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ action:'update', ...payload })});
      const i=appts.findIndex(a=>a.id===payload.id);
      if(i>-1){ appts[i]={...appts[i],...payload}; delete appts[i].__editing; }
      renderAppointments(appts);
    }catch{}
  }
  async function deleteAppt(id){
    if(!confirm('Deze afspraak verwijderen?')) return;
    try{
      await fetch('/.netlify/functions/appointments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ action:'delete', id })});
      appts = appts.filter(a=>a.id!==id);
      renderAppointments(appts);
    }catch{}
  }
  async function loadAppointments(){
    try{
      const r=await fetch('/.netlify/functions/appointments?action=list');
      const d=await r.json().catch(()=>[]);
      appts = Array.isArray(d)?d:[];
    }catch{ appts=[]; }
    renderAppointments(appts);
  }

  // ---------- Start ----------
  await ensureSession();
</script>
</body>
</html>
