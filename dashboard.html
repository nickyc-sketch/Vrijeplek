<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard â€” Vrijeplek</title>

  <!-- Fonts + globale stijl -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css?v=smurf6" />

  <style>
    /* Subtiele header-lijn */
    .site-header::after {
      content: ""; position: absolute; inset: auto 0 0 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.45), transparent); opacity: .6;
    }

    .wrap { max-width: 1200px; margin-inline: auto; padding: 24px 12px 64px; }
    .welcome { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: 6px 0 16px; }
    .welcome h1 { margin: 0; font-size: 22px; color: var(--blue-900); }
    .subtitle { margin: 0; color: #1f2a44; }

    /* Tabs */
    .tabs { position: sticky; top: 64px; z-index: 10; margin: 10px 0 18px; }
    .tabbar {
      display: flex; gap: 8px; flex-wrap: wrap; align-items: center; justify-content: space-between;
      padding: 8px; border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.35));
      border: 1px solid rgba(26,102,255,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55), 0 8px 24px rgba(10,27,90,.08);
    }
    .tabbar-left { display:flex; gap:8px; flex-wrap: wrap; align-items:center; }
    .tabbar button {
      appearance: none; border: 1px solid transparent; background: transparent; color: #0a2a4a;
      padding: 10px 14px; border-radius: 999px; font-weight: 700; letter-spacing: .2px; cursor: pointer;
    }
    .tabbar button[aria-selected="true"] {
      background: linear-gradient(120deg, rgba(26,102,255,.18), rgba(0,86,255,.28));
      border-color: rgba(26,102,255,.28); box-shadow: 0 6px 16px rgba(10,27,90,.12);
    }
    .logout-btn {
      appearance:none; border:1px solid rgba(26,102,255,.28); background:#fff; color:#0a2a4a;
      padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer;
    }
    .logout-btn:hover { border-color: rgba(26,102,255,.45); }

    /* Panels */
    [role="tabpanel"][hidden] { display: none !important; }

    /* Cards / grids */
    .card {
      padding: 14px; border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.35));
      border: 1px solid rgba(26,102,255,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.55), 0 8px 30px rgba(10,27,90,.08);
    }
    .card-head {
      display: flex; align-items: center; justify-content: space-between; gap: 12px;
      padding: 10px 12px; margin: -6px -6px 10px; border-radius: 12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.35)),
        linear-gradient(120deg, rgba(26,102,255,.18), rgba(0,86,255,.28));
      border: 1px solid rgba(26,102,255,.28); box-shadow: inset 0 1px 0 rgba(255,255,255,.55);
    }
    .card-head h3 { font-size: 15px; margin: 0; color: var(--blue-900); letter-spacing: .2px; }
    .badge {
      display: inline-flex; align-items: center; gap: 8px; padding: 4px 10px; border-radius: 999px;
      font-weight: 700; font-size: 12px; background: linear-gradient(180deg, #fff, #f5f9ff);
      border: 1px solid rgba(26,102,255,.28); box-shadow: 0 4px 12px rgba(10,27,90,.10); color: var(--blue-900);
    }
    .badge-dot { width: 8px; height: 8px; border-radius: 50%; background: conic-gradient(from 200deg, var(--blue-300), var(--blue-600)); box-shadow: 0 0 0 4px rgba(26,102,255,.12); }
    .soft-divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(26,102,255,.18), transparent); margin: 8px 0 2px; }
    .tiny-note { font-size: 12px; color: #5b6b86; }

    .grid { display: grid; gap: 14px; grid-template-columns: 2fr 1fr; }
    .kpi-grid { display: grid; gap: 14px; grid-template-columns: repeat(2,1fr); }
    .kpi { display:flex; align-items:baseline; gap:10px; }
    .kpi .value { font-size: 30px; font-weight: 700; color: var(--blue-900); letter-spacing: .2px; }
    .kpi .sub { font-size:12px; color:#5b6b86; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    thead th { text-align: left; font-size: 12px; color: #3a4b6a; padding: 8px 10px; border-bottom: 1px solid rgba(26,102,255,.22); }
    tbody td { padding: 10px; font-size: 14px; border-bottom: 1px dashed rgba(26,102,255,.16); }
    tbody tr:last-child td { border-bottom: none; }

    .row { display: flex; gap: 10px; }
    .row > * { flex: 1; }
    .submit-zone { display: flex; gap: 10px; align-items: center; }

    .progress { height: 10px; border-radius: 999px; background: rgba(26,102,255,.12); overflow: hidden; }
    .progress > i { display: block; height: 100%; background: linear-gradient(90deg, rgba(26,102,255,.6), rgba(0,86,255,.85)); width: 0%; transition: width .5s ease; }

    /* Website builder */
    .builder { display: grid; gap: 12px; }
    .builder .two { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .builder .preview { border-radius: 12px; border: 1px solid rgba(26,102,255,.22); background: #fff; overflow: hidden; }
    .builder iframe { width: 100%; height: 420px; border: 0; background: #fff; }
    @keyframes sheen { from { background-position:-200% 0 } to { background-position:200% 0 } }
    .sheen { background-image: linear-gradient(120deg,transparent,rgba(255,255,255,.6),transparent); background-size: 200% 100%; animation: sheen 2s linear infinite; }

    @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
    @media (max-width: 720px)  { .kpi-grid { grid-template-columns: 1fr; } .builder .two { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="site">
    <!-- HEADER -->
    <header class="site-header">
      <div class="header-inner">
        <a href="index.html" class="brand" style="text-decoration:none;display:flex;align-items:center;gap:10px;">
          <img src="img/logo.png" alt="Vrijeplek logo" style="height:40px;" onerror="this.remove()">
          <span class="brand-name">Vrijeplek</span>
          <span class="brand-dot"></span>
        </a>
        <nav class="header-actions">
          <a class="nav-btn" href="waarom.html">Waarom Vrijeplek?</a>
          <a class="nav-btn" href="hoe.html">Hoe werkt het?</a>
          <a class="nav-btn" href="aanmelden.html">Word lid</a>
          <a class="nav-btn" href="login.html">Login</a>
        </nav>
      </div>
    </header>

    <!-- MAIN -->
    <main class="wrap">
      <!-- Welkom -->
      <div class="welcome">
        <div>
          <h1>Welkom, <span id="user-first">â€”</span> ðŸ‘‹</h1>
          <p class="subtitle">Beheer je vrije momenten, reservaties, mini-website en abonnement.</p>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs" role="tablist" aria-label="Dashboard secties">
        <div class="tabbar">
          <div class="tabbar-left">
            <button role="tab" aria-selected="true"  data-tab="vrijemomenten" id="tab-vrijemomenten">Vrije momenten</button>
            <button role="tab" aria-selected="false" data-tab="reservaties"    id="tab-reservaties">Reservaties</button>
            <button role="tab" aria-selected="false" data-tab="website"        id="tab-website">Website</button>
            <button role="tab" aria-selected="false" data-tab="profiel"        id="tab-profiel">Profiel</button>
            <button role="tab" aria-selected="false" data-tab="abonnement"     id="tab-abonnement">Abonnement</button>
          </div>
          <button id="btn-logout" class="logout-btn" title="Uitloggen">Uitloggen</button>
        </div>
      </div>

      <!-- Panel: Vrije momenten -->
      <section id="panel-vrijemomenten" role="tabpanel" aria-labelledby="tab-vrijemomenten">
        <div class="kpi-grid">
          <div class="card">
            <div class="card-head"><h3>Vrije momenten</h3><span class="badge"><span class="badge-dot"></span> Live</span></div>
            <div class="kpi"><div class="value" id="kpi-free">0</div><div class="sub">gepland</div></div>
          </div>
          <div class="card">
            <div class="card-head"><h3>Reserveringen</h3><span class="badge">30 d</span></div>
            <div class="kpi"><div class="value" id="kpi-bookings">0</div><div class="sub">nieuwe</div></div>
          </div>
        </div>

        <div class="grid" style="margin-top:16px;">
          <div>
            <div class="card">
              <div class="card-head"><h3>Aankomende afspraken</h3><span class="badge">Overzicht</span></div>
              <table aria-label="Aankomende afspraken">
                <thead><tr><th>Datum</th><th>Tijd</th><th>Klant</th><th>Notities</th></tr></thead>
                <tbody id="appt-body"><tr><td colspan="4" style="color:#5b6b86;">Nog geen afsprakenâ€¦</td></tr></tbody>
              </table>
            </div>

            <div class="card" style="margin-top:14px;">
              <div class="card-head"><h3>Vrij moment publiceren</h3><span class="badge"><span class="badge-dot"></span> Snel</span></div>
              <div class="row" style="margin-bottom:10px;">
                <div class="field"><label for="slot-date">Datum</label><input id="slot-date" type="date" class="input"></div>
                <div class="field"><label for="slot-from">Van</label><input id="slot-from" type="time" class="input"></div>
                <div class="field"><label for="slot-to">Tot</label><input id="slot-to" type="time" class="input"></div>
              </div>
              <div class="row">
                <div class="field"><label for="slot-cap">Capaciteit</label><input id="slot-cap" type="number" min="1" value="1" class="input"></div>
                <div class="field"><label for="slot-note">Omschrijving</label><input id="slot-note" type="text" placeholder="vb. Snelle beurt of intake" class="input"></div>
              </div>
              <div class="soft-divider"></div>
              <div class="submit-zone">
                <button id="btn-publish" class="btn">Publiceer</button>
                <button id="btn-clear" class="btn btn-ghost">Leegmaken</button>
                <span id="slot-msg" class="tiny-note"></span>
              </div>
            </div>
          </div>

          <aside>
            <div class="card">
              <div class="card-head"><h3>Profielstatus</h3><span class="badge">Checklist</span></div>
              <ul style="margin:0; padding-left:18px;">
                <li id="chk-email">E-mail bevestigd</li>
                <li id="chk-btw">BTW-nummer geverifieerd</li>
                <li id="chk-cat">Categorie ingevuld</li>
              </ul>
              <div class="soft-divider"></div>
              <div class="progress" aria-label="Profiel compleetheid"><i id="progress-bar" style="width:0%"></i></div>
              <p class="tiny-note" id="progress-text" style="margin-top:6px;">0% compleet</p>
            </div>
          </aside>
        </div>
      </section>

      <!-- Panel: Reservaties -->
      <section id="panel-reservaties" role="tabpanel" aria-labelledby="tab-reservaties" hidden>
        <div class="card">
          <div class="card-head"><h3>Reservaties</h3><span class="badge">Overzicht</span></div>
          <table aria-label="Aankomende afspraken">
            <thead><tr><th>Datum</th><th>Tijd</th><th>Klant</th><th>Notities</th></tr></thead>
            <tbody id="appt-body-2"><tr><td colspan="4" style="color:#5b6b86;">Nog geen afsprakenâ€¦</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- Panel: Website -->
      <section id="panel-website" role="tabpanel" aria-labelledby="tab-website" hidden>
        <div class="card">
          <div class="card-head"><h3>Mini-website</h3><span class="badge sheen">Builder</span></div>
          <div class="builder">
            <div class="two">
              <div class="field"><label for="wb-title">Titel</label><input id="wb-title" type="text" class="input" placeholder="Naam van je zaak"></div>
              <div class="field"><label for="wb-tag">Tagline</label><input id="wb-tag" type="text" class="input" placeholder="Korte slagzin"></div>
            </div>
            <div class="two">
              <div class="field">
                <label for="wb-slug">Adres (slug)</label>
                <input id="wb-slug" type="text" class="input" placeholder="bv. kapper-els" />
                <div class="hint tiny-note">Wordt: https://www.vrijeplek.be/websitevanklant/<b id="wb-slug-preview">â€”</b></div>
              </div>
              <div class="field">
                <label for="wb-theme">Thema</label>
                <select id="wb-theme" class="input">
                  <option value="ocean">Ocean (glas)</option>
                  <option value="light">Licht</option>
                </select>
              </div>
            </div>
            <div class="field"><label for="wb-about">Over ons</label><textarea id="wb-about" class="input" rows="4" placeholder="Korte intro over je zaak"></textarea></div>
            <div class="field"><label for="wb-services">Diensten (komma-gescheiden)</label><input id="wb-services" class="input" placeholder="Knippen, Kleuren, Baardtrim"></div>
            <div class="two">
              <div class="field"><label for="wb-phone">Telefoon</label><input id="wb-phone" class="input" placeholder="+32 â€¦"></div>
              <div class="field"><label for="wb-site">Website (optioneel)</label><input id="wb-site" class="input" placeholder="https://"></div>
            </div>
            <div class="two">
              <div class="field"><label for="wb-place">Google Place ID / Review-link</label><input id="wb-place" class="input" placeholder="ChIJN1t_tDeuEmsRUsoyG83frY4"></div>
              <div class="field" style="display:flex;align-items:flex-end;gap:10px;">
                <label style="display:flex;align-items:center;gap:8px;"><input id="wb-gr-on" type="checkbox"/><span>Google reviews tonen</span></label>
                <label style="display:flex;align-items:center;gap:8px;"><input id="wb-public" type="checkbox"/><span>Tonen op Vrijeplek</span></label>
              </div>
            </div>
            <div class="soft-divider"></div>
            <div class="submit-zone">
              <button id="wb-save" class="btn">Opslaan & publiceren</button>
              <a id="wb-view" class="btn btn-ghost" href="#" target="_blank" rel="noopener">Bekijken</a>
              <span id="wb-msg" class="tiny-note"></span>
            </div>
            <div class="preview"><iframe id="wb-iframe" title="Voorbeeld"></iframe></div>
          </div>
        </div>
      </section>

      <!-- Panel: Profiel -->
      <section id="panel-profiel" role="tabpanel" aria-labelledby="tab-profiel" hidden>
        <div class="card">
          <div class="card-head"><h3>Mijn gegevens</h3><span class="badge">Account</span></div>
          <div class="row">
            <div class="field"><label>E-mail</label><input id="pf-email" class="input" disabled></div>
            <div class="field"><label>Naam</label><input id="pf-name" class="input" placeholder="Voornaam en/of zaak"></div>
          </div>
          <div class="row">
            <div class="field"><label>Telefoon</label><input id="pf-phone" class="input" placeholder="+32 â€¦"></div>
            <div class="field"><label>Categorie</label><input id="pf-cat" class="input" placeholder="bv. Ramenwasser"></div>
          </div>
          <div class="soft-divider"></div>
          <div class="submit-zone">
            <button id="pf-save" class="btn">Opslaan</button>
            <span id="pf-msg" class="tiny-note"></span>
          </div>
        </div>
      </section>

      <!-- Panel: Abonnement -->
      <section id="panel-abonnement" role="tabpanel" aria-labelledby="tab-abonnement" hidden>
        <div class="card">
          <div class="card-head"><h3>Abonnement</h3><span class="badge">Plan</span></div>
          <p style="margin:6px 0 10px;">Huidig plan: <strong id="plan-name">Gratis proef</strong><br><span class="tiny-note">Eindigt op <span id="plan-end">â€”</span></span></p>
          <div class="submit-zone">
            <a href="/billing.html" class="btn">Beheer abonnement</a>
            <button id="btn-logout-2" class="btn btn-ghost">Uitloggen</button>
          </div>
        </div>
      </section>
    </main>

    <!-- FOOTER -->
    <footer class="site-footer">
      <div class="footer-inner">
        <p>Â© 2025 Vrijeplek. Alle rechten voorbehouden.</p>
        <nav class="footer-nav">
          <a href="voorwaarden.html">Algemene voorwaarden</a>
          <a href="#privacy">Privacy</a>
          <a href="#contact">Contact</a>
        </nav>
      </div>
    </footer>
  </div>

  <!-- Optioneel: /js/config.js met window.VRIJEPLEK = { SUPABASE_URL, SUPABASE_ANON_KEY } -->
  <script src="/js/config.js"></script>

  <!-- Supabase + dashboard logic -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // ================== Supabase init ==================
    const SUPABASE_URL = window.VRIJEPLEK?.SUPABASE_URL || 'https://JOUW-PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = window.VRIJEPLEK?.SUPABASE_ANON_KEY || 'JOUW_PUBLIC_ANON_KEY';
    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // ================== Sessiescheck + naam ==================
    const { data: { session } } = await supa.auth.getSession();
    if (!session) {
      window.location.href = '/login.html';
      throw new Error('Geen sessie');
    }

    const user = session.user;
    const email = user?.email || '';
    const fullname = user?.user_metadata?.full_name || user?.user_metadata?.name || '';
    const first = (fullname || email.split('@')[0] || '').split(/[\s._-]/)[0] || 'gebruiker';
    document.getElementById('user-first').textContent = first.charAt(0).toUpperCase() + first.slice(1);

    // Profiel velden vullen
    document.getElementById('pf-email').value = email;
    document.getElementById('pf-name').value = fullname || first;

    // ================== Tabs ==================
    const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
    const panels = {
      vrijemomenten: document.getElementById('panel-vrijemomenten'),
      reservaties: document.getElementById('panel-reservaties'),
      website: document.getElementById('panel-website'),
      profiel: document.getElementById('panel-profiel'),
      abonnement: document.getElementById('panel-abonnement')
    };

    function showTab(key) {
      tabs.forEach(b => b.setAttribute('aria-selected', String(b.dataset.tab === key)));
      Object.entries(panels).forEach(([k, el]) => el.hidden = (k !== key));
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    tabs.forEach(btn => {
      btn.addEventListener('click', () => showTab(btn.dataset.tab));
      btn.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
          const i = tabs.indexOf(btn);
          const n = e.key === 'ArrowRight' ? (i + 1) % tabs.length : (i - 1 + tabs.length) % tabs.length;
          tabs[n].focus();
        }
      });
    });
    showTab('vrijemomenten');

    // ================== Vrije momenten demo handlers ==================
    const apptBody = document.getElementById('appt-body');
    function renderAppts(rows) {
      apptBody.innerHTML = '';
      if (!rows.length) {
        apptBody.innerHTML = '<tr><td colspan="4" style="color:#5b6b86;">Nog geen afsprakenâ€¦</td></tr>';
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date||'-'}</td><td>${r.time||'-'}</td><td>${r.client||'-'}</td><td>${r.note||''}</td>`;
        apptBody.appendChild(tr);
      });
    }
    renderAppts([]); // leeg

    const slot = {
      date: document.getElementById('slot-date'),
      from: document.getElementById('slot-from'),
      to: document.getElementById('slot-to'),
      cap: document.getElementById('slot-cap'),
      note: document.getElementById('slot-note'),
      msg: document.getElementById('slot-msg'),
      publish: document.getElementById('btn-publish'),
      clear: document.getElementById('btn-clear'),
    };
    slot.publish.addEventListener('click', async ()=>{
      slot.msg.textContent = 'Versturenâ€¦';
      // TODO: POST naar eigen function (/.netlify/functions/slots_upsert)
      await new Promise(r => setTimeout(r, 500));
      slot.msg.textContent = 'Gepubliceerd âœ…';
    });
    slot.clear.addEventListener('click', ()=>{
      ['date','from','to','cap','note'].forEach(k => slot[k].value = (k==='cap' ? 1 : ''));
      slot.msg.textContent = '';
    });

    // ================== Profiel opslaan (placeholder) ==================
    const pf = {
      name: document.getElementById('pf-name'),
      phone: document.getElementById('pf-phone'),
      cat: document.getElementById('pf-cat'),
      save: document.getElementById('pf-save'),
      msg: document.getElementById('pf-msg')
    };
    pf.save.addEventListener('click', async ()=>{
      pf.msg.textContent = 'Opslaanâ€¦';
      await new Promise(r => setTimeout(r, 400));
      pf.msg.textContent = 'Bewaard âœ…';
    });

    // ================== Mini-website builder ==================
    const $ = id => document.getElementById(id);
    const els = {
      wbTitle:$('wb-title'), wbTag:$('wb-tag'), wbSlug:$('wb-slug'), wbSlugPrev:$('wb-slug-preview'),
      wbTheme:$('wb-theme'), wbAbout:$('wb-about'), wbServices:$('wb-services'),
      wbPhone:$('wb-phone'), wbSite:$('wb-site'), wbPlace:$('wb-place'),
      wbGR:$('wb-gr-on'), wbPublic:$('wb-public'), wbSave:$('wb-save'),
      wbView:$('wb-view'), wbMsg:$('wb-msg'), wbIframe:$('wb-iframe')
    };
    const slugify = s => (s||'').toLowerCase().trim()
      .replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').slice(0,64);
    function updateSlugPreview(){ els.wbSlugPrev.textContent = slugify(els.wbSlug.value) || 'â€”'; }
    function renderPreview(){
      const services = (els.wbServices.value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const showGR = els.wbGR.checked && els.wbPlace.value.trim() !== '';
      const place = els.wbPlace.value.trim();
      const reviewHref = place.startsWith('http') ? place : `https://search.google.com/local/reviews?placeid=${encodeURIComponent(place)}`;
      const site = els.wbSite.value.trim();
      const safeSite = site && !/^https?:\/\//i.test(site) ? 'https://' + site : site;

      const html = `<!doctype html><html lang="nl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${els.wbTitle.value||'Mijn zaak'} â€” Vrijeplek</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body{margin:0;background:linear-gradient(180deg,#e9f2ff,#f6f9ff);font-family:Poppins,Arial,sans-serif;color:#0a2a4a}
.wrap{max-width:900px;margin:32px auto;padding:0 12px}
.card{padding:16px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.8),rgba(255,255,255,.55));border:1px solid rgba(26,102,255,.22);box-shadow:inset 0 1px 0 rgba(255,255,255,.55),0 8px 30px rgba(10,27,90,.08)}
.h{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
.badge{padding:4px 10px;border-radius:999px;background:#fff;border:1px solid rgba(26,102,255,.28);font-weight:700;font-size:12px;color:#0a2a4a}
.btn{display:inline-block;padding:10px 18px;border-radius:999px;background:linear-gradient(120deg,#1a66ff,#0056ff);color:#fff;text-decoration:none;font-weight:700}
ul{margin:8px 0 0 18px}.footer{margin-top:18px;font-size:12px;color:#5b6b86}
</style></head><body>
<div class="wrap"><div class="card">
  <div class="h"><h1 style="margin:0;font-size:22px;">${els.wbTitle.value||'Mijn zaak'}</h1><span class="badge">Vrijeplek</span></div>
  ${els.wbTag.value?`<p style="margin:0 0 8px;color:#1f2a44;">${els.wbTag.value}</p>`:''}
  ${els.wbAbout.value?`<p style="margin:0 0 12px;color:#1f2a44;">${els.wbAbout.value.replace(/</g,'&lt;')}</p>`:''}
  ${services.length?`<h3 style="margin:10px 0 6px;">Diensten</h3><ul>${services.map(s=>`<li>${s.replace(/</g,'&lt;')}</li>`).join('')}</ul>`:''}
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
    ${els.wbPhone.value?`<a class="btn" href="tel:${els.wbPhone.value}">Bel ons</a>`:''}
    ${safeSite?`<a class="btn" href="${safeSite}" target="_blank" rel="noopener">Website</a>`:''}
    ${showGR?`<a class="btn" href="${reviewHref}" target="_blank" rel="noopener">Google reviews</a>`:''}
  </div>
  <div class="footer">Gemaakt met Vrijeplek â€” ${location.origin}/websitevanklant/${slugify(els.wbSlug.value)||'mijn-zaak'}</div>
</div></div></body></html>`;

      const blob = new Blob([html], {type:'text/html'});
      els.wbIframe.src = URL.createObjectURL(blob);
    }
    ["input","change"].forEach(ev=>{
      [els.wbTitle,els.wbTag,els.wbAbout,els.wbServices,els.wbPhone,els.wbSite,els.wbPlace,els.wbGR,els.wbTheme,els.wbPublic].forEach(el=> el.addEventListener(ev,renderPreview));
      els.wbSlug.addEventListener(ev,()=>{ els.wbSlug.value = slugify(els.wbSlug.value); updateSlugPreview(); renderPreview(); });
    });
    updateSlugPreview(); renderPreview();

    els.wbSave.addEventListener("click", async ()=>{
      const slug = slugify(els.wbSlug.value);
      if (!slug) { els.wbMsg.textContent = "Kies een adres (slug)."; return; }
      els.wbMsg.textContent = "Opslaanâ€¦";

      const payload = {
        slug,
        title: els.wbTitle.value.trim(),
        tagline: els.wbTag.value.trim(),
        about: els.wbAbout.value.trim(),
        services: (els.wbServices.value||'').split(',').map(s=>s.trim()).filter(Boolean),
        phone: els.wbPhone.value.trim(),
        website: els.wbSite.value.trim(),
        theme: els.wbTheme.value,
        show_google_reviews: !!els.wbGR.checked,
        google_place: els.wbPlace.value.trim(),
        is_public: !!els.wbPublic.checked
      };

      // Bearer token meesturen zodat function user_id kan bepalen
      const { data: { session: s2 } } = await supa.auth.getSession();
      const access = s2?.access_token || '';

      try{
        const r = await fetch('/.netlify/functions/save_site',{
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            'Authorization': `Bearer ${access}`
          },
          body: JSON.stringify(payload)
        });
        if (r.ok) {
          els.wbMsg.textContent = "Gepubliceerd âœ…";
          els.wbView.href = `/websitevanklant/${slug}`;
        } else {
          els.wbMsg.textContent = (await r.text()) || "Mislukt";
        }
      } catch (e) {
        console.error(e);
        els.wbMsg.textContent = "Netwerkfout";
      }
    });

    // ================== Uitloggen (2 plekken) ==================
    async function doLogout() {
      try { await supa.auth.signOut(); } catch(e) { console.warn(e); }
      window.location.href = '/login.html';
    }
    document.getElementById('btn-logout')  .addEventListener('click', doLogout);
    document.getElementById('btn-logout-2').addEventListener('click', doLogout);
  </script>
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = window.VRIJEPLEK?.SUPABASE_URL || 'https://xdmrikvxyeebeusnbzav.supabase.co';
const SUPABASE_ANON_KEY = window.VRIJEPLEK?.SUPABASE_ANON_KEY || 'PLAATS_HIER_JE_ECHTE_ANON_KEY';

const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, storage: localStorage }
});

// Belangrijk: wacht op INITIAL_SESSION zodat de sessie zeker geladen is
const { data: { session } } = await supa.auth.getSession();
if (!session) {
  await new Promise((resolve) => {
    const { data: sub } = supa.auth.onAuthStateChange((event, sess) => {
      if (event === 'INITIAL_SESSION') { sub.subscription.unsubscribe(); resolve(); }
    });
  });
}
const { data: { session: s2 } } = await supa.auth.getSession();
if (!s2) { window.location.href = '/login.html'; throw new Error('Geen sessie'); }
</body>
</html>
